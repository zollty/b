---
layout: ue
title: 文件系统、POSIX标准及VFS
category: 运维与基础设施
tags: [存储]
keywords: "文件系统,POSIX,VFS"
---

{% raw %}
<p><span style="color: inherit;">一、</span><strong style="color: inherit; font-family: 黑体, SimHei; font-size: 22px;">POSIX标准 以及 POSIX文件接口</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;POSIX（Portable Operating System Interface of UNIX）表示<strong>可移植操作系统接口</strong>，是IEEE为要在各种<strong>UNIX操作系统</strong>上运行软件，而定义API接口的一系列互相关联的标准的总称。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;POSIX标准意在期望获得源代码级别的软件可移植性。换句话说，为一个POSIX兼容的操作系统编写的程序，应该可以在任何其它的POSIX操作系统（即使是来自另一个厂商）上编译执行。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Linux基本上逐步实现了POSIX兼容</strong>，但并没有参加正式的POSIX认证。<strong>微软的Windows NT声称部分实现了POSIX标准</strong>。</p><p>简单总结：</p><p>&nbsp;&nbsp;&nbsp;&nbsp;完成同一功能，不同内核提供的系统调用（也就是一个函数）是不同的，例如创建进程，linux下是fork函数，windows下是creatprocess函数。好，我现在在linux下写一个程序，用到fork函数，那么这个程序该怎么往windows上移植？我需要把源代码里的fork通通改成creatprocess，然后重新编译...</p><p>&nbsp;&nbsp;&nbsp;&nbsp;Posix标准的出现就是为了解决这个问题。linux和windows都要实现基本的posix标准，linux把fork函数封装成posix_fork（随便说的），windows把creatprocess函数也封装成posix_fork，都声明在unistd.h里。这样，程序员编写普通应用时候，只用包含unistd.h，调用posix_fork函数，程序就在源代码级别可移植了。</p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(192, 80, 77);"><span style="text-decoration: underline;">POSIX标准的文件接口有</span>：close、creat、open、read、sync、write、dup、dup2、flock、fcntl、fsync、lseek、mkstemp等。</span></p><p><br/></p><h3>二、文件系统类型</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构；即在存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件结构称为文件管理系统，简称文件系统。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行保护和检索的系统。具体地说，它负责为用户建立文件，存入、读出、修改、转储文件，控制文件的存取，安全控制，日志，压缩，加密等。</p><p>常见的文件系统类型有：</p><p>&nbsp;&nbsp;&nbsp;&nbsp;ext2（Extended file system），ext3，ext4</p><p>&nbsp;&nbsp;&nbsp;&nbsp;xfs，brtfs，zfs，UFS、UFS2、HFS等</p><p>&nbsp;&nbsp;&nbsp;&nbsp;JFS、JFS2（IBM AIX系统使用的文件系统）</p><p>&nbsp;&nbsp;&nbsp;&nbsp;FAT16、FAT32、NTFS</p><p>&nbsp;&nbsp;&nbsp;&nbsp;上面除了ext2不支持journal日志功能，其他都持续日志功能，同时支持日志的方式也有所不同，这些方式分别有自己特性，不过总的区别是文件安全和性能之间的取舍。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;文件系统简单来说，好比一个停车场，但是比停车场更加复杂，更加有序，读写的文件，就是通过文件系统来管理的。分区必须经过格式化后才可以使用，格式化的过程就是在分区内建立文件系统的过程。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;不同文件系统采用不同的方法来管理磁盘空间，根据存储设备的硬件特性、系统需求等有不同的应用场合。</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>ext2具有极快的速度和极小的CPU占用率，可用于硬盘和移动存储设备</p></li><li><p>ext3增加日志功能，可回溯追踪</p></li><li><p>ext4日志式文件系统，支持1EB（1024*1024TB），最大单文件16TB，支持连续写入可减少文件碎片。为rhel6默认文件系统。</p></li><li><p>xfs可以管理500T的硬盘。为rhel7默认文件系统。</p></li><li><p>brtfs文件系统针对固态盘做优化。</p></li><li><p>NTFS：支持最大分区2TB，最大文件2TB，安全性和稳定性非常好，不易出现文件碎片。</p></li><li><p>JFS2(又称 enhanced journaled file system)是最早期的日志文件系统。很早就被应用于 IBM AIX操作系统。<br/></p></li></ul><p>其他文件系统：</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>RAMFS：内存文件系统</p></li><li><p>ISO 9660：光盘</p></li><li><p>NFS：网络文件系统</p></li><li><p>SMBAFS/CIFS：支持Samba协议的网络文件系统</p></li><li><p>Linux swap：交换分区，用以提供虚拟内存。</p></li></ul><p>主要由三类：</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>基于磁盘</p></li><li><p>基于网络</p></li><li><p>虚拟</p></li></ul><p>更多参见：<a href="https://docs.oracle.com/cd/E26926_01/html/E25884/fsoverview-51.html">https://docs.oracle.com/cd/E26926_01/html/E25884/fsoverview-51.html</a></p><p>为了对各类文件系统进行统一管理，Linux引入了虚拟文件系统VFS(Virtual File System)，为各类文件系统提供一个统一的操作界面和应用编程接口。可以肯定的是 <span style="color: rgb(192, 80, 77);">文件系统（FS）之下直接面对的就是硬件存储设备（的物理块层，下面还有驱动层）</span>。<br/></p><p>Linux系统文件架构：</p><p>User层：GLIBC ---&gt; 内核Kernel层：SCI --&gt; VFS --&gt; FS --&gt; Block layer --&gt; Device drivers</p><p>参见：<a href="https://blog.csdn.net/jinking01/article/details/90669534">https://blog.csdn.net/jinking01/article/details/90669534</a></p><p><a href="https://blog.51cto.com/13570227/2082908">https://blog.51cto.com/13570227/2082908</a></p><p><br/></p><h3><strong>三、VFS(virtual File System)</strong></h3><p>VFS的作用就是采用标准的Unix系统调用读写位于不同物理介质上的<strong>不同文件系统</strong>，即为各类<strong>文件系统</strong>提供了一个统一的操作界面和应用编程接口。<span style="color: rgb(192, 80, 77);">VFS是一个可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型</span>就可以工作的粘合层。从VFS的设计原理可知，<span style="color: rgb(192, 80, 77);">VFS之下直接面对的是文件系统（FS），这里的文件系统包括网络文件系统（例如NFS、SMBAFS）</span>。</p><p>疑问：Windows系统有VFS吗？回答：应该是没有的，VFS按定义来看，是Unix系统采用的一种文件系统管理方式。</p><p><br/></p><h3><strong>四、FUFS和POSIX的关系</strong></h3><p>&nbsp;&nbsp;&nbsp;&nbsp;FUSE是（Unix）<span style="color: rgb(192, 80, 77);">用户空间的文件系统接口</span>，<span style="color: rgb(192, 80, 77);">FUSE</span>内核模块<span style="color: rgb(192, 80, 77);">为普通应用程序与内核虚拟文件系统VFS的交互提供了一个桥梁</span>。基于FUSE用户空间模块，开发人员可以不必了解VFS内核机制就能快速便捷地开发POSIX兼容的文件系统交互接口。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;疑问：FUFS支持Windows吗？应该不支持，Windows下没有FUFS，但是Windows上可以找到功能类似于FUFS的实现函数。<br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(192, 80, 77);">即便是没有安装FUSE模块，通过VFS内核也能够操作各种文件系统</span>。<br/></p><p>参见：<a href="https://zhuanlan.zhihu.com/p/86827617" target="_blank" style="background-color: rgb(245, 245, 213); white-space: normal;">深入理解GlusterFS之POSIX接口</a></p><p><br/></p><p><strong>五、问一个问题：</strong><strong>Oracle底层核心存储使用了FUSE和VFS吗？</strong></p><p>回答：</p><p>&nbsp;&nbsp;&nbsp;&nbsp;首先，Oracle可以不使用OS的文件管理系统，这是肯定的（很多资料都有说明）。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;其次，Oracle可以安装在NAS网络存储上，这说明，Oracle可以使用多种文件系统（例如NTFS、JFS2、EXT4、NFS）。<br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;另外，Oracle 11gR2提供了DBFS，可以将Oracle数据库当成文件系统来使用，兼容FUSE接口。这说明Oracle不但能使用多种文件系统，而且还可以把自己伪装成类似于NFS的网络文件系统（支持POSIX标准）。</p><p><br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;所以，据我分析，Oracle应该没有使用FUSE，但是在Linux下应该可以直接用VFS接口，当然也不排除Oracle不通过VFS，直接使用底层的FS，甚至FS都不用（直接用裸设备驱动）。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;————继续研究</p><p>&nbsp;&nbsp;&nbsp;&nbsp;我们知道Linux下在系统（OS）底层，通过LVM（Logical Volume Manager，逻辑卷管理）和LDM，将OS识别到的物理磁盘或虚拟化的逻辑磁盘进行组合，再分配给其他程序使用。而Oracle 10g R2推出了<span style="color: rgb(192, 0, 0);">ASM（自动存储管理），这是Oracle自己提供的卷管理器，主要用于替代操作系统所提供的LVM</span>，它不仅支持单实例，同时对RAC集群的支持也是非常好。参见：<a href="https://blog.csdn.net/nedved_l/article/details/81172575">https://blog.csdn.net/nedved_l/article/details/81172575</a> </p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(192, 0, 0);">ASM它提供了以平台无关的文件系统、逻辑卷管理以及软RAID服务</span><span style="color: rgb(192, 0, 0);">。ASM可以支持条带化和磁盘镜像，从而实现了在数据库被加载的情况下添加或移除磁盘以及自动平衡I/O以删除“热点”</span>。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;安装Oracle的时候，文件存储方式时有几种选择：</p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="color: rgb(192, 0, 0);">操作系统文件系统，操作系统提供的，如AIX的JFS2，WINDOWS的NTFS等等；</span></p></li><li><p><span style="color: rgb(192, 0, 0);">UNIX平台，可以直接使用裸（RAW）设备，比起使用操作系统的文件系统，有利有弊；</span></p></li><li><p><span style="color: rgb(192, 0, 0);">集群文件系统</span></p></li><li><p><span style="color: rgb(192, 0, 0);">自动存储管理 (ASM)</span><br/></p></li></ol><p>&nbsp;&nbsp;&nbsp;&nbsp;具体参见这篇文章：<a href="http://blog.itpub.net/29785807/viewspace-1770469/" target="_blank">Oracle 存储类型</a> </p><p>&nbsp;&nbsp;&nbsp;&nbsp;综上，答案显而易见了，Oracle可以用VFS，也可以不用VFS，<span style="color: rgb(192, 0, 0);">感叹Oracle真是复杂、技术含量很高，人家买这么贵也是有底气的，包括网络设备F5也是一样，人家有软硬件结合的核心技术</span>。<br/></p><p><br/></p>
{% endraw %}

---
layout: ue
title: Maven Profile无法根据项目配置“自动激活”及复杂项目配置管理的探讨
category: Maven专题
tags: [Maven]
keywords: "Maven,Profile,配置自动激活"
---

{% raw %}
<p><span style="color: rgb(192, 0, 0);">想让某个profile<strong>“根据项目的配置自动激活”</strong>，无奈试过各种方法、策略，都不行。</span></p><p>下面是一个profile的标准配置：<br/></p><pre class="brush:xml;toolbar:false">&lt;profiles&gt;
&lt;profile&gt;
  &lt;id&gt;exe-jar&lt;/id&gt;
  &lt;activation&gt;
    &lt;property&gt;
      &lt;name&gt;JAR-BOOT&lt;/name&gt;
    &lt;/property&gt;
    &lt;file&gt;
      &lt;exists&gt;${basedir}/src/main/resources/META-INF/jar.app&lt;/exists&gt;
      &lt;exists&gt;profiles.xml&lt;/exists&gt;
    &lt;/file&gt;
  &lt;/activation&gt;</pre><p><br/></p><p>首先，根据官方文档：</p><p><a href="https://maven.apache.org/settings.html#Profiles">https://maven.apache.org/settings.html#Profiles</a></p><p>摘录如下：</p><p style="color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; white-space: normal; background-color: rgb(255, 255, 255);">Activation occurs when all specified criteria have been met, though not all are required at once.</p><ul style="list-style-type: square;" class=" list-paddingleft-2"><li><p><strong>jdk</strong>:&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">activation</code>&nbsp;has a built in, Java-centric check in the&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">jdk</code>&nbsp;element. This will activate if the test is run under a jdk version number that matches the prefix given. In the above example,&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">1.5.0_06</code>&nbsp;will match. Ranges are also supported. See the&nbsp;<a class="externalLink" href="https://maven.apache.org/enforcer/enforcer-rules/versionRanges.html" style="color: rgb(0, 136, 204); padding-right: 0px; background-image: none; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;">maven-enforcer-plugin</a>&nbsp;for more details about supported ranges.</p></li><li><p><strong>os</strong>: The&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">os</code>&nbsp;element can define some operating system specific properties shown above. See the&nbsp;<a class="externalLink" href="https://maven.apache.org/plugins/maven-enforcer-plugin/rules/requireOS.html" style="color: rgb(0, 136, 204); padding-right: 0px; background-image: none; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;">maven-enforcer-plugin</a>&nbsp;for more details about OS values.</p></li><li><p><strong>property</strong>: The&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">profile</code>&nbsp;will activate if Maven detects a property (a value which can be dereferenced within the POM by&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">${name}</code>) of the corresponding&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">name=value</code>&nbsp;pair.</p></li><li><p><strong>file</strong>: Finally, a given filename may activate the&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">profile</code>&nbsp;by the&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">existence</code>&nbsp;of a file, or if it is&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">missing</code>.</p></li></ul><p style="color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; white-space: normal; background-color: rgb(255, 255, 255);">The&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">activation</code>&nbsp;element is not the only way that a&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">profile</code>&nbsp;may be activated. The&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">settings.xml</code>&nbsp;file’s&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">activeProfile</code>&nbsp;element may contain the profile’s&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">id</code>. They may also be activated explicitly through the command line via a comma separated list after the&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">-P</code>&nbsp;flag (e.g.&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">-P test</code>).</p><p style="color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; white-space: normal; background-color: rgb(255, 255, 255);"><i>To see which profile will activate in a certain build, use the</i>&nbsp;<code style="font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(221, 17, 68); border-radius: 3px; white-space: nowrap; background-color: rgb(247, 247, 249); border: 1px solid rgb(225, 225, 232);">maven-help-plugin</code>.</p><div class="source" style="color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 14px; white-space: normal; background-color: rgb(255, 255, 255);"><div class="source"><pre class="prettyprint linenums" style="padding: 2px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; border-radius: 4px; margin-bottom: 20px; line-height: 20px; white-space: pre-wrap; border-color: rgb(136, 136, 136);"><ol class="linenums list-paddingleft-2" style="padding: 0px 0px 0px 15px; margin-left: 25px;"><li><p><span class="pln" style="color: rgb(0, 0, 0);">mvn help</span><span class="pun" style="color: rgb(102, 102, 0);">:</span><span class="pln" style="color: rgb(0, 0, 0);">active</span><span class="pun" style="color: rgb(102, 102, 0);">-</span><span class="pln" style="color: rgb(0, 0, 0);">profiles</span></p></li></ol></pre></div></div><p><br/></p><p><strong>profile的自动激活方式有4种</strong>。因为我是想根据项目配置来自动激活，上面这几种方式均不能达到效果。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(192, 0, 0);">根据jdk、os激活，不是我想要的，pass。</span></p><p><span style="color: rgb(192, 0, 0);">&nbsp;&nbsp;&nbsp;&nbsp;根据property激活，这个有点坑，只能是系统变量才行。</span>mavan pom.xml里面定义的properties无法识别。</p><p><strong>所以，这四种方式都很鸡肋，都无法做到根据项目来自动激活。</strong></p><p>我找到了作者说的一句话：</p><p>Profile activgation is the first step of the first phase</p><p>and profile activation does not work with POM property but with CLI property</p><p>&nbsp;&nbsp;&nbsp;&nbsp;因为系统变量，需要在打包命令，或者环境变量中设置。所以这种方法对我来说不可取（<span style="color: rgb(192, 0, 0);">因为我想根据项目自身配置自动激活，不需要人为配置</span>）。<br/></p><p>&nbsp;&nbsp;&nbsp;&nbsp;最后抱了一丝希望：根据file激活，这个也很坑。参见这个issues：</p><p><a href="https://issues.apache.org/jira/browse/MNG-2363">https://issues.apache.org/jira/browse/MNG-2363</a>（我的需求跟这个描述一模一样！！）</p><p>&nbsp;&nbsp;&nbsp;&nbsp;这个file的路径，如果是相对路径，且是在父pom.xml中设置的profiles，则file路径是针对于父pom.xml项目构建路径的绝对值。<span style="text-decoration: underline;">例如&nbsp;profiles.xml 或 ${basedir}/profiles.xml，都是指向的父pom.xml构建时的路径</span>，例如：D:\__SYNC2\git\jretty-pom\profiles.xml，亲测如此。<span style="text-decoration: underline;">这样子项目中的profiles.xml文件就不会起作用。垃圾垃圾！</span>怎么会这样？这应该是bug吧！总之，file激活太不靠谱。</p><p><br/></p><p>引申结论</p><p>&nbsp;&nbsp;&nbsp;&nbsp;由于这个问题，又对Maven进行了各方面的研究，对Maven的理解也加深了。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>总结出一点：Maven不太适合多模块的复杂项目（可能大多数人的项目都不会复杂到我说的那种程度，后面有举例）。</strong>具体说起来很复杂，我简单提几点（不做详细阐述）<br/></p><p><span style="color: rgb(192, 0, 0);">1、新版Maven提供了 &lt;scope&gt;import&lt;/scope&gt;，但是仅能引入 dependency组件。至于其他标签都无法继承，例如build标签里面的那些，以及properties标签。这个缺点对结构复杂、继承模块非常多的项目来说很严重，就拿build标签里面的东西来说，多继承也是相当有必要的。</span></p><p><span style="color: rgb(192, 0, 0);">2、尝试用profile来解决pom.xml的多继承问题，倒是可以包含build、properties等标签，但是由于上文所述的问题，这种profile切换的功能十分鸡肋（不能根据项目的变量动态切换），它只能通过jdk、cli参数、系统变量来切换</span>————对于多模块项目来说，并不是每个模块的build、properties配置都是一样的，有些是jar、有些是war，而通过cli参数、系统变量，只能针对单个项目去控制变量才能实现，<span style="color: rgb(192, 0, 0);">对于多模块项目，没办法单独为每个模块指定cli参数（mvn -P参数对多模块的所有子模块生效，无法单独指定某个子模块生效</span>，除非逐个项目执行构建，所以我说Maven适合单项目，不适合多模块项目的构建，另外当初Ant流行就是因为Ant对项目的构建更灵活，弥补了Maven的缺陷）。实际案例有很多（例如上文提到的<a href="https://issues.apache.org/jira/browse/MNG-2363">https://issues.apache.org/jira/browse/MNG-2363</a>案例）。所以，放弃profile。</p><p>3、<span style="color: rgb(192, 0, 0);">既然profile无法解决pom.xml继承的问题，那么只能退而求其次，使用module-parent的项目结构，使用parent-children来实现一定程度的继承。</span></p><p>举个例子，我的项目比较复杂，改造前如下（简化结构）：</p><pre class="brush:plain;toolbar:false">talos-parent
    talos-api
    talos-common
    talos-app1
    talos-app2
 
 himes-parent
    himes-api
    himes-common
    himes-app1
    himes-app2</pre><p>由于talos-app1、talos-app2、himes-app1……等几十个项目的pom.xml几乎是一模一样的，于是想通过继承的方式将pom.xml集中管理起来。改造后如下：</p><pre class="brush:plain;toolbar:false">talos-parent
    talos-api
    talos-common
    talos-app-parent
        talos-app1
        talos-app2</pre><p><span style="color: rgb(192, 0, 0);">这样一来，talos-app1和talos-app2的配置就可以继承 talos-app-parent，从而自身简化到只有一个引用声明</span>：</p><pre class="brush:xml;toolbar:false">&lt;project&gt;

  &lt;artifactId&gt;talos-app1&lt;/artifactId&gt;
  
  &lt;parent&gt;
    &lt;groupId&gt;com.fbank&lt;/groupId&gt;
    &lt;artifactId&gt;talos-app-parent&lt;/artifactId&gt;
    &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
  &lt;/parent&gt;
  
&lt;/project&gt;</pre><p>但是，很显然，<span style="text-decoration: underline;">talos-app-parent的作用范围仅限于 其子module，对于himes-app1、himes-app2等其他项目无能为力</span>。<br/></p><p>然而这并不是我期望的，talos-app和himes-app仅仅是项目不同，pom.xml其实大同小异，不能继承、非常遗憾！！（<span style="color: rgb(192, 0, 0);">Maven的对手Gradle可以做到，它可以将片段传到远程仓库，供其他项目可以include引入</span>）</p><p><br/></p><p>3、Maven有几个命令可以控制 module子项目的打包，但是不支持子项目嵌套。例如上面的双parent项目结构，mvn install可以一键打包所以模块。但是mvn&nbsp; -pl -am这些命令参数，只能对一级模块起作用，无法控制内层的二级、三级子模块项目，而复杂的项目有二级、三级子模块很正常。</p><p><br/></p><p>4、<span style="color: rgb(192, 0, 0);"><strong>像Spring这样复杂的项目群，没有采用Maven来管理，看来是明智的</strong></span>。</p><p><br/></p><p>5、我曾经研究<strong><span style="color: rgb(192, 0, 0);">对比过Maven和Gradle，只能说Gradle更强大、更灵活，但是也更复杂和不可控，是一把双刃剑</span></strong>。</p><p><br/></p><p><strong>结论：</strong></p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p>如果是小团队独立项目，能忍受多个项目的Maven pom.xml内有上百行的重复，那用maven没问题。<br/></p></li><li><p>如果是大范围的很多项目、涉及几十上百开发人员，且需要统一管理，那么用Gradle是最方便的，但是由于很多团队不会用Gradle，要推广实施并不容易。</p></li></ol><p><br/></p>
{% endraw %}

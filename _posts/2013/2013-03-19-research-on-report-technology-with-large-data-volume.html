---
layout: ue
title: 大数据量报表技术研究
category: 系统架构和设计
tags: 大数据,报表
keywords: "大数据,报表"
---

<p style="text-align: center;">&nbsp;<span style="text-align: center;">&nbsp;</span><span style="text-align: center; font-size: 24px;"><strong>大数据量报表技术研究</strong></span></p><p><br/></p><p style="text-align:center;line-height:24px"><span style="font-size:21px;font-family:黑体;color:black">目</span><span style="font-size:21px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:21px;font-family:黑体;color:black">录</span></p><p style="text-align:center;line-height:23px"><span style="font-size:12px;color:black">&nbsp;</span></p><p>1 基本简介和说明................................................................................... 1</p><p>1.1&nbsp; 研究意义.......................................................................................... 1</p><p>1.2&nbsp; 研究范围.......................................................................................... 1</p><p>1.3&nbsp; 摘要和概述...................................................................................... 1</p><p>2 实用技术点........................................................................................... 2</p><p>2.1&nbsp; 理论基础-文件IO流和编码........................................................... 2</p><p>2.2&nbsp; 理论基础-基于互联网的数据传输................................................. 6</p><p>2.3&nbsp; 大数据量报表文件的生成.............................................................. 8</p><p>2.4&nbsp; 离线生成报表的机制.................................................................... 15</p><p>2.5&nbsp; 并发操作的控制............................................................................ 19</p><p>2.6&nbsp; 多线程生成报表的技术................................................................ 22</p><p>2.7&nbsp; 多服务器生成报表的技术............................................................ 24</p><p>2.8&nbsp; 实时下载技术................................................................................ 29</p><p>3 解决方案分类..................................................................................... 36</p><p>3.1&nbsp; 考虑数据量大小............................................................................ 36</p><p>3.2&nbsp; 考虑表现方式................................................................................ 39</p><p>3.3&nbsp; 工具插件的选择............................................................................ 43</p><p>3.4&nbsp; 数据库层........................................................................................ 46</p><p>3.5&nbsp; 服务器层........................................................................................ 48</p><p>参考资料................................................................................................. 51</p><p>附&nbsp; 录..................................................................................................... 52</p><p style="line-height:23px"><br/></p><p><span style="font-size:14px;font-family: &#39;Times New Roman&#39;,serif;color:black"><br/> </span></p><h1 style="line-height:24px"><a><span style="color:black;font-weight:normal">1 </span></a><span style="font-family:黑体;color:black;font-weight:normal">基本简介和说明</span></h1><p style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">1.1 </span></a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">&nbsp;</span><span style="font-family:黑体;color:black">研究意义</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">首在各大、中、小型项目中，数据的统计和下载被广泛的使用，几乎成了各个项目的必备功能。在很多系统中，数据除了在页面展示，还需要下载出来，用于统计、处理、备份，甚至再导入第三方系统中，涉及到的数据下载和统计报表就非常多。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">对于报表的处理和展现，涌现除了众多的技术，同时也出现了很多难题：性能问题、功能问题、安全问题、开发成本问题，等等。在和客户交流的过程中，发现他们普遍对下载、报表统计不够满意，反映到报表内容不够灵活，格式不符合要求，下载速度慢，数据加工麻烦等等问题。同时在性能、功能、安全等上面，开发人员也面临着挑战。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">本课题旨在对报表和大数据下载提供系统的解决方案，解决普遍性和关键性的问题，提高项目组中报表和下载模块的质量和开发效率。</span></p><p style="text-indent:32px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">1.2 </span></a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">&nbsp;</span><span style="font-family:黑体;color:black">研究范围</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;font-family:宋体">若非特别说明，本文的描述和结论都是基于一般</span><span style="font-size:16px">Java Web</span><span style="font-size:16px;font-family:宋体">应用的。非</span><span style="font-size:16px">Java</span><span style="font-size:16px;font-family:宋体">语言或者非</span><span style="font-size:16px">Web</span><span style="font-size:16px;font-family: 宋体">应用领域，一般不属于本文的讨论范畴。</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">1.3&nbsp; </span></a><span style="font-family:黑体;color:black">摘要和概述</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;font-family:宋体">要想解决数据下载和报表统计的问题，首先要以数据为切入点。数据有多少？涉及到数据的存储。数据如何存储？涉及到数据的结构和形态，重点在于数据库。数据如何加工和处理？涉及到应用程序和服务器。于是，本文从数据库、服务器、应用程序三个方面来分析和解决问题。</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;font-family:宋体">关于数据库，侧重研究数据的存储：对于大数据量，可以按日期、按类型分表；对于多表数据，可定期导入一张表中；对数据建立合理的索引，等等。</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;font-family:宋体">关于服务器，有需求和条件的情况下，可以进行多服务器部署，对于一服务器对应一数据源，多服务器对应单数据源部署技术进行研究。</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;font-family:宋体">应用程序方面，涉及的内容最多，也是本文研究的重点。通常来说，开发人员想要开发报表和数据下载功能时，要考虑数据量的大小、数据的表现方式、工具插件的选择、开发效率等问题，本文就是按这些点来分类，以便给开发人员提供清晰、系统的解决方案。</span></p><p style="text-align:left;text-indent:32px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p><a></a><a></a><a></a><a><span style="color:black;font-weight:normal">2 </span></a><span style="font-family:黑体;color:black;font-weight:normal">实用技术点</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.1&nbsp; </span></a><span style="font-family:黑体;color:black">理论基础</span><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">-</span><span style="font-family:黑体;color:black">文件</span><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">IO</span><span style="font-family:黑体;color:black">流和编码</span></p><p style="line-height:27px"><font face="宋体"><span style="font-size: 16px;">参见<a href="http://blog.zollty.com/b/archive/file-io-stream-and-character-encoding.html" target="_blank">《Java文件IO流和字符编码》</a>一节。</span></font></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.2&nbsp; </span></a><span style="font-family:黑体;color:black">理论基础</span><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">-</span><span style="font-family:黑体;color:black">基于互联网的数据传输</span></p><p style="line-height:27px"><font face="宋体"><span style="font-size: 16px;">参见<a href="http://blog.zollty.com/b/archive/the-file-data-transmission-based-on-internet.html" target="_blank">《基于互联网络的文件数据传输》</a>一节。</span></font></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.3&nbsp; </span></a><span style="font-family:黑体;color:black">大数据量报表文件的生成</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">一、问题的提出</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">报表文件的生成，性能的瓶颈在哪里？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">二、问题的研究</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">“报表文件的生成”，其主体是“数据”和“文件”，于是我们可以从“数据的读取”和“文件的写入”这两个基础进行考虑。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">当然，如果考虑得更具体的话，可能还会涉及到“数据的加工”和“程序的逻辑”，但是这两方面的复杂度是因需求的不同而异的，是未知的。因此，我们需要撇开这些差异因素，针对单纯的“数据库读取”和“文件</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">”做一些测试。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">在数据量上，选取如下几个维度，来测试文件</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">和数据库读取的性能，供参考。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">数据条数：比如</span><span style="font-size:16px;color:black">1000</span><span style="font-size:16px;font-family:宋体;color:black">条、</span><span style="font-size:16px;color:black">1w</span><span style="font-size:16px;font-family:宋体;color:black">条、</span><span style="font-size:16px;color:black">10w</span><span style="font-size:16px;font-family:宋体;color:black">条</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">数据字节数：比如</span><span style="font-size:16px;color:black">100kb</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">10mb</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">100mb</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">、文件</span><span style="font-size: 16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">写操作</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）测试环境：</span><span style="font-size: 16px;color:black">JDK1.6</span><span style="font-size:16px;font-family: 宋体;color:black">，笔记本电脑</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）测试描述：</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">采用前面所讲到的最佳方式——</span><span style="font-size:16px;color:black">BufferedWriter</span><span style="font-size:16px;font-family:宋体;color:black">的方式往文本文件里面写字符串</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">数据字节数一定的情况（</span><span style="font-size:16px;color:black">3000</span><span style="font-size:16px;font-family:宋体;color:black">万字节≈</span><span style="font-size:16px;color:black">28.6MB</span><span style="font-size:16px;font-family:宋体;color:black">），每次写</span><span style="font-size:16px;color:black">N</span><span style="font-size: 16px;font-family:宋体;color:black">字节</span><span style="font-size:16px;color:black">+</span><span style="font-size:16px;font-family:宋体;color:black">循环</span><span style="font-size:16px;color:black">M</span><span style="font-size: 16px;font-family:宋体;color:black">次，或者每次写</span><span style="font-size: 16px;color:black">X</span><span style="font-size:16px;font-family:宋体;color:black">字节</span><span style="font-size:16px;color:black">+</span><span style="font-size:16px;font-family:宋体;color:black">循环</span><span style="font-size:16px;color:black">Y</span><span style="font-size:16px;font-family:宋体;color:black">次（其中</span><span style="font-size: 16px;color:black">N*M=X*Y=3000</span><span style="font-size:16px;font-family:宋体;color:black">万）。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">取测试</span><span style="font-size:16px;color:black">100</span><span style="font-size:16px;font-family:宋体;color:black">次的平均值</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">）测试结果，如下图所示：</span></p><p style="text-align:center;text-indent:28px;line-height:27px"><span style=";font-family:黑体">表</span>2.2 <span style=";font-family:黑体">文件</span>IO<span style=";font-family:黑体">写操作测试结果</span></p><table><tbody><tr class="firstRow"><td width="158" valign="top" style="border: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">写循环的次数（万次）</span></p></td><td width="170" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">每次写的字节数（</span>byte<span style="font-family:宋体">）</span></p></td><td width="170" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">编码</span></p></td><td width="121" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">耗时（毫秒</span>ms<span style="font-family:宋体">）</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">25</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">120</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">默认</span></p></td><td width="121" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">133.81</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">200</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">15</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">默认</span></p></td><td width="121" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">167.22</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">25</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">120</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-size:10px;font-family:宋体">调用</span><span style="font-size:10px">OutputStreamWriter</span><span style="font-size:10px;font-family:宋体">转</span><span style="font-size:10px">GBK</span></p></td><td width="121" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">212.02</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">200</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">15</p></td><td width="170" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-size:10px;font-family:宋体">调用</span><span style="font-size:10px">OutputStreamWriter</span><span style="font-size:10px;font-family:宋体">转</span><span style="font-size:10px">GBK</span></p></td><td width="121" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">250.80</span></p></td></tr></tbody></table><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size: 16px;font-family:宋体;color:black">）测试结果分析：</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">总体感觉，执行速度是非常快的，上百万次写入也就一眨眼的功夫。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">减少写的次数、适当增加每次写的字节数可以略微提高效率，但几乎可以忽略不计。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">字符编码的转换速度也很快，不会对整体效率造成质的影响。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">、数据库查询、数据读取</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）测试环境：</span><span style="font-size: 16px;color:black">Oracle10g</span><span style="font-size:16px;font-family: 宋体;color:black">数据库（局域网内远程连接）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）测试描述：</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">采用标准</span><span style="font-size:16px;color:black">JDBC</span><span style="font-size:16px;font-family:宋体;color:black">方式连接和查询</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">简单</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">：有两个查询条件，均为字符串类型，都带有索引；查询字段大约</span><span style="font-size:16px;color:black">60</span><span style="font-size:16px;font-family:宋体;color:black">个，一条数据内容大小约</span><span style="font-size:16px;color:black">0.34kb.</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">）测试结果，如下图所示：</span></p><p style="text-align:center;text-indent:28px;line-height:27px"><span style=";font-family:黑体">表</span>2.3 <span style=";font-family:黑体">数据查询测试结果</span></p><table><tbody><tr class="firstRow"><td width="206" valign="top" style="border: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">数据量（条）</span></p></td><td width="206" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">测试次数（次）</span></p></td><td width="206" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">平均耗时（毫秒</span>ms / <span style="font-family:宋体">次）</span></p></td></tr><tr><td width="206" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">1 4006</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">10</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">82552</span><span style="font-family:宋体;color:#4F81BD">（约</span><span style="color:#4F81BD">1.38</span><span style="font-family:宋体;color:#4F81BD">分钟）</span></p></td></tr><tr><td width="206" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">5 2522</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">3</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">299060</span><span style="font-family:宋体;color:#4F81BD">（约</span><span style="color:#4F81BD">4.98</span><span style="font-family:宋体;color:#4F81BD">分钟）</span></p></td></tr><tr><td width="206" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">10 1542</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">1</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">519961</span><span style="font-family:宋体;color:#4F81BD">（约</span><span style="color:#4F81BD">8.67</span><span style="font-family:宋体;color:#4F81BD">分钟）</span></p></td></tr></tbody></table><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size: 16px;font-family:宋体;color:black">）测试结果分析</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">总体感觉，相比文件</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">写的速度数据库查询要慢得多，查询</span><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">万条数据时，就需要</span><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">分多钟了</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">查询耗时与数据量大体上成正比关系。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">、总结</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">在正常的报表生成的过程中，“数据库查询、数据读取”比“文件</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">写操作”的耗时要多得多，是性能的瓶颈所在。注意到，上面的测试还只是用的简单</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">去查询，如果是复杂的</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">，那么耗在“数据库查询”上的时间将会更多。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">无疑，“数据库查询，数据读取”这一块儿，是通常报表生成过程中最耗时的一块儿。如果能减少“数据的读取时间”，将能明显提高生成表报的速率。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">另外，以上的分析和测试，只对比了“文件</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">”和“数据读取”这一块儿，需要补充一点的是，在报表下载中，还应考虑到“网络数据的传送速度”，这方面可能取决于网速。根据我在内网上做的测试，这方面速度是很快的，从这个角度来说，不会是性能的瓶颈所在。但是不知道在外网环境、网速不佳的情况下会不会拖后腿？而且通常，网络流量有限制，比如最大</span><span style="font-size:16px;color:black">300kb/s</span><span style="font-size:16px;font-family:宋体;color:black">，那么传输</span><span style="font-size:16px;color:black">100M</span><span style="font-size:16px;font-family:宋体;color:black">的文件就需要</span><span style="font-size:16px;color:black">341</span><span style="font-size:16px;font-family:宋体;color:black">秒！</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">网络方面其实也容易出问题，例如，如果用户一次请求，程序执行“查询——生成报表——下载报表文件”整个过程，那么实际上这一个</span><span style="font-size:16px;color:black">http</span><span style="font-size:16px;font-family:宋体;color:black">线程可能会连接很长时间，如上面测试的那样，查询</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">万条数据就用了</span><span style="font-size:16px;color:black">8.67</span><span style="font-size:16px;font-family:宋体;color:black">分钟，那么</span><span style="font-size:16px;color:black">http</span><span style="font-size:16px;font-family:宋体;color:black">线程要一直连接至少</span><span style="font-size:16px;color:black">8.67</span><span style="font-size:16px;font-family:宋体;color:black">分钟，这是很慢的，而且</span><span style="font-size:16px;color:black">http</span><span style="font-size:16px;font-family:宋体;color:black">线程可能有超时设置，到了最大时间可能会自动断开。所以说，在涉及大数据量报表时，最好将“查询、生成报表”和“下载报表”的过程分开。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">三、参考方案或建议</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">从宏观上看，要提高报表文件的生成效率，可以从以下几个方面着手：</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">优化查询语句</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">优化数据存储结构</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">优化程序算法</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">采用合理的报表文件格式</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">采用较好的生成报表的工具</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">下面一一来说明：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">、优化查询语句</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">从最实际有效的方式上讲，一次查询数据量不宜太多。如果条件允许，应尽量从设计上避免一次查询太多数据，例如采用分页查询、采用分批查询等，当然这个也得看具体的业务需求。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">另外一点：优化好查询的</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">，比如索引等，性能也会得到巨大的提升，这方面可以参考“数据库优化”相关的资料，本文不做深入地介绍。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">举个例子，看下面这个</span><span style="font-size:16px;color:black">sql</span><span style="font-size:16px;font-family:宋体;color:black">，这是我遇到的实际问题：</span></p><p style="margin-top:3px;margin-right:0;margin-bottom:3px;margin-left:0;background:#F7F9FA;text-autospace:ideograph-other;border:none;padding:0;padding:7px 7px 7px 7px"><span style="font-family:&#39;Verdana&#39;,sans-serif;color:#B1B100;background: #F7F9FA">select</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:black;background:#F7F9FA"> count(*) </span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:#B1B100;background:#F7F9FA">from</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:black;background:#F7F9FA"> REPORT_TASK t </span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:#B1B100;background:#F7F9FA">where</span></p><p style="margin-top:3px;margin-right:0;margin-bottom:3px;margin-left:0;background:#F7F9FA;text-autospace:ideograph-other;border:none;padding:0;padding:7px 7px 7px 7px"><span style="font-family:&#39;Verdana&#39;,sans-serif;color:black;background:#F7F9FA">&nbsp;t.create_time&gt;=</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:#B1B100;background:#F7F9FA">to_date</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:black;background:#F7F9FA">(&#39;2013-05-01&#39;, &#39;yyyy-mm-dd&#39;) </span></p><p style="margin-top:3px;margin-right:0;margin-bottom:3px;margin-left:0;background:#F7F9FA;text-autospace:ideograph-other;border:none;padding:0;padding:7px 7px 7px 7px"><span style="font-family:&#39;Verdana&#39;,sans-serif;color:#B1B100;background: #F7F9FA">&nbsp;and</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:black;background:#F7F9FA"> t.create_time&lt;</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:#B1B100;background:#F7F9FA">to_date</span><span style="font-family:&#39;Verdana&#39;,sans-serif;color:black;background:#F7F9FA">(&#39;2013-05-05&#39;, &#39;yyyy-mm-dd&#39;)</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">最开始，查询速度非常非常慢。后来我在</span><span style="font-size:16px;color:black">create_time</span><span style="font-size: 16px;font-family:宋体;color:black">字段上加了索引，就快多了。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">总之，</span><span style="font-size: 16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">是重点，“在开发报表的过程中，我们应该先把</span><span style="font-size: 16px;color:black">sql</span><span style="font-size:16px;font-family:宋体;color:black">单独拿出来，调试好了之后才做进一步的开发，如果</span><span style="font-size: 16px;color:black">sql</span><span style="font-size:16px;font-family:宋体;color:black">有变动，也要及时的做好测试”。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">、优化数据存储结构</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">在</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">优化的基础上，进一步可以考虑数据的存储结构、数据表的优化。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">举一个实际的例子：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">某个报表中需要有营业部</span><span style="font-size:16px;color:black">ID</span><span style="font-size:16px;font-family:宋体;color:black">、营业部名称，但是原数据表中只有营业部</span><span style="font-size:16px;color:black">ID</span><span style="font-size:16px;font-family:宋体;color:black">这个字段，没有营业部名称。原来的做法是根据营业部</span><span style="font-size:16px;color:black">ID</span><span style="font-size:16px;font-family:宋体;color:black">再到“营业部表”里面去查询营业部名称。这种方式就涉及到联表查询，效率很低。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">如果在原数据表中增加“营业部名称”这个字段，并且在导入数据的时候就顺便导入这个字段的值，那么查询的时候就无需再从营业部表中去查，大大提高了效率。</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">另外，还可以考虑建立一张中间表，把数据统一起来便于查询。通常，把那些查询得很频繁的数据，集中起来。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">、优化程序算法</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">举一个实际的例子：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">项目中多用的是</span><span style="font-size:16px;color:black">SqlRowSet</span><span style="font-size:16px;font-family:宋体;color:black">，和其他很多类似的“</span><span style="font-size:16px;color:black">RowSet</span><span style="font-size:16px;font-family:宋体;color:black">”一样，它是把数据存入内存中，然后再用</span><span style="font-size:16px;color:black">rs.next()</span><span style="font-size:16px;font-family:宋体;color:black">去取数据。在开发和测试时，没发现任何问题，甚至在系统上线后一段时间内都没发现问题。但是后来发现生产服务器性能下降了。仔细检查才发现，原来是</span><span style="font-size:16px;color:black">RowSet</span><span style="font-size:16px;font-family:宋体;color:black">吃了大量的内存，要知道</span><span style="font-size:16px;color:black">JVM</span><span style="font-size:16px;font-family:宋体;color:black">占用的内存是有限的，超过了最大限度，则会发生</span><span style="font-size:16px;color:black">gc</span><span style="font-size:16px;font-family:宋体;color:black">，必然会大大的影响性能。但是，这个问题只有在数据量比较大时才会表现出来。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">我们经常的做法是把数据存入内存中，然后再执行其他操作，这样做可以增加处理速度、减少数据库连接时间。但是数据量过大时，这种做法不可取。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">可以通过</span><span style="font-size:16px;color:black">Java JDBC</span><span style="font-size:16px;font-family:宋体;color:black">自带的</span><span style="font-size:16px;color:black">ResultSet</span><span style="font-size:16px;font-family:宋体;color:black">去取数据，并设置合理的</span><span style="font-size:16px;color:black">fetchSize</span><span style="font-size:16px;font-family:宋体;color:black">，且</span><span style="font-size:16px;color:black">ResultSetType</span><span style="font-size:16px;font-family:宋体;color:black">要设置成</span><span style="font-size:16px;color:black">Result.TYPE_FORWARD_ONLY</span><span style="font-size:16px;font-family:宋体;color:black">类型（这也是默认的类型），这样就确保了</span><span style="font-size:16px;color:black">ResultSet</span><span style="font-size:16px;font-family:宋体;color:black">不会把数据都</span><span style="font-size:16px;color:black">load</span><span style="font-size:16px;font-family:宋体;color:black">到内存中。关于</span><span style="font-size:16px;color:black">ResultSet</span><span style="font-size:16px;font-family:宋体;color:black">的类型，有如下说明：</span></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">1 </span></i><i><span style=";font-family:黑体;color:black">：ResultSet.TYPE_FORWARD_ONLY </span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;&nbsp;&nbsp; </span></i><i><span style=";font-family:黑体;color:black">默认的cursor 类型，仅仅支持结果集forward ，不支持backforward ，random ，last ，first 等操作。&nbsp; </span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">2 </span></i><i><span style=";font-family:黑体;color:black">：ResultSet.TYPE_SCROLL_INSENSITIVE </span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;&nbsp;&nbsp; </span></i><i><span style=";font-family:黑体;color:black">支持结果集backforward ，random ，last ，first 等操作，对其它session 对数据库中数据做出的更改是不敏感的。 </span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;&nbsp;&nbsp; </span></i><i><span style=";font-family:黑体;color:black">实现方法：从数据库取出数据后，会把全部数据缓存到cache 中，对结果集的后续操作，是操作的cache 中的数据，数据库中记录发生变化后，不影响cache 中的数据，所以ResultSet 对结果集中的数据是INSENSITIVE 的。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">3 </span></i><i><span style=";font-family:黑体;color:black">：ResultSet.TYPE_SCROLL_SENSITIVE </span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;&nbsp;&nbsp; </span></i><i><span style=";font-family:黑体;color:black">支持结果集backforward ，random ，last ，first 等操作，对其它session 对数据库中数据做出的更改是敏感的，即其他session 修改了数据库中的数据，会反应到本结果集中。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;&nbsp;&nbsp; </span></i><i><span style=";font-family:黑体;color:black">实现方法：从数据库取出数据后，不是把全部数据缓存到cache 中，而是把每条数据的rowid 缓存到cache 中，对结果集后续操作时，是根据rowid 再去数据库中取数据。所以数据库中记录发生变化后，通过ResultSet 取出的记录是最新的，即ResultSet 是SENSITIVE 的。 但insert 和delete 操作不会影响到ResultSet ，因为insert 数据的rowid 不在ResultSet 取出的rowid 中，所以insert 的数据对ResultSet 是不可见的，而delete 数据的rowid 依旧在ResultSet 中，所以ResultSet 仍可以取出被删除的记录（ 因为一般数据库的删除是标记删除，不是真正在数据库文件中删除 ）。</span></i></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">另外，注意</span><span style="font-size:16px;color:black">JDBC</span><span style="font-size:16px;font-family:宋体;color:black">设置的一些默认值：（</span><span style="font-size:16px;color:black">Orcale</span><span style="font-size:16px;font-family:宋体;color:black">的驱动）</span></p><table><tbody><tr class="firstRow"><td width="206" valign="top" style="border-width: 1px 1px 4px; border-style: solid; border-color: rgb(204, 232, 207); border-image: initial; background: rgb(75, 172, 198); padding: 0px 7px;"><br/></td><td width="206" valign="top" style="border-top: 1px solid rgb(204, 232, 207); border-left: none; border-bottom: 4px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-family:宋体;color:#CCE8CF">默认值</span></strong></p></td><td width="206" valign="top" style="border-top: 1px solid rgb(204, 232, 207); border-left: none; border-bottom: 4px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-family:宋体;color:#CCE8CF">说明</span></strong></p></td></tr><tr><td width="206" valign="top" style="border-top: none; border-left: 1px solid rgb(204, 232, 207); border-bottom: 1px solid rgb(204, 232, 207); border-right: 4px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-size:16px;color:#CCE8CF">ResultSetType</span></strong></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(165, 213, 226); padding: 0px 7px;"><p style="line-height:29px">TYPE_FORWARD_ONLY</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(165, 213, 226); padding: 0px 7px;"><p style="line-height:29px"><span style="font-family:宋体">只能</span>next<span style="font-family:宋体">读取</span></p></td></tr><tr><td width="206" valign="top" style="border-top: none; border-left: 1px solid rgb(204, 232, 207); border-bottom: 1px solid rgb(204, 232, 207); border-right: 4px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-size:16px;color:#CCE8CF">QueryTimeout</span></strong></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px">0</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px"><span style="font-family:宋体">不限制</span></p></td></tr><tr><td width="206" valign="top" style="border-top: none; border-left: 1px solid rgb(204, 232, 207); border-bottom: 1px solid rgb(204, 232, 207); border-right: 4px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-size:16px;color:#CCE8CF">FetchSize</span></strong></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(165, 213, 226); padding: 0px 7px;"><p style="line-height:29px">10</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(165, 213, 226); padding: 0px 7px;"><p style="line-height:29px"><span style="font-family:宋体">一次性最多读取</span>10<span style="font-family:宋体">行数据</span></p></td></tr><tr><td width="206" valign="top" style="border-top: none; border-left: 1px solid rgb(204, 232, 207); border-bottom: 1px solid rgb(204, 232, 207); border-right: 4px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-size:16px;color:#CCE8CF">FetchDirection</span></strong></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px">FETCH_FORWARD</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px"><span style="font-family:宋体">向前抓取</span></p></td></tr><tr><td width="206" valign="top" style="border-top: none; border-left: 1px solid rgb(204, 232, 207); border-bottom: 1px solid rgb(204, 232, 207); border-right: 4px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-size:16px;color:#CCE8CF">ResultSetConcurrency</span></strong></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px">CONCUR_READ_ONLY</p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px"><span style="font-family:宋体">只读型并发</span></p></td></tr><tr><td width="206" valign="top" style="border-top: none; border-left: 1px solid rgb(204, 232, 207); border-bottom: 1px solid rgb(204, 232, 207); border-right: 4px solid rgb(204, 232, 207); background: rgb(75, 172, 198); padding: 0px 7px;"><p style="line-height:29px"><strong><span style="font-size:16px;color:#CCE8CF">ResultSetHoldability</span></strong></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px"><span style="font-size:12px">HOLD_CURSORS_OVER_COMMIT</span></p></td><td width="206" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid rgb(204, 232, 207); border-right: 1px solid rgb(204, 232, 207); background: rgb(210, 234, 241); padding: 0px 7px;"><p style="line-height:29px"><span style="font-family:宋体">提交时仍保持游标</span></p></td></tr></tbody></table><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">想更深入的了解，可参考如下的</span><span style="font-size:16px;color:black">API</span><span style="font-size:16px;font-family:宋体;color:black">：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">http://doc.java.sun.com/DocWeb/api/java.sql.Connection</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">http://doc.java.sun.com/DocWeb/api/java.sql.ResultSet</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">http://doc.java.sun.com/DocWeb/api/java.sql.Statement</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">对于大数据量报表数据的查询，其实上面这个</span><span style="font-size:16px;color:black">fetchSize</span><span style="font-size:16px;font-family:宋体;color:black">参数至关重要。下面给出了一个测试结果：</span></p><table><tbody><tr class="firstRow"><td width="619" colspan="4" valign="top" style="border: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px">SQL<span style="font-family:宋体">：</span>select * from b2b_ticket_stat t &nbsp; where t.tkt_rcd_dt=? and t.userid=?</p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">数据量</span>(<span style="font-family:宋体">条</span>)</p></td><td width="142" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px">fetch size(<span style="font-family:宋体">条</span>)</p></td><td width="132" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">测试次数</span></p></td><td width="187" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">平均耗时（毫秒</span>ms<span style="font-family:宋体">）</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">73531</p></td><td width="142" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">10</p></td><td width="132" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">3</p></td><td width="187" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">333264</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">73531</p></td><td width="142" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">50</p></td><td width="132" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(84, 141, 212); padding: 0px 7px;"><p style="text-align:center;line-height:29px">3</p></td><td width="187" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">78797</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">73531</p></td><td width="142" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">100</p></td><td width="132" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">3</p></td><td width="187" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">44227</span></p></td></tr><tr><td width="158" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">73531</p></td><td width="142" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">200</p></td><td width="132" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">3</p></td><td width="187" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">32090</span></p></td></tr></tbody></table><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">程序关键代码如下：</span></p><p style="text-align:left;text-autospace:none"><span style="font-size:16px;font-family: Consolas;color:black">&nbsp;&nbsp; Connection con = dataSource.getConnection();</span></p><p style="text-align:left;text-autospace:none"><span style="font-size:16px;font-family: Consolas;color:black">&nbsp;&nbsp; PreparedStatement pstmt = con.prepareStatement(psql,</span></p><p style="text-align:left;text-autospace:none"><span style="font-size:16px;font-family: Consolas;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ResultSet.</span><i><span style="font-size:16px;font-family:Consolas;color:#0000C0">TYPE_FORWARD_ONLY</span></i><span style="font-size:16px;font-family:Consolas;color:black">,</span></p><p style="text-align:left;text-autospace:none"><span style="font-size:16px;font-family: Consolas;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ResultSet.</span><i><span style="font-size:16px;font-family:Consolas;color:#0000C0">CONCUR_READ_ONLY</span></i><span style="font-size:16px;font-family:Consolas;color:black">,</span></p><p style="text-align:left;text-autospace:none"><span style="font-size:16px;font-family: Consolas;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ResultSet.</span><i><span style="font-size:16px;font-family:Consolas;color:#0000C0">CLOSE_CURSORS_AT_COMMIT</span></i><span style="font-size:16px;font-family:Consolas;color:black">);</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:Consolas;color:black">&nbsp;&nbsp; pstmt.setQueryTimeout(0);</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:Consolas;color:black">&nbsp;&nbsp; pstmt.setFetchSize(50);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">注意</span><span style="font-size:16px;color:black">FetchSize</span><span style="font-size:16px;font-family:宋体;color:black">越大，一次性</span><span style="font-size:16px;color:black">load</span><span style="font-size:16px;font-family:宋体;color:black">的数据就越大，意味着占用的</span><span style="font-size:16px;color:black">JVM</span><span style="font-size:16px;font-family:宋体;color:black">内存就越大，根据单条数据的大小（字节，比如</span><span style="font-size:16px;color:black">0.2kb</span><span style="font-size:16px;font-family:宋体;color:black">，那么</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条数据就</span><span style="font-size:16px;color:black">2kb</span><span style="font-size:16px;font-family:宋体;color:black">了），确定合理的数据量，一般来说根据不同的情况，</span><span style="font-size:16px;color:black">FetchSize</span><span style="font-size:16px;font-family:宋体;color:black">效果的提升会有一个临界值，比如</span><span style="font-size:16px;color:black">1000</span><span style="font-size:16px;font-family:宋体;color:black">，超过这个临界值后效果提升就很小了。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">大数据量查询时，请特别注意上面这种写法，根据需要设置合理的</span><span style="font-size:16px;color:black">FetchSize</span><span style="font-size: 16px;font-family:宋体;color:black">就可以了。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size: 16px;font-family:宋体;color:black">、采用合理的报表文件格式</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">这也是我们不得不考虑的一个额外因素。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">现在用得比较多的报表格式是</span><span style="font-size:16px;color:black">Microsoft Excel</span><span style="font-size:16px;font-family: 宋体;color:black">的格式，</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">，然后是</span><span style="font-size: 16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">和</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">，也可能有其他的要求，比如</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">、图片、</span><span style="font-size: 16px;color:black">pdf</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">doc</span><span style="font-size:16px;font-family:宋体;color:black">等。下面简单介绍几个。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">文件</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; csv</span><span style="font-size:16px;font-family:宋体;color:black">是纯文本格式，并且</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">是逗号分割式文件，用</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">打开时可以呈现类似于</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">的表格效果。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">因为</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">是逗号分割的纯文本文件，除了数据（全都是字符串）本身之外，没有任何附加信息，所以它不具备设置表格样式、数据类型、公式这样一些功能，但是</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">有打开速度快、占用空间小、可以用</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">打开等优点。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）</span><span style="font-size:16px;color:black">xls</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">即众所周知的</span><span style="font-size:16px;color:black">Microsoft Excel</span><span style="font-size:16px;font-family:宋体;color:black">（</span><span style="font-size:16px;color:black">97-2003</span><span style="font-size:16px;font-family:宋体;color:black">）工作表，功能很强大，支持表格样式、公式等等。但是因为它是专用格式，包含了很多附加信息，例如每个单元格的字体、颜色、数据类型等等，所以占用空间比较大，通常来说，相同数据量的情况下，比纯文本文件要大几倍，甚至更多。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">另外，</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">文件最大只支持</span><span style="font-size:16px;color:black">65536</span><span style="font-size:16px;font-family:宋体;color:black">行</span><span style="font-size:16px;color:black">*256</span><span style="font-size:16px;font-family:宋体;color:black">列数据，所以如果超过</span><span style="font-size:16px;color:black">256</span><span style="font-size:16px;font-family:宋体;color:black">列或者</span><span style="font-size: 16px;color:black">6</span><span style="font-size:16px;font-family:宋体;color:black">万多行的数据，</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">是无法保存的。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">）</span><span style="font-size:16px;color:black">xlsx</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xlsx</span><span style="font-size:16px;font-family:宋体;color:black">是</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">的升级版，是从</span><span style="font-size:16px;color:black">Microsoft Office 2007</span><span style="font-size:16px;font-family:宋体;color:black">版起开始启用的新格式，这个格式其实是一个基于</span><span style="font-size:16px;color:black">XML</span><span style="font-size:16px;font-family:宋体;color:black">的压缩文件格式，把它的后缀改成</span><span style="font-size:16px;color:black">zip</span><span style="font-size:16px;font-family:宋体;color:black">打开可以看到，里面有很多的</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">，它比</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">占用的空间稍小，支持最大行数是</span><span style="font-size:16px;color:black">1048576</span><span style="font-size:16px;font-family:宋体;color:black">行，最大列数是</span><span style="font-size:16px;color:black"> 16384</span><span style="font-size:16px;font-family:宋体;color:black">列。但是相当于纯文本来说，它占用的空间还是非常大的，而且只有</span><span style="font-size:16px;color:black">Microsoft Excel 2007</span><span style="font-size:16px;font-family:宋体;color:black">及其以上的版本才支持打开</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">文件。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">另外注意到，虽然</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">支持上百万行的数据，但是如果真要打开一个上百万行、几百</span><span style="font-size:16px;color:black">MB</span><span style="font-size:16px;font-family:宋体;color:black">的文件的话，会把</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">软件给撑死的，对于这种超大的数据量的文件，还是纯文本的处理效率高一点。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">5</span><span style="font-size: 16px;font-family:宋体;color:black">、生成报表的工具</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">如果是</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">等简单格式，其实可以不需要工具，但是像</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">pdf</span><span style="font-size:16px;font-family:宋体;color:black">等，可能就需要借助一些插件或工具来完成了，常用的比如</span><span style="font-size:16px;color:black">Birt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">JasperReports</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">iReport</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">JFreeReport</span><span style="font-size:16px;font-family:宋体;color:black">，也可以基于较底层的</span><span style="font-size:16px;color:black">Jakarta POI API</span><span style="font-size:16px;font-family: 宋体;color:black">去开发。在后续章节中，我们会对这些报表工具进行更详细的介绍。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.4&nbsp; </span></a><span style="font-family:黑体;color:black">离线生成报表的机制</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">一、问题的提出</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何减少用户下载报表的等待时间？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何提高报表的生成效率？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何对报表下载实行统一的调度？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何实行报表文件的多次下载？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何对报表文件进行统一的管理？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">二、问题的分析</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、如何减少用户下载报表的等待时间？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">一般的做法是，用户提交一个请求，然后程序去查询数据，然后生成文件，最后再把文件返回给用户。如果这个过程时间很长，那么用户需要在页面上等待很长一段时间，比如</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">分钟甚至更长，页面一直卡在那里，还不能离开，不能做其他事情，用户会疯掉的。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">因此，如果能实现一种全新的模式，“让用户只需要提交一个请求，然后可以离开当前页面去做其他事情，甚至退出登录”，那将是多么美好的事情！所谓的“离线生成报表技术”就完成了这样一个目的：它接收用户的报表请求，然后立即返回，告诉用户“</span><span style="font-size:16px;color:black">OK</span><span style="font-size:16px;font-family:宋体;color:black">，您的请求已接收，正在处理中”。报表的生成过程完全在服务器后端执行，执行完成后才通知用户。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、如何提高报表的生成效率？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">从普通角度来说，需要提高生成报表的速度，除了各种优化之外，还可以专门为报表制定多线程去处理（充分利用</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">和</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">），进一步讲，还可以用多进程、多服务器去处理，成倍地提高报表生成的速度。从另外一个角度来说，优先服务“优先级较高的报表”，也是一种侧面提高效率的方式。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">、如何对报表下载实行统一的调度？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">要实现统一调度，首先要对用户发起的报表请求进行统一管理。分析用户的请求，根据特定标识（比如用户</span><span style="font-size:16px;color:black">ID</span><span style="font-size:16px;font-family:宋体;color:black">、报表类型等等），制定不同的并发数和优先级，按一定的策略制定报表执行的先后顺序。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size:16px;font-family:宋体;color:black">、如何实行报表文件的多次下载？如何对报表文件进行统一的管理？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">通常情况下，用户的每次请求都要去生成一次报表，然后供用户下载，报表文件是一次性使用的，服务器端不会保存这个报表文件。能不能把报表文件保存起来，用户需要可以随时去下载？比如用户需要对比现在这个报表和</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">天前的报表的数据，但是用户自己通常不会保存</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">天前的报表，所以他可能还会去下载一次。每天下载一个报表，积累</span><span style="font-size:16px;color:black">7</span><span style="font-size:16px;font-family:宋体;color:black">天，就可以形成一个“周报表”，实际上这就是用户需要的。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">报表文件的统一管理，比如怎么存储（怎么定义文件名和目录）？怎么控制操作文件的权限？怎么控制文件的保存时间（比如最多只保存</span><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">个月）？实际上，只要制定一套规范标准，按照这个定义去执行就可以了。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">三、离线生成报表的实现</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">这一套流程如果要完全实现，还是有些复杂度，在此，只对其中的关键点进行介绍。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、对用户提交的报表请求进行统一的管理</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">基本思路：将每一个请求定义成一条“任务（</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">）”，再把这个任务附加上一些参数，再存入数据库中。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">）关键问题一：</span> <span style="font-size:16px;font-family: 宋体;color:black">如何定义一条任务？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">用户提交的每一个报表请求，通常都包含了一些限定条件（查询条件），有些限定条件是用户在页面输入的查询条件，有些限定条件是从服务器端根据用户标识等默认自动加上去的。那么我们就需要把这些数据封装起来，形成一条数据，插入到数据库中。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XML</span><span style="font-size:16px;font-family: 宋体;color:black">是一种比较好的组装和解析数据的方式，同时也支持较复杂的数据结构，我们可以将页面表单信息，包括服务器端的一些信息组装成</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">，然后存入数据库中，这样就形成了一条</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">）关键问题二：应该为任务附加哪些参数？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">除了上面那些查询条件之类的信息，还需要附加一些额外的信息，用作调度控制用。比如任务编号，给每一个任务一个唯一的标号。还比如</span><span style="font-size:16px;color:black">serviceID</span><span style="font-size:16px;font-family:宋体;color:black">，代表处理这个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">对应的服务程序。还比如</span><span style="font-size:16px;color:black">priority</span><span style="font-size:16px;font-family:宋体;color:black">，代表这个任务执行的优先级。</span><span style="font-size:16px;color:black">status</span><span style="font-size:16px;font-family:宋体;color:black">，代表这个任务的状态，等等。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、对报表的生成进行统一的调度处理</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">分成如下几个模块：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">任务装载——任务分配——任务执行——任务更新</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">）任务装载</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">如图所示：</span></p><p><span style="font-size:16px;color:black"><img width="609" height="87" src="{{site.assets_url}}img/20190130/clip_image007.png" alt="clip_image007.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">主要是一个从数据库中查询数据的过程。按照一定的条件，比如每次查询出</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">数据，隔</span><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">分钟检查一次这</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条任务执行完没有，如果执行完了，这再查询出</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">。查询出来的数据，要更新它的</span><span style="font-size:16px;color:black">load_status</span><span style="font-size:16px;font-family:宋体;color:black">状态，比如</span><span style="font-size:16px;color:black">load_status=0</span><span style="font-size:16px;font-family:宋体;color:black">表示未装载，</span><span style="font-size:16px;color:black">load_status=1</span><span style="font-size:16px;font-family:宋体;color:black">代表已装载。甚至还可以做一个机制，装载任务的时候将</span><span style="font-size:16px;color:black">taskNo</span><span style="font-size:16px;font-family:宋体;color:black">存入服务器端文件中，如果数据被装载了，但是由于服务器强制重启或者挂掉，任务没有被执行，那么服务器启动的时候首先从本地文件中读取</span><span style="font-size:16px;color:black">taskNos</span><span style="font-size:16px;font-family:宋体;color:black">，然后检查这些</span><span style="font-size:16px;color:black">taskNos</span><span style="font-size:16px;font-family:宋体;color:black">是否都已经执行完成，如果没有执行完成，则再次</span><span style="font-size:16px;color:black">load</span><span style="font-size:16px;font-family:宋体;color:black">这些数据。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">）任务分配</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">如图所示：</span></p><p><span style="font-size:16px;color:black"><img width="608" height="199" src="{{site.assets_url}}img/20190130/clip_image009.png" alt="clip_image009.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">对已装载的任务分配</span><span style="font-size:16px;color:black">worker</span><span style="font-size:16px;font-family: 宋体;color:black">去执行它（</span><span style="font-size:16px;color:black">worker</span><span style="font-size:16px;font-family: 宋体;color:black">代表实际去执行这个任务的线程）。这有一个简单的调度过程，先把装载好的任务放到一个</span><span style="font-size:16px;color:black">waitList</span><span style="font-size:16px;font-family:宋体;color:black">里面，比如一共有</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个</span><span style="font-size:16px;color:black">worker</span><span style="font-size:16px;font-family:宋体;color:black">可用，那就分配</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，但是如果只剩</span><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">个</span><span style="font-size:16px;color:black">worker</span><span style="font-size:16px;font-family:宋体;color:black">可用，那么就只能分配</span><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，剩下的</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">将进入等待状态。同时，按照一定的规则顺序将</span><span style="font-size:16px;color:black">waitList</span><span style="font-size:16px;font-family:宋体;color:black">里面的数据分配到</span><span style="font-size:16px;color:black">runningList</span><span style="font-size:16px;font-family:宋体;color:black">里面去，比如某个任务要在</span><span style="font-size:16px;color:black">13:00</span><span style="font-size:16px;font-family:宋体;color:black">执行，它会提前一点时间进入</span><span style="font-size:16px;color:black">waitList</span><span style="font-size:16px;font-family:宋体;color:black">，然后到了</span><span style="font-size:16px;color:black">13:00</span><span style="font-size:16px;font-family:宋体;color:black">，才给它分配</span><span style="font-size:16px;color:black">worker</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">）任务执行</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">如图所示：</span></p><p style="text-align:center"><span style="font-size:16px;color:black"><img width="339" height="331" src="{{site.assets_url}}img/20190130/clip_image010.png" alt="clip_image010.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">每一个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family: 宋体;color:black">对应一个</span><span style="font-size:16px;color:black">serviceID</span><span style="font-size:16px;font-family: 宋体;color:black">，代表了这个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family: 宋体;color:black">需要哪一个</span><span style="font-size:16px;color:black">service</span><span style="font-size:16px;font-family: 宋体;color:black">为它服务（就是说具体的生成报表的逻辑由一个对应的</span><span style="font-size:16px;color:black">service</span><span style="font-size:16px;font-family:宋体;color:black">类去处理），</span><span style="font-size:16px;color:black">worker</span><span style="font-size:16px;font-family:宋体;color:black">线程的作用只是去调用</span><span style="font-size:16px;color:black">serviceID</span><span style="font-size:16px;font-family:宋体;color:black">指定的</span><span style="font-size:16px;color:black">service</span><span style="font-size:16px;font-family:宋体;color:black">类执行处理逻辑。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size:16px;font-family:宋体;color:black">）任务更新</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">如图所示：</span></p><p><span style="font-size:16px;color:black"><img width="608" height="159" src="{{site.assets_url}}img/20190130/clip_image012.png" alt="clip_image012.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">任务何时开始执行；何时执行结束；如果出现异常，那么发生异常的时间和原因等，都需要及时的更新到</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">表中，这时就需要一个任务更新的模块来执行这些工作。在任务分配、任务执行的关键时间点上，会向任务更新模块传递任务执行的信息，任务更新模块接收到了这些信息后，就去执行更新数据库的操作。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.5&nbsp; </span></a><span style="font-family:黑体;color:black">并发操作的控制</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">一、问题的提出</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何控制某个功能的访问并发数？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何避免高并发引起的处理压力？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何针对某个功能进行“服务优先级”控制？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">二、问题的研究</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Web</span><span style="font-size:16px;font-family: 宋体;color:black">服务器有一个最大</span><span style="font-size:16px;color:black">HTTP</span><span style="font-size:16px;font-family: 宋体;color:black">线程数控制，但是这个是全局的，无法针对某个功能点进行并发控制。举例来讲，假设订单查询是很耗资源、很费时的操作，所以在同一时刻，我们最多只允许有</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个订单查询的请求，怎么来控制？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">显然，这个功能是和具体的业务要求相关的，所以基本思路是通过应用程序来控制。比如说写一个过滤器</span><span style="font-size:16px;color:black">Filter</span><span style="font-size:16px;font-family:宋体;color:black">，对这种请求进行检查和处理。由此，我们引入一种手段，称之为“并发锁机制”。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、并发锁机制原理</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">对于具有某个特定标识（比如用户</span><span style="font-size:16px;color:black">ID</span><span style="font-size:16px;font-family: 宋体;color:black">）的访问，记录其访问的次数。访问开始计数器加</span><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">，访问结束计数器减</span><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">。当计数器等于</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">时，代表此时有</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">个请求正在处理中，如果</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">大于我们定义的最大并发数，则立即拒绝进一步的处理，返回并告知访问者“当前服务正忙，请稍后再试！”</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">对于不同的访问标识，定义不同的最大并发数，通过这种方法可以实现“限量访问”、和“优先级控制”。假设用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">的最大并发数分别定义为</span><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">和</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">，分析如下：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">）非抢占规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">假设正在处理的</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">、</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">用户的请求数均为</span><span style="font-size:16px;color:black">0</span><span style="font-size:16px;font-family: 宋体;color:black">，然后来了</span><span style="font-size:16px;color:black">8</span><span style="font-size:16px;font-family: 宋体;color:black">个用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">的请求和</span><span style="font-size:16px;color:black">8</span><span style="font-size:16px;font-family: 宋体;color:black">个用户</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">的请求。那么，按照“非抢占规则”，此时有</span><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">个用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family:宋体;color:black">的任务和</span><span style="font-size:16px;color:black">8</span><span style="font-size:16px;font-family:宋体;color:black">个用户</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">的任务能得到处理，剩下的</span><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">个用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family:宋体;color:black">的任务将被拒绝。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">也就是说，</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">的任务只能占用</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">那固定的</span><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family: 宋体;color:black">个并发数名额；</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">的任务只能占用</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">那固定的</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family: 宋体;color:black">个名额。它们不能够互相抢占对方的并发数名额。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">在这种方式下，</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">和</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">的任务都可以得到处理，只是处理的数量不同而已。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">）抢占规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">和</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">有优先级关系，假设用户</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">的优先级比用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">要高，那么用户</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">的请求可以获得优先满足，并可以占用</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family:宋体;color:black">的并发数名额。但是，如果用户</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family:宋体;color:black">的请求达到了最大并发数，则会被拒绝。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">其逻辑可以用如下的代码来描述：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">// X</span><span style="font-size:16px;font-family:宋体;color:black">代表一个请求</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">if(X==B) </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( runList.size()&gt;(MB+MA) ){ //</span><span style="font-size:16px;font-family:宋体;color:black">达到最大并发数</span><span style="font-size:16px;color:black">MB+MA</span><span style="font-size:16px;font-family:宋体;color:black">，则拒绝</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ConcurrencyException();</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }else{ //</span><span style="font-size:16px;font-family: 宋体;color:black">否则执行</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family: 宋体;color:black">的任务</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runList.add(B);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //…doService </span><span style="font-size:16px;font-family: 宋体;color:black">结束时</span><span style="font-size:16px;color:black">runList.remove(B)</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">if(X==A)</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(runList.size()&gt;MA ){ //</span><span style="font-size:16px;font-family:宋体;color:black">达到最大并发数</span><span style="font-size:16px;color:black">MA</span><span style="font-size:16px;font-family:宋体;color:black">，则拒绝</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ConcurrencyException();</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else{ //</span><span style="font-size:16px;font-family: 宋体;color:black">否则执行</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family: 宋体;color:black">的任务</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runList.add(A);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //…doService </span><span style="font-size:16px;font-family: 宋体;color:black">结束时</span><span style="font-size:16px;color:black">runList.remove(A)</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、并发锁机制的实现</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">如下图所示：</span></p><p style="text-align:center"><span style="font-size:16px;color:black"><img width="606" height="330" src="{{site.assets_url}}img/20190130/clip_image013.png" alt="clip_image013.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">详见附件的</span><span style="font-size:16px;color:black">Demo</span><span style="font-size:16px;font-family: 宋体;color:black">程序。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">、优先级控制</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、非阻塞模式（把任务交给线程去调度）：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">将数据封装到</span><span style="font-size:16px;color:black">Worker</span><span style="font-size:16px;font-family: 宋体;color:black">中，加入到有序的队列中，控制线程按顺序去取出</span><span style="font-size:16px;color:black">Worker</span><span style="font-size:16px;font-family:宋体;color:black">，然后启动线程去执行。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、阻塞模式（循环等待，直到执行或者超时）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family: 宋体;color:black">来了一个请求，首先加入到排队队列中，如果排在前</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">位，则执行，否则，等待、再检查是否排在前</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">位，如果排在</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">位，则执行，否则，再等待……如此循环。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family: 宋体;color:black">常用的阻塞模式实现如下所示：</span></p><p><span style="font-size:16px;color:black"><img width="288" height="147" src="{{site.assets_url}}img/20190130/clip_image015.png" alt="clip_image015.png"/>&nbsp;<img width="303" height="147" src="{{site.assets_url}}img/20190130/clip_image017.png" alt="clip_image017.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.6 </span></a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">&nbsp;</span><span style="font-family:黑体;color:black">多线程生成报表的技术</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">一、问题的提出</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">多线程如何提高报表的生成效率？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何设计处理报表的多线程程序？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">二、问题的研究</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">、多线程如何提高报表的生成效率？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">普通电脑上的多线程实际上是串行执行的（例如我笔记本</span><span style="font-size: 16px;color:black">WIN7</span><span style="font-size:16px;font-family:宋体;color:black">系统，</span><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">核</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">，但是执行多线程程序的时候，仍然是串行执行的，</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">在多个线程中是来回切换执行，同一个时间只能有一个线程获取</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">），传说某些</span><span style="font-size:16px;color:black">AMD</span><span style="font-size:16px;font-family:宋体;color:black">的</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">可以提高一些多线程处理的能力。其实，可见多线程的调度和操作系统、</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">有关系，具体的效果要看环境，可以做一些测试。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">现在很多的生产服务器，是多个</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">（注意是多个</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">而不是单个</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">多核心），那么在这种环境中，就能体现出多线程的优势。特别是多线程在执行一些</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">操作时，性能能够得到很大的提升（如果没有</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">操作，而主要是靠</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">的计算，那么多线程优势可能不会有这么明显）。总之来说，多线程是提高报表处理能力的一种途径。但是其效果要看程序具体的运行环境，这个“多”线程到底要“几个”线程才是最有效的，最好要通常实际的测试来确定。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">多线程与其他环境的关系图：</span></p><p style="text-align:center"><span style="font-size:16px;color:black"><img width="538" height="161" src="{{site.assets_url}}img/20190130/clip_image018.png" alt="clip_image018.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">总结，多线程的优势：</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">性能提高关键之处一：</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">多数据连接、数据装载并发执行。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">性能提高关键之处二：</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">多</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">、文件生成并发执行。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">性能提高关键之处三：</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">如果是多</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">，则可以实现并行计算处理。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">、如何设计处理报表的多线程程序？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">这一方面可以直接采用</span><span style="font-size:16px;color:black">Java</span><span style="font-size:16px;font-family:宋体;color:black">的基础</span><span style="font-size:16px;color:black">API</span><span style="font-size:16px;font-family:宋体;color:black">来实现，</span><span style="font-size:16px;color:black">Java</span><span style="font-size:16px;font-family:宋体;color:black">对于线程的操作比较简单（但是不好控制），关键是要对多线程进行合理的控制——</span><span style="font-size:16px;color:black">Java</span><span style="font-size:16px;font-family:宋体;color:black">多线程编程。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）关键点一：如何合理的分配线程</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">首先，对线程的数量进行控制，应该有一个最大线程数</span><span style="font-size: 16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">。这个</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">要根据具体的环境确定，比如</span><span style="font-size:16px;color:black">N=1</span><span style="font-size:16px;font-family:宋体;color:black">或者</span><span style="font-size:16px;color:black">N=100</span><span style="font-size:16px;font-family:宋体;color:black">效率可能都较低，那么</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">等于多少时效率是最高的，要根据所在的环境去测试来确定。第二，任务按照何种顺序、优先级来分配线程，应该有这样一个调度程序，来执行分配线程的工作。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）关键点二：对线程进行监控</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">线程分配后，应该把它的对象的引用</span><span style="font-size:16px;color:black">(</span><span style="font-size:16px;font-family:宋体;color:black">句柄</span><span style="font-size:16px;color:black">)</span><span style="font-size: 16px;font-family:宋体;color:black">保存起来，比如放到一个</span><span style="font-size:16px;color:black">Map</span><span style="font-size:16px;font-family:宋体;color:black">中，这样就可以随时观察和控制这个线程。例如</span><span style="font-size:16px;color:black">Map</span><span style="font-size:16px;font-family:宋体;color:black">里面有一个</span><span style="font-size: 16px;color:black">thread01</span><span style="font-size:16px;font-family: 宋体;color:black">，调用这个</span><span style="font-size:16px;color:black">thread01.getState()</span><span style="font-size:16px;font-family:宋体;color:black">，就可以知道这个线程的状态。还可以保存这个线程的启动时间等等。有这样的一个监控体系，才能够适应比较复杂的应用场景。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">）关键点三：如何处理异常的线程</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">单个线程是独立的，一旦挂掉，如果不做处理，可能会带来一些麻烦。所以线程内部应该捕获异常，在生成报表的过程中，如果出现了异常，则转而执行对应的异常处理流程。但是有一种情况比较特殊，比如一个报表任务或者一个线程，它的最大执行时间是限定了的，比如我们可以设定执行报表任务的线程最多只能执行</span><span style="font-size:16px;color:black">60</span><span style="font-size:16px;font-family:宋体;color:black">分钟。如果这个线程的执行时间超过了</span><span style="font-size:16px;color:black">60</span><span style="font-size:16px;font-family:宋体;color:black">分钟，则视之为出现了异常，此时需要强行的结束这个线程。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size: 16px;font-family:宋体;color:black">）关键点四：注意数据的同步</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">每个线程所执行的</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，都应该是不重复的，也就是说“一个线程处理一个</span><span style="font-size: 16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，不至于某个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">被多个线程同时执行”。这个主要是控制在数据装载的时候。通常来说负责数据装载的线程只有一个，负责线程调度的线程也只有一个，负责执行任务的线程有多个。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">报表系统多线程关系示意图：</span></p><p><span style="font-size:16px;color:black"><img width="608" height="297" src="{{site.assets_url}}img/20190130/clip_image020.png" alt="clip_image020.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">总结：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">、为什么要采用线程池？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; java.util.concurrent.ThreadPoolExecutor</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">、设置合理的线程数，需根据</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">数量以及程序（数据库、</span><span style="font-size:16px;color:black">IO</span><span style="font-size:16px;font-family:宋体;color:black">）等实测去确定。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">、适当的分层、合理的统一，解决线程、数据同步问题，设计和算法是关键。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size: 16px;font-family:宋体;color:black">、监控机制（线程、数据）——可视化监视，可手动控制。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">5</span><span style="font-size: 16px;font-family:宋体;color:black">、注意异常线程的处理，比如达到了</span><span style="font-size:16px;color:black">timeout</span><span style="font-size:16px;font-family:宋体;color:black">的线程如何处理？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.7 </span></a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">&nbsp;</span><span style="font-family:黑体;color:black">多服务器生成报表的技术</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">一、问题的提出</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何进一步的提高报表的生成效率？</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:16px;font-family:Wingdings;color:black">w<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">如何设计多服务器生成报表的应用程序、系统架构？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">多服务器系统示意图：</span></p><p><span style="font-size:16px;color:black"><img width="598" height="382" src="{{site.assets_url}}img/20190130/clip_image022.png" alt="clip_image022.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">二、问题的分析</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">、为什么要用多服务器？——服务能力分析</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">案例：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）实现针对手机终端的信息推送功能，支持终端量级为千万级。（来源：</span><span style="font-size:16px;color:black">oschina</span><span style="font-size:16px;font-family:宋体;color:black">）</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">分析：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">如果用</span><span style="font-size:16px;color:black">TCP</span><span style="font-size:16px;font-family:宋体;color:black">长连接实现，单台</span><span style="font-size:16px;color:black">20</span><span style="font-size:16px;font-family:宋体;color:black">万长连接，支持千万级别只要</span><span style="font-size:16px;color:black">50</span><span style="font-size:16px;font-family:宋体;color:black">台机器。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）报表引擎，每个应用服务器开设</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个线程处理报表，共</span><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">台服务器。</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">分析：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">假设一台服务器平均每</span><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">秒执行完</span><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">个报表，</span><span style="font-size: 16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">台服务器一分钟可执行的报表数量为</span><span style="font-size:16px;color:black">90</span><span style="font-size:16px;font-family:宋体;color:black">个，执行完</span><span style="font-size:16px;color:black">1000</span><span style="font-size:16px;font-family:宋体;color:black">个报表要</span><span style="font-size:16px;color:black">11</span><span style="font-size:16px;font-family:宋体;color:black">分钟，</span><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">万个报表要</span><span style="font-size: 16px;color:black">111</span><span style="font-size:16px;font-family:宋体;color:black">分钟。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">面对超大的服务压力，那我们应该怎么办？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span><span style="font-size:16px;font-family:宋体;color:black">、改善系统架构。（后面会讲到）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2</span><span style="font-size:16px;font-family:宋体;color:black">、增加服务器。（就是本节所讲的内容）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3</span><span style="font-size:16px;font-family:宋体;color:black">、……</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">、如何进一步的提高报表的生成效率？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">上面提到一点：“多线程”，但是也说明了，多线程的效率可能因为环境的不同而有所差异，通常来说，多线程能提高的效率比较有限。如果是多“进”程，则效率提升会更明显，几乎能成倍地提高效率。而放到“多服务器”的层面，通过集群的方式，则效率提升更加明显。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">多服务器（或者多进程）所面临的关键问题：如何保证一条</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">只能被一个服务器装载（因为它被一个服务器装载之后，其他服务器就没必要再去处理它了），进一步讲就是“如何保证一条</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">不会被多个服务器同时更改，多服务器之间如何进行数据的同步？”</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">、如何设计多服务器生成报表的应用程序、系统架构？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">从系统架构上讲，有如下两种方式：</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">架构一：多应用服务器</span><span style="font-size:16px;color:black"> + </span><span style="font-size:16px;font-family:宋体;color:black">同一套数据库（</span><span style="font-size:16px;color:black"> + </span><span style="font-size:16px;font-family:宋体;color:black">共用文件存储空间）</span></p><p style="text-align:center"><span style="font-size:16px;color:black"><img width="608" height="189" src="{{site.assets_url}}img/20190130/clip_image024.png" alt="clip_image024.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">架构二：（一个应用服务器</span><span style="font-size:16px;color:black"> + </span><span style="font-size:16px;font-family:宋体;color:black">一套数据库）×</span><span style="font-size:16px;color:black">N</span></p><p style="text-align:center"><span style="font-size:16px;color:black"><img width="523" height="224" src="{{site.assets_url}}img/20190130/clip_image025.png" alt="clip_image025.png"/></span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">方案一的优势：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;</span><span style="font-size:16px;font-family:宋体;color:black">数据和文件都得到了统一，统一调度、统一管理；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;AppServer</span><span style="font-size:16px;font-family: 宋体;color:black">可以方便的平行扩展。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">方案二的优势：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;</span><span style="font-size:16px;font-family:宋体;color:black">一台服务器对应一个数据库，数据库资源独享；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;</span><span style="font-size:16px;font-family:宋体;color:black">多服务器之间完全独立，不需要同步。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">综合分析，方案一比较好，但是要解决“多服务器之间如何进行数据同步”的问题，后面将做详细介绍。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">另外，可以将架构一和二结合起来，将架构二中的</span><span style="font-size: 16px;color:black">AppServer</span><span style="font-size:16px;font-family: 宋体;color:black">换成</span><span style="font-size:16px;color:black">Cluster</span><span style="font-size:16px;font-family:宋体;color:black">，每个</span><span style="font-size:16px;color:black">Cluster</span><span style="font-size:16px;font-family:宋体;color:black">采用架构一的类似设计，这样就可以结合二者的优势。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">三、多服务器生成报表的解决方案</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">需要解决的关键问题是：数据如何在多服务器之间保持同步？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">即“如何确保一条</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">只被一个服务器装载？”</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">——解决思路：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span><span style="font-size:16px;font-family:宋体;color:black">、控制数据的装载（读取）入口，避免同一数据被多个服务器装载。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2</span><span style="font-size:16px;font-family:宋体;color:black">、采用状态位或者“模拟锁”的方式，控制多服务器共同修改数据。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）关键点一：合理的进行数据装载</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">如果每个服务器都去查询</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，每次查询</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个，那么可能服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">查询出来的</span><span style="font-size: 16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，同时也被服务器</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">查询出来了。最容易想到的方法是：服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">查询出</span><span style="font-size: 16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条数据，然后把这</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条数据的</span><span style="font-size:16px;color:black">load_status</span><span style="font-size:16px;font-family:宋体;color:black">状态改成</span><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">（“已装载”）。这种简单的想法是不太实用的，因为服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">查询</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条数据改状态，服务器</span><span style="font-size:16px;color:black">B</span><span style="font-size: 16px;font-family:宋体;color:black">也可能在这同一时刻查询出这</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">条数据改状态，如果服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size:16px;font-family:宋体;color:black">改状态成功了</span><span style="font-size: 16px;color:black">8</span><span style="font-size:16px;font-family:宋体;color:black">条，服务器</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">改状态成功了</span><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">条，这通常是一个批量更新的过程，那么怎么判断是哪几条数据状态改成功了、哪几条数据状态更改失败了？而且这服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">之间相互抢占数据的频率是很高的，上面这种情况经常发生。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">解决方案：采用“模拟锁”。上面那种简单的想法其实也管用，但就是有一个很大的缺点：所有的数据都会被多个服务器抢占。其实，可以改进一下：</span> <span style="font-size:16px;font-family:宋体;color:black">只抢占一条特定的数据（称这条数据为“锁”），如果服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">抢占成功了（我们称之为“拿到了钥匙”），就可以继续去查询其他数据，反之，如果它没有抢到“钥匙”，就需要进入短暂的等待。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">模拟锁实现原理：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">见如下的代码描述：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">public void loadTaskData(int queryNum){</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // START - </span><span style="font-size:16px;font-family: 宋体;color:black">开始事务</span><span style="font-size:16px;color:black"> (</span><span style="font-size:16px;font-family:宋体;color:black">在</span><span style="font-size:16px;color:black">Spring</span><span style="font-size:16px;font-family:宋体;color:black">的</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">中配置的，声明式事务</span><span style="font-size:16px;color:black">)</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span style="font-size:16px;font-family:宋体;color:black">也可以用编程式事务</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span style="font-size:16px;font-family:宋体;color:black">拿钥匙</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; taskDAO.updateDBKey();</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&quot;select &#39;&#39; from report_config t where t.key=&#39;DB_OCCUPY_KEY&#39; for update&quot;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span style="font-size:16px;font-family:宋体;color:black">查询数据</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Task&gt; queryList = taskDAO.queryTasks(queryNum);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(queryList==null || queryList.size()&lt;1){</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span style="font-size:16px;font-family:宋体;color:black">更改</span><span style="font-size:16px;color:black">taskSet</span><span style="font-size:16px;font-family:宋体;color:black">数据在数据库中的状态</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; boolean success = taskDAO.updateScheduledStatusBatch(queryList);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(!success){</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // </span><span style="font-size:16px;font-family: 宋体;color:black">抛出异常，事务回滚</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new RuntimeException();</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // TODO </span><span style="font-size:16px;font-family:宋体;color:black">装载数据（存入</span><span style="font-size:16px;color:black">taskSet</span><span style="font-size:16px;font-family:宋体;color:black">）供使用。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(Task task:queryList)</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; task.setStatus(MainConfig.TASK_STATUS_SHEDULED);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ControlCenter.taskList.add(task);</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // END&nbsp; - </span><span style="font-size:16px;font-family:宋体;color:black">提交事务</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">}</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）关键点二：多服务器部署和配合</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对多服务器的部署并没有要求，独立部署、集群部署都可以。建议在多应用服务器的基础上见了一套</span><span style="font-size:16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器，通过</span><span style="font-size:16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器来统一访问各个应用服务器。建议多个服务器采用同一个数据、共用所有表。另外，建议“不同的服务器生成的报表文件最好是放在统一的地方”，也就是说多个服务器要有一个共享的存储空间。这样从多个服务器都可以直接操作这些文件，便于管理、也便于下载。举个例子，如果服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">生成的报表文件发到各自的磁盘目录下，那么用户如果访问</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">服务器但是要下载</span><span style="font-size:16px;color:black">B</span><span style="font-size:16px;font-family:宋体;color:black">服务器上的报表则会出现困难。当然，也有解决办法，就是在服务器生成一个报表文件时，标明它是在哪个服务器生成的以及它的物理存放地址，当用户下载报表时，就返回一个下载的链接，这个链接直接指向报表文件所在的服务器的地址。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">关于负载均衡，对于外部应用的访问请求（比如新增报表的请求），如果有</span><span style="font-size:16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器，则通过</span><span style="font-size: 16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器来做这一块儿的负责均衡。建议一定要建立</span><span style="font-size: 16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器。万一没有</span><span style="font-size:16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器，则可以模拟</span><span style="font-size:16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">服务器的访问分发机制，做一个简单的、比例比较均衡的随机访问机制。对于生成报表方面，上面说到了“模拟锁”机制，其实在“模拟锁”机制上稍微优化一下，则可以做到</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">的公平分配。每个服务器都定时轮流查询数据库装载数据，限定每个服务器最多只能拿多少个</span><span style="font-size:16px;color:black">task</span><span style="font-size:16px;font-family:宋体;color:black">，比如</span><span style="font-size:16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个，如果服务器</span><span style="font-size:16px;color:black">A</span><span style="font-size: 16px;font-family:宋体;color:black">拿满了</span><span style="font-size: 16px;color:black">10</span><span style="font-size:16px;font-family:宋体;color:black">个，则让它等待一段时间，把机会让给其他服务器。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">2.8&nbsp; </span></a><span style="font-family:黑体;color:black">实时下载技术</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.8.1</span><span style="font-size:16px;font-family:宋体;color:black">下载概念</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">下载（</span><span style="font-size: 16px;color:black">xi</span><span style="font-size:16px;font-family:宋体;color:black">à</span><span style="font-size:16px;color:black"> z</span><span style="font-size:16px;font-family:宋体;color:black">à</span><span style="font-size:16px;color:black">i</span><span style="font-size:16px;font-family:宋体;color:black">）是指通过网络进行传输文件，把互联网或其他电子计算机上的信息保存到本地电脑上的一种网络活动。下载可以显式或隐式地进行，只要是获得本地电脑上所没有的信息的活动，都可以认为是下载，如在线观看。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.8.2</span><span style="font-size:16px;font-family:宋体;color:black">下载方式</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; WEB</span><span style="font-size:16px;font-family:宋体;color:black">下载方式分为</span><span style="font-size: 16px;color:black">HTTP</span><span style="font-size:16px;font-family:宋体;color:black">与</span><span style="font-size:16px;color:black">FTP</span><span style="font-size:16px;font-family:宋体;color:black">两种类型，它们分别是</span><span style="font-size:16px;color:black">Hyper Text Transportation Protocol(</span><span style="font-size:16px;font-family:宋体;color:black">超文本传输协议</span><span style="font-size:16px;color:black">)</span><span style="font-size: 16px;font-family:宋体;color:black">与</span><span style="font-size:16px;color:black">File Transportation Protocol(</span><span style="font-size:16px;font-family:宋体;color:black">文件传输协议</span><span style="font-size: 16px;color:black">)</span><span style="font-size:16px;font-family:宋体;color:black">的缩写，它们是计算机之间交换数据的方式，也是两种最经典的下载方式，该下载方式原理非常简单，就是用户两种规则（协议）和提供文件的服务器取得联系并将文件搬到自己的计算机中来，从而实现下载的功能。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; BT</span><span style="font-size:16px;font-family:宋体;color:black">下载实际上就是</span><span style="font-size: 16px;color:black">P2P</span><span style="font-size:16px;font-family:宋体;color:black">下载，该种下载方式与</span><span style="font-size:16px;color:black">WEB</span><span style="font-size:16px;font-family:宋体;color:black">方式正好相反，该种模式不需要服务器，而是在用户机与用户机之间进行传播，也可以说每台用户机都是服务器，讲</span> <span style="font-size:16px;font-family:宋体;color:black">究</span><span style="font-size:16px;color:black">&quot;</span><span style="font-size:16px;font-family:宋体;color:black">人人平等</span><span style="font-size:16px;color:black">&quot;</span><span style="font-size:16px;font-family:宋体;color:black">的下载模式，每台用户机在自己下载其它用户机上文件的同时，还提供被其它用户机下载的作用，所以使用该种下载方式的用户越多，其下载速度就</span> <span style="font-size:16px;font-family:宋体;color:black">会越快。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; P2SP</span><span style="font-size:16px;font-family:宋体;color:black">下载方式实际上是对</span><span style="font-size:16px;color:black">P2P</span><span style="font-size:16px;font-family:宋体;color:black">技术的进一步延伸，它不但支持</span><span style="font-size:16px;color:black">P2P</span><span style="font-size:16px;font-family:宋体;color:black">技术，同时还通过多媒体检索数据库这个桥梁把原本孤立的服务器资源和</span><span style="font-size:16px;color:black">P2P</span><span style="font-size:16px;font-family:宋体;color:black">资源整合到了一起，这样下载速度更快，同时下载资源更丰富，下载稳定性更强。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.8.3 </span><span style="font-size:16px;font-family:宋体;color:black">下载工具</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1) </span><span style="font-size:16px;font-family:宋体;color:black">使用浏览器下载</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">这是许多上网初学者常使用的方式，它操作简单方便，在浏览过程中，只要点击想下载的链接（一般是</span><span style="font-size:16px;color:black">.zip</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">.exe</span><span style="font-size:16px;font-family:宋体;color:black">之类），浏览器就会自动启动下载，只要给下载的文件找个存放路径即可正式下载了。若要保存图片，只要右击该图片，选择“图片另存为”即可。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">这种方式的下载虽然简单，但也有它的弱点，那就是不能限制速度、不支持断点续传、对于拨号上网的朋友来说下载速度也太慢。建议初上网的网友选择这种方式。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2) </span><span style="font-size:16px;font-family:宋体;color:black">使用专业软件下载</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">专业软件使用文件分切技术，就是把一个文件分成若干份同时进行下载，这样下载软件时就会感觉到比浏览器下载的快多了，更重要的是，当下载出现故障断开后，下次下载仍旧可以接着上次断开的地方下载。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3) </span><span style="font-size:16px;font-family:宋体;color:black">通过邮件下载</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">此方式可能是最省事的了，你只要向因特网上的</span><span style="font-size:16px;color:black">ftpmail</span><span style="font-size:16px;font-family:宋体;color:black">电子邮件网关服务器发送下载请求，服务器将你所需的文件邮寄到你所指定的信箱中，这样就可以像平时收信那样来获得所需的文件了。我们可以采用专业的邮件下载工具，如</span><span style="font-size:16px;color:black">Mr cool</span><span style="font-size:16px;font-family:宋体;color:black">、电邮卡车</span><span style="font-size:16px;color:black">E-mail Truck</span><span style="font-size:16px;font-family:宋体;color:black">等，只要给它一个文件下载地址和信箱，剩下的就可由它总代理了。此方式也有很多不足之处，一是由于邮件下载是有排序性的，只有将把在你之前的下载请求全部完成后，才能轮到你，这就会影响到文件的时效性；另一个就是使用</span><span style="font-size:16px;color:black">E-mail</span><span style="font-size:16px;font-family:宋体;color:black">传送文件时需要重新编码，所以收到的文件要比直接下载的大一些。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.8.4 HTTP</span><span style="font-size:16px;font-family:宋体;color:black">下载原理</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">浏览器与服务器通过</span><span style="font-size:16px;color:black">TCP/IP</span><span style="font-size:16px;font-family:宋体;color:black">协议建立</span><span style="font-size: 16px;color:black">Socket</span><span style="font-size:16px;font-family: 宋体;color:black">连接，然后通过</span><span style="font-size:16px;color:black">Socket</span><span style="font-size:16px;font-family:宋体;color:black">进行数据传输来实现下载功能。用户每次通过浏览器向服务器发送请求以及接收响应时，这个过程本身就是下载，在下载的概念定义中也说明了这一点。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; HTML</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">CSS</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">JS</span><span style="font-size:16px;font-family:宋体;color:black">、多媒体等文件也同样是通过</span><span style="font-size:16px;color:black">Socket</span><span style="font-size:16px;font-family:宋体;color:black">实现从服务器到浏览器传输。但是数据类型有很多，那么浏览器是如何处理不同数据类型的文件？这时候重点看</span><span style="font-size:16px;color:black">URL</span><span style="font-size:16px;font-family:宋体;color:black">的协议是什么，假设</span><span style="font-size:16px;color:black">URL</span><span style="font-size:16px;font-family:宋体;color:black">是以</span><span style="font-size:16px;color:black">http</span><span style="font-size:16px;font-family:宋体;color:black">打头，那么浏览器就用</span><span style="font-size:16px;color:black">http</span><span style="font-size:16px;font-family:宋体;color:black">协议解析内容。解析完毕后，浏览器根据</span><span style="font-size:16px;color:black">Content-Type</span><span style="font-size: 16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">Content-Disposition</span><span style="font-size:16px;font-family:宋体;color:black">来决定文件是显示还是下载。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">Content-Type</span><span style="font-size:16px;font-family:宋体;color:black">：指明传输文件的媒体类型。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; Content-Disposition</span><span style="font-size:16px;font-family:宋体;color:black">：此关键字可以告诉客户端如何处理我传给你的内容。</span><span style="font-size:16px;color:black">response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=</span><span style="font-size:16px;font-family: 宋体;color:black">文件名</span><span style="font-size:16px;color:black">&quot;)</span><span style="font-size:16px;font-family:宋体;color:black">。</span><span style="font-size:16px;color:black">attachment</span><span style="font-size: 16px;font-family:宋体;color:black">表示以附件方式下载。如果要在页面中打开，则改为</span><span style="font-size:16px;color:black">inline</span><span style="font-size:16px;font-family:宋体;color:black">。协议规范中标明：</span><span style="font-size:16px;color:black">disposition-type = &quot;inline&quot;/ &quot;attachment&quot;/ extension-token;&nbsp;&nbsp;&nbsp; values are not case-sensitive</span><span style="font-size:16px;font-family:宋体;color:black">。（具体可参考</span><span style="font-size: 16px;color:black">RFC 2183</span><span style="font-size:16px;font-family: 宋体;color:black">规范）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.8.5 HTTP</span><span style="font-size:16px;font-family:宋体;color:black">下载实现方式</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">目前常见的有如下两种下载方法实现：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A</span><span style="font-size:16px;font-family:宋体;color:black">）从</span><span style="font-size:16px;color:black">Response</span><span style="font-size:16px;font-family:宋体;color:black">中获取</span><span style="font-size:16px;color:black">ServletOutputStream</span><span style="font-size:16px;font-family:宋体;color:black">流，利用这个输出流可以将数据写入到客户端。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; B</span><span style="font-size:16px;font-family:宋体;color:black">）应用服务器本地生成文件，然后将请求重定向到此文件</span><span style="font-size: 16px;color:black">URL</span><span style="font-size:16px;font-family:宋体;color:black">地址，如：</span><span style="font-size:16px;color:black">response.sendRedirect(&quot;/${</span><span style="font-size:16px;font-family:宋体;color:black">上下文根</span><span style="font-size:16px;color:black">}/${</span><span style="font-size:16px;font-family:宋体;color:black">文件名</span><span style="font-size:16px;color:black">}&quot;)</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.9.14 </span><span style="font-size:16px;font-family:宋体;color:black">项目解决方案</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">语句：加上</span><span style="font-size:16px;color:black">where</span><span style="font-size:16px;font-family:宋体;color:black">条件过滤、加索引；</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、生成文件时，先在本地生成，然后再向客户端发送此文件的服务地址；定期删除文件。（可以解决多次点击下载按钮引起</span><span style="font-size:16px;color:black">socket error</span><span style="font-size:16px;font-family:宋体;color:black">）（可选）；</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">、加上</span><span style="font-size: 16px;color:black">65536</span><span style="font-size:16px;font-family:宋体;color:black">条记录判断，每</span><span style="font-size:16px;color:black">65536</span><span style="font-size:16px;font-family:宋体;color:black">条记录新建一个</span><span style="font-size:16px;color:black">sheet</span><span style="font-size:16px;font-family:宋体;color:black">（建议明确需求，根据需求决定）；</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size:16px;font-family:宋体;color:black">、建议数据量大时用</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">格式生成文件，可降低</span><span style="font-size:16px;color:black">OOM</span><span style="font-size:16px;font-family:宋体;color:black">风险（建议明确样式后，在决定。可选）；</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">、多线程访问时，日志记录混乱，可以先缓存一次输出或者每条记录加上唯一标识；</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">6</span><span style="font-size:16px;font-family:宋体;color:black">、数据库连接应增加限制，避免影响其他核心业务表的性能。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2.9.15 </span><span style="font-size:16px;font-family:宋体;color:black">大数据量下载解决方案总结</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">服务器优化：增加连接数、增加服务器内存、服务器集群、开启服务器缓存</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">数据源优化：读写分离、数据库集群、针对系统业务实现数据库（针对某个系统业务逻辑优化）、</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">优化、与业务表分离</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">应用优化：离线下载、多线程并发、独立报表应用、压缩文件、采用存储效率高的文件格式、预先下载、已下载文件临时缓存到硬盘、尽量减少数据二次处理耗时、异步处理降低阻塞时间</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">业务优化：优化业务流程、避免生成无效数据</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">其他优化：</span><span style="font-size:16px;color:black">GC</span><span style="font-size:16px;font-family:宋体;color:black">优化、实现下载客户端、采用其他协议实现下载</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><h1 style="line-height:24px"><a></a><a></a><a></a><a><span style="color:black;font-weight:normal">3 </span></a><span style="font-family:黑体;color:black;font-weight:normal">解决方案分类</span></h1><p style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">3.1 </span></a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">&nbsp;</span><span style="font-family:黑体;color:black">考虑数据量大小</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">数据量大小的定义方式：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）数据的多少：数据条数，单位为“条”</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）数据的大小：数据占用的存储空间大小，单位为“字节</span><span style="font-size:16px;color:black">byte</span><span style="font-size:16px;font-family:宋体;color:black">”</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">数据量的几个阶段：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">）数据源：涉及到的总数据量，可供查找的所有数据。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">）加工过程中的数据：实际用到的数据，比如查询出来的数据，可供进一步处理。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">）最终报表中的数据：写入报表（文件）中的数据，加工后的最终结果。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.1.1 </span><span style="font-size:16px;font-family:宋体;color:black">从数据源、总数据量上考虑</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">这个主要是一个查找、数据装载过程，也是报表系统中最耗时的阶段。从三个特殊例子来分析：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">(1) </span><span style="font-size:16px;font-family:宋体;color:black">从</span><span style="text-decoration:underline;"><span style="font-size:16px;color:black">1</span></span><span style="text-decoration:underline;"><span style="font-size:16px;font-family:宋体;color:black">千万</span></span><span style="font-size:16px;font-family:宋体;color:black">数据中查找<span style="text-decoration:underline;">一条</span>数据</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">(2) </span><span style="font-size:16px;font-family:宋体;color:black">从</span><span style="text-decoration:underline;"><span style="font-size:16px;color:black">1</span></span><span style="text-decoration:underline;"><span style="font-size:16px;font-family:宋体;color:black">万</span></span><span style="font-size:16px;font-family:宋体;color:black">数据中</span><span style="font-size:16px;color:black">Load</span><span style="font-size:16px;font-family:宋体;color:black">出全部数据。分每条数据</span><span style="font-size:16px;color:black">10 byte</span><span style="font-size:16px;font-family:宋体;color:black">和</span><span style="font-size:16px;color:black">300 byte</span><span style="font-size: 16px;font-family:宋体;color:black">两种情况。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">(3) </span><span style="font-size:16px;font-family:宋体;color:black">从</span><span style="text-decoration:underline;"><span style="font-size:16px;color:black">1</span></span><span style="text-decoration:underline;"><span style="font-size:16px;font-family:宋体;color:black">千万</span></span><span style="font-size:16px;font-family:宋体;color:black">数据中查找<span style="text-decoration:underline;">一万条</span>数据。同样，考虑到单条数据的字节数。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于</span><span style="font-size:16px;color:black">(1)</span><span style="font-size:16px;font-family:宋体;color:black">，总数据量是庞大的（</span><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">千万条），但是查找出来的数据却只有</span><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">条，这种情况主要考虑一个查找速度。如果查询很复杂，且数据量越大查询速度直线下降或者成对数型下降，那么这个数据量就是需要我们重点考虑的问题了。但是通常情况下，比较成熟的数据库，利用索引等技术，查询速度是非常快的。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">结论：总数据量对于查找速度的影响，取决于查找所使用的算法。我们可以根据实际效果去确认。下面我给出了一个实例供参考：</span></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">案例一</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">--- Oracle10g</span></i><i><span style=";font-family:黑体;color:black">远程数据库，b2b_ticket_stat表，共2200W数据</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---select * from b2b_olap.b2b_ticket_stat t where t.rec_no=&#39;RN201301200012462338&#39;;</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">其中rec_no字段上加有普通索引，P/SQL上显示耗时是0.265秒。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">可见，数据总量是很大的，但是对查询速度的影响较小。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">案例二</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">--- Oracle10g</span></i><i><span style=";font-family:黑体;color:black">远程数据库，report _task表，共7W数据</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i> <i><span style=";font-family:黑体;color:black">select * from report_task t where t.tcode=&#39;HEAABC&#39;;</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">其中tcode字段无索引，耗时29.546秒。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">可见，查询速度很慢，数据总量对查询速度影响大，如果数据有2000W的话，耗时将无法忍受。</span></i></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于</span><span style="font-size:16px;color:black">(2)</span><span style="font-size:16px;font-family:宋体;color:black">，撇开查询的时间不计，重点考虑数据的装载速度，即“将数据从一个地方，复制到另一个地方”，这个速度和数据的大小（字节）有关。也就是说，传输</span><span style="font-size:16px;color:black">10 byte</span><span style="font-size:16px;font-family:宋体;color:black">的数据和传输</span><span style="font-size:16px;color:black">300 byte</span><span style="font-size:16px;font-family:宋体;color:black">的数据，耗时是不一样的，而且差别比较明显。另外，从文件中读取数据和从远程数据库中读取数据，速度也是不一样的，文件读取的速度是非常快的。但是一般我们考虑从数据库中读取数据，我做了一个实验：</span></p><p style="text-align:center;line-height:27px"><span style=";font-family:宋体;color:black">表</span><span style=";color:black">3.1 </span><span style=";font-family:宋体;color:black">从数据库中装载不同大小的数据的速度</span></p><table><tbody><tr class="firstRow"><td width="130" style="border: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">读取的记录总数</span></p></td><td width="161" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">单条记录的大小（</span>byte<span style="font-family:宋体">）</span></p></td><td width="125" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px">SQL</p></td><td width="139" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="font-family:宋体">耗时（毫秒</span>ms<span style="font-family:宋体">）</span></p><p style="text-align:center;line-height:29px">fentchSize 10 / 200</p></td></tr><tr><td width="130" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">151</p></td><td width="161" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">70</p></td><td width="125" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center">select &nbsp; * from tvb2b_office t</p></td><td width="139" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">1700 / &nbsp; 950</span></p></td></tr><tr><td width="130" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">1943</p></td><td width="161" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">70</p></td><td width="125" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center">select &nbsp; * from hob2b_office t</p></td><td width="139" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">10230 / &nbsp; 1540</span></p></td></tr><tr><td width="130" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">149</p></td><td width="161" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">350</p></td><td width="125" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center">select &nbsp; * from b2b_ticket_stat t where t.tkt_rcd_dt=?</p></td><td width="139" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">2181</span></p></td></tr><tr><td width="130" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">1231</p></td><td width="161" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center;line-height:29px">350</p></td><td width="125" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; background: rgb(182, 221, 232); padding: 0px 7px;"><p style="text-align:center">select &nbsp; * from b2b_ticket_stat t where t.tkt_rcd_dt=?</p></td><td width="139" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-align:center;line-height:29px"><span style="color:#4F81BD">7454</span></p></td></tr></tbody></table><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">可见，装载的数据字节数越大，耗时就越久，增幅不大，但是也不小，为比较平稳的线程增长，但是积累一定量之后，差距也是非常明显的，正所谓量变引起质变。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">总结：数据的大小（字节）是影响数据装载的关键因素，数据记录越多、单条数据</span><span style="font-size:16px;color:black">byte</span><span style="font-size:16px;font-family:宋体;color:black">越大，装载数据的时间就越慢。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于</span><span style="font-size:16px;color:black">(3)</span><span style="font-size:16px;font-family:宋体;color:black">，既要考虑查询速度，又要考虑数据装载速度（主要是网络数据的传输速度）。假设在查询速度很快的情况下，那么主要就是一个数据大小的问题。假如查询出来的数据本身并不大，但是对查询速度要求较高，那就要考虑查找算法和总数据记录多少的问题。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.1.2 </span><span style="font-size:16px;font-family:宋体;color:black">考虑加工过程中的数据量</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">加工中的数据的多少，对于数据处理速度的影响，这个往往取决于具体的处理逻辑。如果处理逻辑很复杂、耗时，那么数据越多，耗时越明显。反之，如果处理逻辑很简单、处理速度很快，那么数据即使很多，耗时也不是很明显。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">总结：针对数据处理的复杂度，来考虑加工中的数据量。下面举一个实际的例子供参考：</span></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">案例一</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">业务要求：查询出指定订单，封装到LIST&lt;VO&gt;中，传送到另一个地方，然后再对这些数据进行遍历和处理，处理过程比较复杂，涉及到内部的遍历、排序和查找。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">特点：加工中数据的多少，对整个流程的整体耗时影响较大，且如果加工中的数据过多，还有造成JVM内存溢出的风险。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">案例二</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">业务要求：查询出指定订单，然后经过简单的格式处理，直接生成TXT报表</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">---</span></i><i><span style=";font-family:黑体;color:black">特点：加工简单，一个while循环，数据量再多，加工的时间也很短，故此处无需考虑加工中数据量的大小。</span></i></p><p style="line-height:27px"><i><span style=";font-family:黑体;color:black">&nbsp;</span></i></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.1.3 </span><span style="font-size:16px;font-family:宋体;color:black">考虑最终报表中的数据量</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">直观上讲，考虑“最终报表中的数据量的级别”，数据条数是“</span><span style="font-size:16px;color:black">100+</span><span style="font-size:16px;font-family:宋体;color:black">”、“</span><span style="font-size: 16px;color:black">1W+</span><span style="font-size:16px;font-family:宋体;color:black">”还是“</span><span style="font-size:16px;color:black">100W+</span><span style="font-size:16px;font-family:宋体;color:black">”，或者数据字节数，是“</span><span style="font-size:16px;color:black">1KB+</span><span style="font-size:16px;font-family:宋体;color:black">”、“</span><span style="font-size:16px;color:black">1MB+</span><span style="font-size:16px;font-family:宋体;color:black">”还是“</span><span style="font-size:16px;color:black">100MB+</span><span style="font-size:16px;font-family:宋体;color:black">”。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">例如，我要做一个报表，就要考虑单个报表可能达到的最大数据量有多少，如果只是一个“汇总统计表”，数据条数在</span><span style="font-size:16px;color:black">1000</span><span style="font-size:16px;font-family:宋体;color:black">行以内，那么表现层上，可以使用</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">等格式都可以。如果有个“订单明细表”，假设数据条数可以到达“</span><span style="font-size:16px;color:black">100W</span><span style="font-size:16px;font-family:宋体;color:black">”条，数据字节数可以达到“</span><span style="font-size:16px;color:black">300MB</span><span style="font-size:16px;font-family:宋体;color:black">”，那么就要考虑用</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">格式，甚至文件分割等方式了。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">3.2&nbsp; </span></a><span style="font-family:黑体;color:black">考虑表现方式</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">大量的数据存储或展示必须要考虑到文件存储格式，这样就引出了两个大问题：以何种方式存储？如何保存？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">上述两个问题看似简单实则有深意。我们可以把问题转化为下述几个问题：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span><span style="font-size:16px;font-family:宋体;color:black">、数据存储什么样的格式便于数据分析、处理？（结合上述特点决定）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2</span><span style="font-size:16px;font-family:宋体;color:black">、大量数据处理非常消耗内存，如何避免内存溢出？（少用对象，多用字符串，能及时释放内存。一般采用</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">格式解决）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3</span><span style="font-size:16px;font-family:宋体;color:black">、当前格式的文件限制条件是什么？（上述特点描述中有答案）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4</span><span style="font-size:16px;font-family:宋体;color:black">、如何降低文件大小利用有限的宽带进行传输？（压缩）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5</span><span style="font-size:16px;font-family:宋体;color:black">、超过当前文件限制的大小后如何处理？（文件切割打包，</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">et</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">创建多个</span><span style="font-size:16px;color:black">sheet</span><span style="font-size:16px;font-family:宋体;color:black">）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.2.1</span><span style="font-size:16px;font-family:宋体;color:black">文件分类</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">我们常常把文件分成两种类型，一种是表格文件，另一种是图形文件。下面是列举的常见文件格式：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">常用的表格文件格式：</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">et</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">（适合大量的数据存储）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">常用的图形文件：</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">jbpg</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">png</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">bmp</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">gif</span><span style="font-size:16px;font-family:宋体;color:black">（渲染图片时非常消耗内存，不适合大量数据存储，只适合统计结果展示）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.2.2 </span><span style="font-size:16px;font-family:宋体;color:black">如何决定存储格式</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span><span style="font-size:16px;font-family:宋体;color:black">、要考虑用户的使用方式，首先判断是否有浏览需求；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2</span><span style="font-size:16px;font-family:宋体;color:black">、如果不需要浏览，只是用来保存或者分析，建议采用专业的数据存储文件存储，如数据库备份文件；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3</span><span style="font-size:16px;font-family:宋体;color:black">、如果需要浏览，那么需要考虑采用什么方式浏览，一般有三个方案：</span></p><p style="margin-left:28px;text-indent:0;line-height:27px"><span style="font-size:9px;font-family:Wingdings;color:black">l<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">操作系统内置软件浏览</span></p><p style="margin-left:28px;text-indent:0;line-height:27px"><span style="font-size:9px;font-family:Wingdings;color:black">l<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">需要安装软件进行浏览</span></p><p style="margin-left:28px;text-align:left;text-indent:0;line-height:27px"><span style="font-size:9px;font-family:Wingdings;color:black">l<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">需要提供特有的界面进行浏览</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4</span><span style="font-size:16px;font-family:宋体;color:black">、结合各类表格文件特点来决定采用何种格式存储，详见</span><span style="font-size: 16px;color:black">3.2.3</span><span style="font-size:16px;font-family:宋体;color:black">章节。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.2.3</span><span style="font-size:16px;font-family:宋体;color:black">各类表格文件特点</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">et</span><span style="font-size:16px;font-family:宋体;color:black">格式研究：初始大小</span><span style="font-size:16px;color:black">7KB</span><span style="font-size:16px;font-family:宋体;color:black">，增量为</span><span style="font-size: 16px;color:black">0.5KB</span><span style="font-size:16px;font-family:宋体;color:black">。存储相同值是存储一次</span><span style="font-size:16px;color:black">+</span><span style="font-size:16px;font-family:宋体;color:black">引用方式，而非多次存储相同值。需要注意的是即使采用此文件每个单元格都存储相同的值也比不上</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">文本格式存储利用率，因为每增加一个单元格会消耗大于“相同值引用”的开销，即占用更多的存储空间。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; csv</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">有多少字符就占用多少字节，中文两字节，英文一字节。如</span><span style="font-size:16px;color:black">8192</span><span style="font-size:16px;font-family:宋体;color:black">字节存储到</span><span style="font-size: 16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">文本中，则</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">文本大小为</span><span style="font-size:16px;color:black">8kB</span><span style="font-size:16px;font-family:宋体;color:black">，如果是存储为</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">可能就是十几</span><span style="font-size:16px;color:black">kB</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">事实上</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">et</span><span style="font-size:16px;font-family:宋体;color:black">的本质都是</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;color:black">TXT</span><span style="font-size:16px;font-family:宋体;color:black">存储规则</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">　　有多少字节就占用多大的空间。一般情况下采用字符串拼接方式进行存储，占用内存低，可及时</span><span style="font-size:16px;color:black">flush</span><span style="font-size:16px;font-family:宋体;color:black">清除内存，降低内存占用。</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">　　限制条件：无样式、字符串拼接较为复杂、阅读困难</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">　　优点：不需要安装软件即可打开、空间利用率最高、只有存储空间大小限制</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">使用场景：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">、不需要样式；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size: 16px;font-family:宋体;color:black">、存储利用率最高；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size: 16px;font-family:宋体;color:black">、占用内存最少；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size: 16px;font-family:宋体;color:black">、不采用逗号分隔（</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">格式是采用逗号分隔）</span></p><p style="line-height:27px">　</p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;color:black">CSV</span><span style="font-size:16px;font-family:宋体;color:black">存储规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">限制条件：无样式、字符串拼接较为复杂</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">优点：不需要安装软件即可打开、空间利用率高、只有存储空间大小限制、用</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">软件打开方便浏览（但有</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">版本限制）、占用内存低</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">使用场景：</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、不需要样式；</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、存储利用率最高；</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">、占用内存最少；</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size:16px;font-family:宋体;color:black">、用户用</span><span style="font-size: 16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">软件浏览（存在问题是：超过指定</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">版本限制后，可以继续存储，但是用</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">软件打开只能显示前</span><span style="font-size:16px;color:black">65536</span><span style="font-size:16px;font-family:宋体;color:black">行或者</span><span style="font-size:16px;color:black">1,048,576 </span><span style="font-size:16px;font-family:宋体;color:black">行，无法分</span><span style="font-size:16px;color:black">sheet</span><span style="font-size:16px;font-family:宋体;color:black">）。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;color:black">XML</span><span style="font-size:16px;font-family:宋体;color:black">存储规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">限制条件：需要第三方软件或者自主实现来展现样式，占用无效字节多；</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">优点：易于第三方系统读取数据、跨数据交互平台、表现出复杂的数据结构、只有存储空间大小限制</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">使用场景：需要存储复杂的数据结构，需要后期数据处理，跨平台传输，已有样式实现的系统。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">备注：如果需要表现复杂数据结构，且存储利用率最高，可采用</span><span style="font-size:16px;color:black">json</span><span style="font-size:16px;font-family:宋体;color:black">存储为</span><span style="font-size: 16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">实现。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;color:black">HTML</span><span style="font-size:16px;font-family:宋体;color:black">存储规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">限制条件：占用字节多；不利于第三方系统读取数据、</span><span style="font-size: 16px;color:black">HTML</span><span style="font-size:16px;font-family:宋体;color:black">格式复杂</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">优点：已实现丰富的样式、可存储复杂的数据结构、可用</span><span style="font-size: 16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">应用程序展示、可及时释放内存。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">使用场景：采用第三方</span><span style="font-size:16px;color:black">jar</span><span style="font-size:16px;font-family:宋体;color:black">生成</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family:宋体;color:black">文件时内存溢出；用户需要用浏览器浏览；需要展现丰富的样式。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;color:black">XLS /ET</span><span style="font-size:16px;font-family:宋体;color:black">存储规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">限制条件：需要安装</span><span style="font-size:16px;color:black">WPS</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">Microsoft Office</span><span style="font-size:16px;font-family:宋体;color:black">；学习成本高开发复杂；占用内存较高；工作表大小</span> <span style="font-size:16px;font-family:宋体;color:black">支持</span><span style="font-size:16px;color:black">65,536 </span><span style="font-size:16px;font-family:宋体;color:black">行乘以</span><span style="font-size:16px;color:black"> 256 </span><span style="font-size:16px;font-family:宋体;color:black">列（超过时无法存储）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">优点：样式丰富，易于阅读</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">使用场景：样式较复杂时，样式部分可用宏命令（</span><span style="font-size: 16px;color:black">VBA</span><span style="font-size:16px;font-family:宋体;color:black">）在</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">中实现；用户安装</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">软件；需要用</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">进行数据处理（这部分服务完全可以交给应用解决，降低人工成本）；用户习惯用</span><span style="font-size:16px;color:black">Excel</span><span style="font-size:16px;font-family:宋体;color:black">浏览、保存。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">备注：</span><span style="font-size:16px;color:black">POI</span><span style="font-size:16px;font-family:宋体;color:black">的低版本</span><span style="font-size:16px;color:black">jar</span><span style="font-size:16px;font-family:宋体;color:black">包占用内存较高，无法及时释放内存，数据量较大时易出现内存溢出。</span><span style="font-size:16px;color:black">3.9</span><span style="font-size:16px;font-family:宋体;color:black">版本采用新对象解决。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">支持软件：</span><span style="font-size:16px;color:black">Jakarta POI</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">JExcelApi</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;color:black">XLSX</span><span style="font-size:16px;font-family:宋体;color:black">存储规则</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">限制条件：需要安装</span><span style="font-size:16px;color:black">WPS</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">Microsoft Office</span><span style="font-size:16px;font-family:宋体;color:black">（</span><span style="font-size:16px;color:black">2007</span><span style="font-size:16px;font-family:宋体;color:black">及其以上版本）；采用特殊</span><span style="font-size:16px;color:black">Jar</span><span style="font-size:16px;font-family:宋体;color:black">包开发需要学习成本；占用内存较高；工作表大小</span><span style="font-size:16px;color:black">1,048,576 </span><span style="font-size: 16px;font-family:宋体;color:black">行乘以</span><span style="font-size: 16px;color:black"> 16,384 </span><span style="font-size:16px;font-family: 宋体;color:black">列</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">优点：样式丰富，易于阅读，便于保存</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">使用场景：用户使用</span><span style="font-size:16px;color:black">2007</span><span style="font-size:16px;font-family:宋体;color:black">版本及其以上版本的</span><span style="font-size:16px;color:black">WPS</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">Microsoft Office</span><span style="font-size:16px;font-family:宋体;color:black">进行浏览；工作表大小</span><span style="font-size:16px;color:black">&gt;65536 </span><span style="font-size:16px;font-family:宋体;color:black">行乘以</span><span style="font-size:16px;color:black">256 </span><span style="font-size:16px;font-family:宋体;color:black">列；一个工作簿中需要支持</span><span style="font-size:16px;color:black">&gt;4000</span><span style="font-size:16px;font-family:宋体;color:black">且</span><span style="font-size:16px;color:black">&lt;64000</span><span style="font-size: 16px;font-family:宋体;color:black">种的样式种类。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">附：</span><span style="font-size:16px;color:black">Microsoft. Office</span><span style="font-size:16px;font-family:宋体;color:black">版本限制简要说明</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2007/2010</span><span style="font-size:16px;font-family:宋体;color:black">版</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">工作表大小</span><span style="font-size: 16px;color:black">1,048,576 </span><span style="font-size:16px;font-family: 宋体;color:black">行乘以</span><span style="font-size:16px;color:black"> 16,384 </span><span style="font-size:16px;font-family:宋体;color:black">列</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">单元格可以包含的字符总数</span><span style="font-size:16px;color:black">32,767 </span><span style="font-size:16px;font-family:宋体;color:black">个字符</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">工作簿中定义的单元格样式种类</span><span style="font-size:16px;color:black">64,000</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2003</span><span style="font-size:16px;font-family:宋体;color:black">版</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">工作表大小</span><span style="font-size: 16px;color:black"> 65,536 </span><span style="font-size:16px;font-family: 宋体;color:black">行乘以</span><span style="font-size:16px;color:black"> 256 </span><span style="font-size:16px;font-family:宋体;color:black">列</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">单元格内容长度</span><span style="font-size: 16px;color:black"> 32,767 </span><span style="font-size:16px;font-family: 宋体;color:black">个字符</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">工作簿中定义的单元格样式种类</span><span style="font-size:16px;color:black"> 4,000</span></p><p style="line-height:27px"><span style="font-size:16px;font-family:宋体;color:black">以上内容可到微软官网中参考：</span></p><p style="text-indent:19px">2010<span style=";font-family:宋体">版本：</span><a href="http://office.microsoft.com/zh-cn/excel-help/HP010342495.aspx#BMworksheetworkbook">http://office.microsoft.com/zh-cn/excel-help/HP010342495.aspx#BMworksheetworkbook</a></p><p style="text-indent:19px">2007<span style=";font-family:宋体">版本：</span><a href="http://office.microsoft.com/zh-cn/excel-help/HP010073849.aspx%EF%BC%882007%EF%BC%89">http://office.microsoft.com/zh-cn/excel-help/HP010073849.aspx<span style="font-family:宋体">（</span>2007<span style="font-family:宋体">）</span></a></p><p style="text-indent:19px">2003<span style=";font-family:宋体">版本：</span><a href="http://office.microsoft.com/zh-cn/excel-help/HP005199291.aspx%EF%BC%882003%EF%BC%89">http://office.microsoft.com/zh-cn/excel-help/HP005199291.aspx<span style="font-family:宋体">（</span>2003<span style="font-family:宋体">）</span></a></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.2.4</span><span style="font-size:16px;font-family: 宋体;color:black">问题结论</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">、数据存储什么样的格式便于数据分析、处理？</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">答：结合上述特点决定。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">、大量数据处理非常消耗内存，如何避免内存溢出？</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">答：少用对象，多用字符串，能及时释放内存。一般采用</span><span style="font-size:16px;color:black">html</span><span style="font-size:16px;font-family: 宋体;color:black">、</span><span style="font-size:16px;color:black">xml</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">格式解决。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">、当前格式的文件限制条件是什么？</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">答：上述特点描述中有答案。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size:16px;font-family:宋体;color:black">、如何降低文件大小利用有限的宽带进行传输？</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">答：压缩。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">、超过当前文件存储限制的大小如何处理？</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">答：文件切割打包，</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">et</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">xlsx</span><span style="font-size:16px;font-family: 宋体;color:black">创建多个</span><span style="font-size:16px;color:black">sheet</span><span style="font-size:16px;font-family: 宋体;color:black">。</span></p><p style="text-indent:19px;line-height:27px"><span style="font-size:16px;color:black">6</span><span style="font-size:16px;font-family:宋体;color:black">、该文件的第三方软件支持？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">答：如无特殊要求，尽量用业界通用的</span><span style="font-size:16px;color:black">xls</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size: 16px;color:black">csv</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">txt</span><span style="font-size:16px;font-family:宋体;color:black">等通用格式。</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">3.3&nbsp; </span></a><span style="font-family:黑体;color:black">工具插件的选择</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">市场上有各类的报表开发工具，本文就从以下五个方面进行比较，方便大家选择理想的开发工具：基本功能、协议、支持条件、二次开发、学习成本、第三方软件支持、性能（未经过实践）、使用说明文档。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">3.3.1 </span><span style="font-size:16px;font-family:宋体">各类报表简介</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">1</span><span style="font-size:16px;font-family:宋体">）</span><span style="font-size:16px">DynamicJasper</span><span style="font-size:16px;font-family:宋体">（原名</span><span style="font-size:16px">JasperReport</span><span style="font-size:16px;font-family:宋体">，开源软件</span><span style="font-size:16px">License</span><span style="font-size:16px;font-family:宋体">：</span><span style="font-size:16px">LGPL v2</span><span style="font-size:16px;font-family:宋体">）</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体">支持的功能：</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">运行时定义列</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">自动报表布局</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持动态交叉表</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">嵌套子报表</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">丰富灵活的样式</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持图标</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持变量</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持多种文件格式导出（</span><span style="font-size:16px">PDF, XML, HTML, CSV, XLS, RTF, TXT</span><span style="font-size:16px;font-family:宋体">）</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持框架集成（</span><span style="font-size:16px">Struts2</span><span style="font-size:16px;font-family:宋体">、</span><span style="font-size:16px">WebWork</span><span style="font-size:16px;font-family:宋体">、</span><span style="font-size:16px">Grails</span><span style="font-size:16px;font-family: 宋体">）</span></p><p style="text-indent:28px;line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">提供专业的支持</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体">支持的条件：</span><span style="font-size:16px">JDK1.5</span><span style="font-size:16px;font-family: 宋体">及其以上。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体">学习成本：有丰富的使用群体，提供详细的使用文档，学习成本低。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体">二次开发：已提供源码，采用</span><span style="font-size:16px">LGPL</span><span style="font-size:16px;font-family: 宋体">协议，如果要修改</span><span style="font-size:16px">LGPL</span><span style="font-size:16px;font-family:宋体">协议的代码，则涉及修改部分的额外代码和衍生的代码都必须采用</span><span style="font-size:16px">LGPL</span><span style="font-size:16px;font-family: 宋体">协议。因此</span><span style="font-size:16px">LGPL</span><span style="font-size:16px;font-family:宋体">不适合以</span><span style="font-size:16px">LGPL</span><span style="font-size:16px;font-family:宋体">协议代码为基础进行二次开发的商业软件。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体">后续支持：稳定，有团体维护。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体">第三方软件支持</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iReport</span><span style="font-size:16px;font-family:宋体">：独立的报表设计器</span><span style="font-size:16px">IDE</span><span style="font-size:16px;font-family: 宋体">。</span><span style="font-size:16px">iReport</span><span style="font-size:16px;font-family:宋体">是为</span><span style="font-size:16px">JasperReports</span><span style="font-size:16px;font-family:宋体">设计的强大的，直观的，易于使用的可视化报表设计器采用纯</span><span style="font-size:16px">Java</span><span style="font-size:16px;font-family:宋体">开发。这个工具允许用户可视化编辑包含</span><span style="font-size: 16px">charts,</span><span style="font-size:16px;font-family:宋体">图片</span><span style="font-size:16px">,</span><span style="font-size:16px;font-family:宋体">子报表等的复杂报表。</span><span style="font-size:16px">iReport </span><span style="font-size:16px;font-family:宋体">还集成了</span><span style="font-size:16px">JFreeChart</span><span style="font-size:16px;font-family:宋体">图表制作包。允许用户可视化地编辑</span><span style="font-size: 16px">XML JasperDesign</span><span style="font-size:16px;font-family:宋体">文件。用于打印的数据可以通过多种方式获取包括：</span><span style="font-size:16px">JDBC, TableModels, JavaBeans, XML,Hibernate(</span><span style="font-size:16px;font-family:宋体">支持</span><span style="font-size:16px">HQL</span><span style="font-size:16px;font-family:宋体">查询语言</span><span style="font-size:16px">), CSV</span><span style="font-size:16px;font-family:宋体">等。它支持多种输出格式包括：</span><span style="font-size:16px">PDF,RTF,XML,XLS,CSV,HTM</span><span style="font-size: 16px;font-family:宋体">。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JasperReports Library</span><span style="font-size:16px;font-family:宋体">：</span><span style="font-size:16px">JasperReports</span><span style="font-size: 16px;font-family:宋体">开源库，扔到应用</span><span style="font-size:16px">Lib</span><span style="font-size:16px;font-family:宋体">中可以使用</span><span style="font-size:16px">Report</span><span style="font-size:16px;font-family: 宋体">。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JasperReport Server</span><span style="font-size:16px;font-family:宋体">：服务引擎（如果是自己建立的项目来实现报表展示，可不采用本服务）</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JasperReports ETL</span><span style="font-size:16px;font-family:宋体">：提供数据提取、转换、加载服务，可用于</span><span style="font-size:16px">BI</span><span style="font-size:16px;font-family:宋体">。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JasperAssistant 3.1.1</span><span style="font-size:16px;font-family:宋体">（</span><span style="font-size:16px">Commercial</span><span style="font-size: 16px;font-family:宋体">）（</span><span style="font-size:16px">JasperReports</span><span style="font-size:16px;font-family:宋体">的可视化报表设计器）：采用</span><span style="font-size:16px">Eclipse</span><span style="font-size:16px;font-family:宋体">插件集成到</span><span style="font-size:16px">eclipse</span><span style="font-size:16px;font-family:宋体">中，可试用</span><span style="font-size:16px">21</span><span style="font-size:16px;font-family: 宋体">天。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SWTJasperViewer</span><span style="font-size:16px;font-family:宋体">是一个专门为基于</span><span style="font-size:16px">SWT/JFace</span><span style="font-size:16px;font-family:宋体">应用程序与</span><span style="font-size:16px">Eclipse</span><span style="font-size:16px;font-family:宋体">插件开发的</span><span style="font-size:16px">JasperReports</span><span style="font-size:16px;font-family:宋体">报表查看组件。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Jasper4Flex</span><span style="font-size:16px;font-family:宋体">是</span><span style="font-size:16px">JasperReports</span><span style="font-size:16px;font-family:宋体">的一个插件，它利用</span><span style="font-size:16px">Adobe</span><span style="font-size:16px;font-family:宋体">的</span><span style="font-size:16px">Flex SDK</span><span style="font-size:16px;font-family:宋体">把</span><span style="font-size:16px">JasperReports</span><span style="font-size:16px;font-family:宋体">生成的文档导成</span><span style="font-size:16px">Flash</span><span style="font-size:16px;font-family: 宋体">格式。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DynamicJasper</span><span style="font-size:16px;font-family:宋体">提供了一套高级</span><span style="font-size:16px">API</span><span style="font-size:16px;font-family: 宋体">用于隐藏</span><span style="font-size:16px">Jasper Reports</span><span style="font-size:16px;font-family:宋体">的复杂性。能够帮助开发人员节省设计简单或比较复杂报表所需要发费的时间。能够动态创建报表、在运行期定义字段，字段宽度，分组等。动态列报表：可以定义列在运行时，这也意味着你在运行时控制列的位置，宽度，标题，等。支持多组</span><span style="font-size:16px">/</span><span style="font-size:16px;font-family:宋体">分组，支持报表自动布局，支持动态交叉表，支持嵌套子报表，支持灵活的样式等等，具体可到官网了解：</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http://dynamicjasper.com/features/</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">2</span><span style="font-size:16px;font-family:宋体">）</span><span style="font-size:16px">BIRT</span><span style="font-size:16px;font-family:宋体">（</span><span style="font-size:16px">License:EPL</span><span style="font-size:16px;font-family:宋体">，</span><span style="font-size:16px">http://www.eclipse.org/birt/phoenix/</span><span style="font-size:16px;font-family:宋体">）</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BIRT</span><span style="font-size:16px;font-family:宋体">是一个</span><span style="font-size:16px">Eclipse-based</span><span style="font-size:16px;font-family:宋体">开放源代码报表系统。它主要是用在基于</span><span style="font-size: 16px">Java</span><span style="font-size:16px;font-family:宋体">与</span><span style="font-size:16px">J2EE</span><span style="font-size:16px;font-family:宋体">的</span><span style="font-size:16px">Web</span><span style="font-size:16px;font-family:宋体">应用程序上。</span><span style="font-size:16px">BIRT</span><span style="font-size:16px;font-family: 宋体">主要由两部分组成：一个是基于</span><span style="font-size:16px">Eclipse</span><span style="font-size:16px;font-family:宋体">的报表设计和一个可以加到你应用服务的运行期组件。</span><span style="font-size:16px">BIRT</span><span style="font-size:16px;font-family: 宋体">同时也提供一个图形报表制作引擎。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体">支持的功能：</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">独立的客户端、</span><span style="font-size:16px">Eclipse</span><span style="font-size:16px;font-family:宋体">插件开发</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">样式采用</span><span style="font-size:16px">CSS</span><span style="font-size:16px;font-family: 宋体">规则解析，免去高成本学习麻烦。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持报表中复杂的计算规则</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持多数据源</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">有</span><span style="font-size:16px">GUI</span><span style="font-size:16px;font-family: 宋体">报表设计器，界面友好，支持拖拽。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">在统计汇总上</span><span style="font-size:16px">BIRT</span><span style="font-size:16px;font-family: 宋体">使用有一些小问题。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">易于开发，开发效率高</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">灵活的数据定制功能：支持动态参数查询、数据过滤器</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持</span><span style="font-size:16px">JavaScript</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; BIRT</span><span style="font-size:16px;font-family:宋体">可扩展性好</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">支持复杂的报表设计</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体">支持条件：</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BIRT 4.3</span><span style="font-size:16px;font-family:宋体">版：开发运行需</span><span style="font-size:16px">1.6 JDK/JRE</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BIRT 3.7</span><span style="font-size:16px;font-family:宋体">版：开发运行需</span><span style="font-size:16px">1.5 JDK/JRE</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体">二次开发：提供了完整的</span><span style="font-size:16px">API</span><span style="font-size:16px;font-family: 宋体">文档，易于开发；且有源代码支持。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体">后续支持：稳定更新升级</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体">学习成本：知识点较多，学习成本稍高。有全面详细的使用文档，详细的开发指导、集成部署说明、开发样例、</span><span style="font-size:16px">Birt</span><span style="font-size:16px;font-family:宋体">书籍（英文版），有丰富的使用群体</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体">扩展功能：</span><span style="font-size:16px">Open Data Access (ODA) Extension API</span><span style="font-size:16px;font-family:宋体">、</span><span style="font-size:16px">Report Item Extension API </span><span style="font-size:16px;font-family:宋体">。（即支持其他数据源扩展，支持新报表类型扩展）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">）</span><span style="font-size:16px;color:black">OpenReports (License:GPL V2</span><span style="font-size: 16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">http://oreports.com/)</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OpenReports</span><span style="font-size:16px;font-family:宋体;color:black">是一个功能强大、灵活、易于使用的，开放源码的，基于浏览器的</span><span style="font-size:16px;color:black">Web</span><span style="font-size:16px;font-family:宋体;color:black">报表解决方案，它提供了动态报表生成和灵活的报表调度能力。</span><span style="font-size:16px;color:black">OpenReports</span><span style="font-size:16px;font-family:宋体;color:black">支持各种开源报表引擎，包括</span><span style="font-size:16px;color:black">JasperReports</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">JFreeReport</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">JXLS</span><span style="font-size:16px;font-family: 宋体;color:black">和</span><span style="font-size:16px;color:black">Eclipse BIRT</span><span style="font-size:16px;font-family:宋体;color:black">。</span><span style="font-size:16px;color:black">OpenReports</span><span style="font-size:16px;font-family:宋体;color:black">还包括</span><span style="font-size:16px;color:black">QueryReports</span><span style="font-size:16px;font-family:宋体;color:black">，和</span><span style="font-size:16px;color:black">ChartReports</span><span style="font-size:16px;font-family:宋体;color:black">的，不需要预定义的报表定义即可轻松地创建基于</span><span style="font-size:16px;color:black">SQL</span><span style="font-size:16px;font-family:宋体;color:black">的报表。此外，</span><span style="font-size:16px;color:black">OpenReports</span><span style="font-size:16px;font-family:宋体;color:black">现在通过</span><span style="font-size:16px;color:black">Mondrian</span><span style="font-size:16px;font-family: 宋体;color:black">（</span><span style="font-size:16px;color:black">OLAP</span><span style="font-size:16px;font-family: 宋体;color:black">服务器）和</span><span style="font-size:16px;color:black">JPivot</span><span style="font-size:16px;font-family: 宋体;color:black">（</span><span style="font-size:16px;color:black">JSP </span><span style="font-size:16px;font-family: 宋体;color:black">自定制的标签库，可以绘制</span><span style="font-size:16px;color:black">OLAP</span><span style="font-size:16px;font-family: 宋体;color:black">表格和图表）支持</span><span style="font-size:16px;color:black">OLAP</span><span style="font-size:16px;font-family: 宋体;color:black">。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">以</span><span style="font-size:16px;color:black">WAR</span><span style="font-size:16px;font-family:宋体;color:black">包部署应用服务器运行，在浏览器中可管理报表集合、用户组、浏览系统运行状态、系统配置。优点是可在本源码的基础上改造为一个新项目。本项目遵循</span><span style="font-size:16px;color:black">GPL</span><span style="font-size:16px;font-family:宋体;color:black">协议，建议不要商业化，可在内部使用。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">支持的功能</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">支持多种导出格式，包括</span><span style="font-size:16px;color:black">PDF</span><span style="font-size:16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">HTML</span><span style="font-size:16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">CSV</span><span style="font-size:16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">XLS</span><span style="font-size:16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">RTF</span><span style="font-size:16px;font-family:宋体;color:black">，和图像。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">基于</span><span style="font-size:16px;color:black">Web</span><span style="font-size:16px;font-family:宋体;color:black">管理用户、组、报表、参数和数据源。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">灵活的调度，包括每小时、每日、每周、每月和的</span><span style="font-size:16px;color:black">cron</span><span style="font-size:16px;font-family:宋体;color:black">调度和多个收件人。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">完整的报表参数支持，包括日期、文字、列表、查询和布尔参数。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">细粒度的安全控制访问报表、调度和管理功能。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">报表审计轨迹开始时间，持续时间，状态，用户的每一个生成的报告。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">支持多个</span><span style="font-size:16px;color:black">JNDI</span><span style="font-size:16px;font-family:宋体;color:black">或使用连接池的数据源生成报告。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">支持向下钻取报表和外部应用程序集成。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">缺点：</span><span style="font-size:16px;color:black">GUI</span><span style="font-size:16px;font-family:宋体;color:black">非常简单，不支持报表内计算，样式定义复杂（通过</span><span style="font-size:16px;color:black">XML</span><span style="font-size:16px;font-family:宋体;color:black">描述样式，不如可视化效率高），不支持分组，使用群体少</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">二次开发：已提供源码，</span><span style="font-size:16px;color:black">license</span><span style="font-size:16px;font-family: 宋体;color:black">为</span><span style="font-size:16px;color:black">GPLv2</span><span style="font-size:16px;font-family: 宋体;color:black">，可以自由修改软件。需要注意的是任何软件使用</span><span style="font-size:16px;color:black">FreeReportBuilder</span><span style="font-size:16px;font-family:宋体;color:black">开发后，该软件的发布协议必须是</span><span style="font-size:16px;color:black">GPL</span><span style="font-size:16px;font-family:宋体;color:black">协议，即发布时需要开源自己软件的代码。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">支持条件：</span><span style="font-size:16px;color:black">JDK1.5</span><span style="font-size:16px;font-family: 宋体;color:black">及其以上</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">学习成本：有详细的使用文档，使用群体少。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">技术框架：</span><span style="font-size:16px;color:black">Servlet/JSP</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">Spring</span><span style="font-size:16px;font-family: 宋体;color:black">、</span><span style="font-size:16px;color:black">Hibernate</span><span style="font-size:16px;font-family: 宋体;color:black">、</span><span style="font-size:16px;color:black">Struts2</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:9px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp;&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">后续支持：支持不稳定，估计</span><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">年左右更新版本。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.3.2 </span><span style="font-size:16px;font-family: 宋体;color:black">各类报表比较结果</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">各类报表基本上都支持主流的功能，但各个报表都有各自的优缺点，以下内容只是提供参考建议。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">1</span><span style="font-size:16px;font-family:宋体;color:black">）开发复杂的报表、使用群体丰富（易于解决问题）：</span><span style="font-size:16px;color:black">DynamicJasper</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">BIRT</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">2</span><span style="font-size:16px;font-family:宋体;color:black">）开发效率高、易于维护：</span><span style="font-size:16px;color:black">DynamicJasper</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">BIRT</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3</span><span style="font-size:16px;font-family:宋体;color:black">）可复用已有项目或者基于已有项目进行个性化开发：</span><span style="font-size:16px;color:black">OpenReports</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">4</span><span style="font-size:16px;font-family:宋体;color:black">）易于应用集成或者有丰富的第三方软件支持：</span><span style="font-size:16px;color:black">DynamicJasper</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">5</span><span style="font-size:16px;font-family:宋体;color:black">）界面漂亮且易于维护：</span><span style="font-size:16px;color:black">DynamicJasper</span><span style="font-size:16px;font-family:宋体;color:black">、</span><span style="font-size:16px;color:black">BIRT</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">3.4 </span></a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">&nbsp;</span><span style="font-family:黑体;color:black">数据库层</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">从数据库层考虑，包括以下几个方面：</span></p><p style="line-height:27px"><span style="font-size:16px">1</span><span style="font-size:16px;font-family:宋体">）数据库设计优化</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">包括分表、分库等。</span></p><p style="line-height:27px"><span style="font-size:16px">2</span><span style="font-size:16px;font-family:宋体">）</span><span style="font-size:16px">SQL</span><span style="font-size:16px;font-family:宋体">优化</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">索引，查询语句等。</span></p><p style="line-height:27px"><span style="font-size:16px">3</span><span style="font-size:16px;font-family:宋体">）数据库操作优化</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">减少数据访问（数据库</span><span style="font-size:16px">IO</span><span style="font-size:16px;font-family: 宋体">）</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">减少交互次数（网络传输）</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">返回更少数据（网络传输）</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">减少服务器</span><span style="font-size:16px">CPU</span><span style="font-size:16px;font-family: 宋体">和内存开销</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">利用更多资源等。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">关于数据库方面的研究，网上有很多较专业的资料。本文仅仅起到一个提示、点拨的作用。遇到问题时可直接在网上搜索。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">3.4.1 </span><span style="font-size:16px;font-family:宋体">数据库设计优化</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">此处只提两点经验——分库和分表。</span></p><p style="line-height:27px"><span style="font-size:16px">1</span><span style="font-size:16px;font-family:宋体">）分库：设计上可以按</span><span style="font-size:16px">OLTP</span><span style="font-size:16px;font-family:宋体">和</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family: 宋体">的概念来分库。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">当今的数据处理大致可以分成两大类：联机事务处理</span><span style="font-size:16px">OLTP</span><span style="font-size:16px;font-family:宋体">（</span><span style="font-size:16px">On-Line Transaction Processing</span><span style="font-size:16px;font-family:宋体">）、联机分析处理</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">（</span><span style="font-size:16px">On-Line Analytical Processing</span><span style="font-size:16px;font-family:宋体">）。</span><span style="font-size:16px">OLTP</span><span style="font-size:16px;font-family:宋体">是传统的关系型数据库的主要应用，主要是基本的、日常的事务处理，例如银行交易。</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">像统计报表之类的服务，其定位应该是侧重于对数据的分析、决策支持，故属于</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">的范畴。</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">的特点是，主要是读操作，很少涉及写操作，而且理论上支持处理大量的数据，支持上百万条记录的读，但是设计上为支持较少的用户数。</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">的数据是多维聚集的、统一的，通常是综合性和提炼性数据、历史数据，数据不可更新，但是可以周期性刷新。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">而</span><span style="font-size:16px">OLTP</span><span style="font-size:16px;font-family: 宋体">数据库，是面向实时操作的数据库，要支持日常的增删查改操作。它强调响应时间，特别是对于交易系统。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">对于</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family: 宋体">系统的设计，又可以分为物理</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">、虚拟</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">、混合型</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family: 宋体">。通常所说的数据库</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">和</span><span style="font-size:16px">OLTP</span><span style="font-size:16px;font-family:宋体">分离，基本上都是属于物理上的分离，也就是分库，这是见效最快的一种。考虑到实际情况、成本、复杂度等，也可以采用虚拟</span><span style="font-size:16px">OLAP</span><span style="font-size:16px;font-family:宋体">，即通过数据库视图（</span><span style="font-size:16px">view</span><span style="font-size:16px;font-family:宋体">）等形式，把那些应用频率比较高、计算工作量比较大的查询作为实视图存储起来，优先利用已经计算好的实视图来生成查询结果以提高查询效率。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">2</span><span style="font-size:16px;font-family:宋体">）分表</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">通常意义上讲，分表就是把各个相关的数据分成若干个表分别存储，比如员工信息、部门信息，如果不分开，放在同一张表中，那么对于单纯的部门查询，则会比较麻烦。当然，这是通常意义上的分表操作。这一部分，在数据库设计的时候，应该兼顾效率以及易用性——并不是表分得越细越好，也不是越笼统越好。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">更高级的分表操作。针对数据量特别大的表，比如说帖子记录表，在这个表中，可能有上亿个帖子信息，如果我们不分成几个表来存储，那么对于数据的查询和更改那将是一个巨大的挑战，仅仅根据</span><span style="font-size:16px">ID</span><span style="font-size:16px;font-family:宋体">加上索引已经远远无法满足我们的性能要求了。所以可以采取分表存储，假设分成</span><span style="font-size:16px">POST_00</span><span style="font-size:16px;font-family:宋体">，</span><span style="font-size:16px">POST_01</span><span style="font-size:16px;font-family:宋体">，……</span><span style="font-size:16px">POST_99</span><span style="font-size:16px;font-family:宋体">共</span><span style="font-size:16px">100</span><span style="font-size:16px;font-family:宋体">张表，对于每条记录，都使用一套统一的</span><span style="font-size:16px">ID</span><span style="font-size:16px;font-family:宋体">，然后将</span><span style="font-size:16px">ID</span><span style="font-size:16px;font-family:宋体">根据一个算法进行处理，假设都能平均的分布到</span><span style="font-size:16px">00</span><span style="font-size:16px;font-family:宋体">、</span><span style="font-size:16px">01</span><span style="font-size:16px;font-family:宋体">、……</span><span style="font-size:16px">99</span><span style="font-size:16px;font-family: 宋体">之中去，那么根据这个结果将帖子存储在对应的表中，查询或更改的时候，也首先根据它的</span><span style="font-size:16px">ID</span><span style="font-size:16px;font-family:宋体">去找它是属于哪个表中，然后再在那个表中去操作。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">如图所示：</span></p><p style="text-align:center"><span style="font-size:16px"><img width="425" height="379" src="{{site.assets_url}}img/20190130/clip_image033.png" alt="clip_image033.png"/></span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">另外，还可以根据字段去分表，比如，假设有一个表中某个字段可以取值为</span><span style="font-size:16px">CA</span><span style="font-size:16px;font-family:宋体">、</span><span style="font-size:16px">TU</span><span style="font-size:16px;font-family:宋体">、</span><span style="font-size:16px">MF</span><span style="font-size:16px;font-family: 宋体">、</span><span style="font-size:16px">SC</span><span style="font-size:16px;font-family:宋体">等几个值，那么根据这个字段，可以分成</span><span style="font-size: 16px">TABLE_CA</span><span style="font-size:16px;font-family:宋体">，</span><span style="font-size:16px">TABLE_TU</span><span style="font-size:16px;font-family:宋体">，</span><span style="font-size:16px">TABLE_MF</span><span style="font-size:16px;font-family:宋体">，</span><span style="font-size:16px">TABLE_SC</span><span style="font-size:16px;font-family:宋体">等几张表，根据那个字段的值选择对应的表来储存和操作。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">3.4.2 SQL</span><span style="font-size: 16px;font-family:宋体">的优化</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">非常重要的一项内容，报表处理中必须要考虑到。前面的许多地方都已经通过实例说明了：报表处理上，“数据库”是性能的瓶颈所在。单从</span><span style="font-size:16px">SQL</span><span style="font-size:16px;font-family:宋体">这个层面上，就可以将性能提高一大截。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">关于这方面的知识，网上有很多很多资料，有需要的应该直接从网上获取，本文就不再简单罗列了。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px">3.4.3</span><span style="font-size:16px;font-family:宋体">数据库操作优化</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">此节可以参考其他专业的资料，本文不做讲解。</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">这里有一篇文章写得比较详细：</span></p><p style="line-height:27px"><span style="font-size:16px">http://blog.csdn.net/yzsind/article/details/6059209</span></p><p style="line-height:27px"><span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体">本文也提到过类似的例子，可参见“本文</span><span style="font-size:16px">2.3</span><span style="font-size:16px;font-family:宋体">小节”。</span></p><p style="line-height:24px"><a><span style="font-family:&#39;Times New Roman&#39;,serif;color:black">3.5&nbsp; </span></a><span style="font-family:黑体;color:black">服务器层</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于大型报表处理系统，可以采用服务器集群，集中多台服务器的资源，成倍地提高处理速度。单纯来讲，服务器集群目前已经是比较成熟的技术，但是对于整个系统设计的细节、程序结构会有一些影响，下面将会提到。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.5.1 </span><span style="font-size:16px;font-family:宋体;color:black">部署方式</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">设计思想：</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">同一个任务，安排多个</span><span style="font-size:16px;color:black">Worker</span><span style="font-size:16px;font-family:宋体;color:black">并行的去处理。</span></p><p style="margin-left:28px;line-height: 27px"><span style="font-size:10px;font-family:Wingdings;color:black">u<span style="font:9px &#39;Times New Roman&#39;">&nbsp; </span></span><span style="font-size:16px;font-family:宋体;color:black">同一个任务，划分成多个环节，每个环节分配</span><span style="font-size:16px;color:black">1</span><span style="font-size: 16px;font-family:宋体;color:black">至</span><span style="font-size:16px;color:black">N</span><span style="font-size:16px;font-family:宋体;color:black">个</span><span style="font-size:16px;color:black">Worker</span><span style="font-size:16px;font-family:宋体;color:black">去处理。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">大体结构分类：</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (1) </span><span style="font-size:16px;font-family:宋体;color:black">多应用服务器</span><span style="font-size:16px;color:black"> + </span><span style="font-size:16px;font-family:宋体;color:black">同一套数据库（</span><span style="font-size:16px;color:black"> + </span><span style="font-size:16px;font-family:宋体;color:black">共用文件存储空间）</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (2)</span><span style="font-size:16px;font-family:宋体;color:black">（一个应用服务器</span><span style="font-size:16px;color:black"> + </span><span style="font-size:16px;font-family:宋体;color:black">一套数据库）×</span><span style="font-size:16px;color:black">N</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (3) </span><span style="font-size:16px;font-family:宋体;color:black">分层、分类型部署，每一层都可以参照</span><span style="font-size:16px;color:black">(1)</span><span style="font-size:16px;font-family:宋体;color:black">和</span><span style="font-size:16px;color:black">(2)</span><span style="font-size:16px;font-family:宋体;color:black">的部署方式，也可以有一个</span><span style="font-size:16px;color:black">Master</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">这几种部署方式都有用武之地，其实对于</span><span style="font-size:16px;color:black">(2)</span><span style="font-size:16px;font-family:宋体;color:black">，服务器和数据库一一对应，相当于是部署多套系统，设计上来说要简单很多，不需要考虑数据同步、资源分配等问题。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于</span><span style="font-size:16px;color:black">(1)</span><span style="font-size:16px;font-family:宋体;color:black">，多应用服务器做集群部署，使用同一套数据库便于对数据进行统一管理。而且应用服务器可以平行的扩展。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于</span><span style="font-size:16px;color:black">(3)</span><span style="font-size:16px;font-family:宋体;color:black">，可以把一个系统拆分成几个模块，单独部署，例如</span><span style="font-size:16px;color:black">web</span><span style="font-size:16px;font-family:宋体;color:black">交互是一个模块，后端线程处理是一个模块，后端消息推送是一个模块，每个模块都可以分开部署，对于数据库，根据情况，可以使用一套，也可以另外扩展。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">另外，提到一点就是文件存储空间问题，因为是报表系统，必然涉及到文件的问题，对于多服务器，文件可以分开存储，也可以统一存储。对于文件的分开存储，是一个比较麻烦的事，比如，用户是随机访问一个服务器的，如何从一个服务器上去管理另一个服务器上的文件？“共享文件存储空间”能够帮我们解决这个问题，所有服务器的报表文件都放在同一个存储空间，那就不会碰到分开存储时那些麻烦事了。例如，常用的网络连接式存储（</span><span style="font-size:16px;color:black">NAS</span><span style="font-size:16px;font-family:宋体;color:black">：</span><span style="font-size:16px;color:black">Network Attached Storage</span><span style="font-size:16px;font-family:宋体;color:black">），</span><span style="font-size:16px;color:black">NAS</span><span style="font-size:16px;font-family:宋体;color:black">的优点是可以跨平台共享，只要把它挂载到各个服务器的目录下，就可以当做本地磁盘一样来存取数据了。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.5.2 </span><span style="font-size:16px;font-family:宋体;color:black">文件服务器</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">对于涉及到大量报表文件存储和下载的报表处理系统，单凭应用服务器去处理这些文件操作，既影响服务器端报表处理程序的性能，又影响客户的报表下载效率。特别是对于后者，我相信很多简单的报表处理程序，都是通过</span><span style="font-size:16px;color:black">HTTP</span><span style="font-size:16px;font-family:宋体;color:black">方式，在服务器端通过类似于</span><span style="font-size:16px;color:black">Servlet</span><span style="font-size:16px;font-family:宋体;color:black">的</span><span style="font-size:16px;color:black">ServletOutputStream</span><span style="font-size:16px;font-family:宋体;color:black">这种方式去推送文件。这种方式占用服务器端线程特别厉害，我曾经测试过，如果有</span><span style="font-size:16px;color:black">20</span><span style="font-size:16px;font-family:宋体;color:black">个这样的</span><span style="font-size:16px;color:black">servlet</span><span style="font-size:16px;font-family:宋体;color:black">线程同时运行，服务器（</span><span style="font-size:16px;color:black">Tomcat</span><span style="font-size:16px;font-family:宋体;color:black">）就变得很卡了。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">一种简单的方式是将报表文件都放到</span><span style="font-size:16px;color:black">Web</span><span style="font-size:16px;font-family:宋体;color:black">服务器目录下，直接访问文件地址</span><span style="font-size:16px;color:black">(http://file.zollty.com/exp.xls)</span><span style="font-size:16px;font-family:宋体;color:black">去下载报表文件，这种方式的效率比通过在应用服务器端用</span><span style="font-size:16px;color:black">servlet</span><span style="font-size:16px;font-family:宋体;color:black">去推送的方法较高，但是安全性很难保证。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">如果有这个需求，可以单独开设一个“报表文件服务器”，在这里对报表文件进行集中的管理。这个服务器的特点是，资源以“静态文件”为主，我们只需要重点关注的是权限问题——即，谁能看到报表文件，谁又能下载报表？这方面可以采用一些较轻量级的工具来做，比如</span><span style="font-size:16px;color:black">NodeJS</span><span style="font-size:16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">Nginx</span><span style="font-size:16px;font-family:宋体;color:black">。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">3.5.3 </span><span style="font-size:16px;font-family:宋体;color:black">其他选择</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">要想解决一个核心问题：如何能提高多线程、多进程的效率，充分利用多核</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">？</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">如果要设计支持海量数据处理、大量并发性操作的报表处理系统，可考虑用</span><span style="font-size:16px;color:black">Erlang</span><span style="font-size:16px;font-family:宋体;color:black">，</span><span style="font-size:16px;color:black">Yaws</span><span style="font-size:16px;font-family:宋体;color:black">（</span><span style="font-size:16px;color:black">Web Server</span><span style="font-size:16px;font-family:宋体;color:black">）来实现，</span><span style="font-size:16px;color:black">Erlang</span><span style="font-size:16px;font-family:宋体;color:black">是一种面向并发（</span><span style="font-size:16px;color:black">Concurrency Oriented</span><span style="font-size:16px;font-family:宋体;color:black">）的函数式编程语言，支持超大量级的并发线程，并且不需要操作系统具有并发机制，与其他语言相比有无可比拟的优势，它是一个完全不同的“生态系统”。特别适合核心建立在多进程、分布式、消息推送、海量数据处理等之上的应用。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:16px;font-family:宋体;color:black">为什么是</span><span style="font-size:16px;color:black">Erlang</span><span style="font-size:16px;font-family:宋体;color:black">？源于一个一直困扰我们的问题——多线程、多进程不能充分发挥多核</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">利用率的问题。最原始的模式是进程之间需要锁来维持数据的完整性。而</span><span style="font-size:16px;color:black">Erlang</span><span style="font-size:16px;font-family:宋体;color:black">则通过消息模型，进程之间并不共享任何数据，不需要引入锁，极大地提高了多核</span><span style="font-size:16px;color:black">CPU</span><span style="font-size:16px;font-family:宋体;color:black">的利用率。另外其高容错率，也是一个颠覆性创新，进程可以监控和自行处理，几乎不会因为软件的错误而导致整个系统瘫痪。</span></p><p style="line-height:27px"><span style="font-size:16px;color:black">&nbsp;</span></p><p style="line-height:130%"><span style="font-size:16px;line-height:130%;color:black">&nbsp;</span></p><h1 style="line-height:24px"><a></a><a></a><a></a><a><span style="font-family:黑体;color:black;font-weight:normal">参考</span></a><span style="font-family:黑体;color:black;font-weight:normal">资料</span></h1><p style="margin-left:25px;line-height:27px"><span style=";color:black"><br/></span></p><p>[1]&nbsp; https://www.ibm.com/developerworks/cn/java/j-lo-chinesecoding/</p><p>[2]&nbsp; http://blog.csdn.net/yzsind/article/details/6059209</p><p>[3]&nbsp; http://www.oschina.net/question/tag/erlang</p><p>[4]&nbsp; http://www.oschina.net/question/tag/nodejs</p><p><br/></p>
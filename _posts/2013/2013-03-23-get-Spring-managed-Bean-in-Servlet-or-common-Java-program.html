---
layout: ue
title: 为Servlet或普通Java程序注入Spring托管的Bean、数据源
category: JavaEE服务器端开发
tags: Spring
keywords: "获取Spring Bean"
---

<p><br/></p><p>S2SH中都是层层注入，action交给Spring托管。即，往Struts的Action中注入Service，往Service中又注入DAO，这个都是通过配置完成的。</p><p>经过对Spring原理和源码的研究，发现，可以写一个SpringBeanFactory.java，自己实现获取bean实例的功能。下面分两种情况进行说明。</p><p>&nbsp;</p><p>情况1：在web.xml中已经配置Spring的applicationContext文件</p><p>一般我们是这么配置Spring的：</p><pre class="brush:xml;toolbar:false;">&lt;!--&nbsp;spring上下文&nbsp;--&gt;
&lt;context-param&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;param-value&gt;classpath:/service.xml&lt;/param-value&gt;
&lt;/context-param&gt;
&lt;!--&nbsp;启动监听&nbsp;--&gt;
&lt;listener&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;</pre><p><br/></p><p>此时，可以通过<br/></p><p>org.springframework.web.context.ContextLoaderListener来获取bean。关键代码如下：</p><pre class="brush:java;toolbar:false">public&nbsp;SpringBeanFactory{
	private&nbsp;static&nbsp;ApplicationContext&nbsp;ctx;
	/**&nbsp;通过ContextLoaderListener取得ctx&nbsp;*/
	public&nbsp;static&nbsp;void&nbsp;initApplicationContext(){
		ctx=ContextLoaderListener.getCurrentWebApplicationContext();
	}
	/**&nbsp;通过泛型方法取得bean实例&nbsp;*/
	public&nbsp;static&nbsp;&lt;T&gt;&nbsp;T&nbsp;getBean(String&nbsp;name){
		if(ctx==null){
			initApplicationContext();
		}
		return&nbsp;(T)&nbsp;ctx.getBean(name);
	}
}</pre><p><br/></p><p>这样，无论在Servlet，还是在普通Java类中，都可以调用getBean()方法获取Spring托管的Bean对象了。</p><p>&nbsp;</p><p>情况2：在web.xml中未配置Spring</p><p>&nbsp; &nbsp; &nbsp; 此时，我们可以自己写程序去加载xml文件，生成ctx，关键代码如下：</p><pre class="brush:java;toolbar:false">public&nbsp;class&nbsp;SpringBeanFactory&nbsp;{
	private&nbsp;static&nbsp;ApplicationContext&nbsp;ctx&nbsp;=&nbsp;null;	
	public&nbsp;static&nbsp;void&nbsp;initApplicationContext(){
		if&nbsp;(ctx&nbsp;==&nbsp;null)&nbsp;{
			ctx&nbsp;=&nbsp;new&nbsp;ClassPathXmlApplicationContext(
					new&nbsp;String[]&nbsp;{
							&quot;classpath:applicationContext-Comm.xml&quot;,
							&quot;classpath:applicationContext-B2BPL.xml&quot;
							});
		}
	}
}</pre><p><br/></p><p>其本质和第一种情况是一样的，如果自己再建一个StartListener.java，如下：其本质和第一种情况是一样的，如果自己再建一个StartListener.java，如下：</p><pre class="brush:java;toolbar:false">public&nbsp;class&nbsp;StartListener&nbsp;implements&nbsp;ServletContextListener&nbsp;{
	@Override
	public&nbsp;void&nbsp;contextInitialized(ServletContextEvent&nbsp;event)&nbsp;{
		event.getServletContext().log(&quot;Start&nbsp;initing&nbsp;ApplicationContext...&quot;);
		SpringBeanFactory.initApplicationContext();
	}
}</pre><p><br/></p><p><br/></p><p>并把StartListener.java配置在web.xml中，这样就可以在服务器启动的时候得到ctx了。并把StartListener.java配置在web.xml中，这样就可以在服务器启动的时候得到ctx了。</p><p><br/></p><p><br/></p>

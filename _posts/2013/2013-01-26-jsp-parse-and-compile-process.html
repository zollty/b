---
layout: ue
title: 深入解读JSP的底层解析过程
category: JavaEE技术
tags: JSP
keywords: "JSP的底层解析过程"
---

<p>互联网上，这方面的资料实在太少了，故把自己研究的一些结果公布出来。</p><p>&nbsp;</p><p>首先，问大家几个问题，看大家能不能回答出来，或者在网上能不能找到答案：</p><p><span class="Apple-style-span" style="font-size: 16px; line-height: 28px; ">1、</span><span style="font-size: 16px; line-height: 28px; font-family: &#39;Times New Roman&#39;; ">page</span><span class="Apple-style-span" style="font-size: 16px; line-height: 28px; ">、</span><span style="font-size: 16px; line-height: 28px; font-family: &#39;Times New Roman&#39;; ">include</span><span class="Apple-style-span" style="font-size: 16px; line-height: 28px; ">、</span><span style="font-size: 16px; line-height: 28px; font-family: &#39;Times New Roman&#39;; ">taglib</span><span class="Apple-style-span" style="font-size: 16px; line-height: 28px; ">这三个编译指令，执行的顺序是什么？</span></p><p><span style=";font-size:16px">2、<span style="font-family:Times New Roman">JSP</span>文件中的<span style="font-family:Times New Roman">Java</span>代码、编译指令、动作指令、<span style="font-family:Times New Roman">EL</span>标签、第三方标签、静态文本等，被编译的顺序是什么？</span></p><p><span style=";font-size:16px">3、常用的、与<span style="font-family:Times New Roman">JSP</span>解析<span style="font-family:Times New Roman">/</span>编译相关的类有哪些？换句话说，<span style="font-family:Times New Roman">JSP</span>解析、编译技术是建立在哪些接口和工具之上的？</span></p><p><span style=";font-size:16px">4、<span style="font-family:Times New Roman">JSP</span>技术所有的编译指令和动作指令有哪些？</span></p><p><span style=";font-size:16px">5、<span style="font-family:Times New Roman">JSP</span>技术是由谁发起的，现在有哪几个标准？都有哪些服务器或者项目支持<span style="font-family:Times New Roman">JSP</span>的解析和编译？</span></p><p><span style=";font-size:16px">&nbsp;</span><span class="Apple-style-span" style="font-size: 16px; line-height: 28px; ">&nbsp;</span></p><p>先回答简单、基础性的问题：</p><p>&nbsp;</p><p>回答问题5：</p><p><span style=";font-size:16px">JSP的发起者为——</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">Sun&nbsp;Microsystems,&nbsp;Inc.</span></p><p><span style=";font-size:16px">JSP是由<span style="font-family:Times New Roman">Java&nbsp;Servlets</span>发展而来。</span></p><p><span style=";font-size:16px">JSP和<span style="font-family:Times New Roman">Servlet</span>一样，都是在</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">Java&nbsp;Community&nbsp;Process</span><span style=";font-size:16px">（<span style="font-family:Times New Roman">Java</span>社区组织）等众多人参与下，共同开发出来的，并且最终制定了一些规范和标准。<span style="font-family:Times New Roman">Java</span>体系中的规范和技术，会被制定成<span style="font-family:Times New Roman">JSR</span>规范。<span style="font-family:Times New Roman">JSP</span>和<span style="font-family:Times New Roman">Servlet</span>也属于这个规范之中，例如<span style="font-family:Times New Roman">JSR-53</span>规定了<span style="font-family:Times New Roman">JSP&nbsp;1.2</span>和<span style="font-family:Times New Roman">Servlet&nbsp;2.4</span>的规范，<span style="font-family:Times New Roman">JSR-152</span>规定了<span style="font-family:Times New Roman">JSP&nbsp;2.0</span>的规范。（详见</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">http://zh.wikipedia.org/wiki/JSR</span><span style=";font-size:16px">）</span></p><p><span style=";font-size:16px">JSP常用的版本有<span style="font-family:Times New Roman">1.2</span>、<span style="font-family:Times New Roman">2.0</span>和<span style="font-family:Times New Roman">2.1</span>（最新版本），</span><span style=";color:rgb(0,0,255);font-size:16px">其中<span style="font-family:Times New Roman">1.2</span>版本最大的进步在于优化了<span style="font-family:Times New Roman">JSTL</span></span><span style=";font-size:16px">（<span style="font-family:Times New Roman">JavaServer&nbsp;Pages&nbsp;Standard&nbsp;Tag&nbsp;Library</span>），已经过时了（因为它不支持<span style="font-family:Times New Roman">EL</span>表达式），</span><span style=";color:rgb(0,0,255);font-size:16px">2.0在<span style="font-family:Times New Roman">1.2</span>的基础上有了巨大的进步，因为它引入了<span style="font-family:Times New Roman">Expression&nbsp;Language</span>（<span style="font-family:Times New Roman">EL</span>表达式）、简化了<span style="font-family:Times New Roman">tag</span>标签的扩展、增强了<span style="font-family:Times New Roman">XML</span>的语法</span><span style=";font-size:16px">，以及其他一些重要改进，我是翻译过来的，官方原文如下：</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">The&nbsp;JSP&nbsp;2.0&nbsp;specification&nbsp;(JSR-152)&nbsp;substantially&nbsp;extended&nbsp;the&nbsp;technology&nbsp;by&nbsp;integrating&nbsp;a&nbsp;simple&nbsp;yet&nbsp;powerful&nbsp;expression&nbsp;language,&nbsp;simplifying&nbsp;the&nbsp;tag&nbsp;extension&nbsp;API,&nbsp;and&nbsp;enhancing&nbsp;the&nbsp;pure&nbsp;XML&nbsp;syntax,&nbsp;among&nbsp;other&nbsp;important&nbsp;enhancements.&nbsp;These&nbsp;enhancements&nbsp;greatly&nbsp;reduced&nbsp;the&nbsp;learning&nbsp;curve&nbsp;of&nbsp;the&nbsp;technology,&nbsp;warranting&nbsp;a&nbsp;major&nbsp;version&nbsp;number&nbsp;upgrade.</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">而<span style="font-family:Times New Roman">JSP&nbsp;2.1</span>是在<span style="font-family:Times New Roman">JSP&nbsp;2.0</span>的基础上，为<span style="font-family:Times New Roman">JSF</span>而生的，简而言之，<span style="font-family:Times New Roman">JSP&nbsp;2.1</span>加强了<span style="font-family:Times New Roman">EL</span>，更能够适应<span style="font-family:Times New Roman">J2EE</span>、<span style="font-family:Times New Roman">J2SE</span>、<span style="font-family:Times New Roman">Servlet&nbsp;API</span>的发展</span><span style=";font-size:16px">。</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">JSP&nbsp;2.1&nbsp;to&nbsp;enhance&nbsp;the&nbsp;expression&nbsp;language&nbsp;to&nbsp;meet&nbsp;the&nbsp;needs&nbsp;of&nbsp;JSF&nbsp;technology.&nbsp;Many&nbsp;of&nbsp;these&nbsp;enhancements&nbsp;are&nbsp;likely&nbsp;to&nbsp;be&nbsp;useful&nbsp;in&nbsp;other&nbsp;contexts&nbsp;as&nbsp;well.</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">Enhancements&nbsp;to&nbsp;be&nbsp;considered&nbsp;for&nbsp;the&nbsp;JSP&nbsp;2.1&nbsp;expression&nbsp;language&nbsp;include,&nbsp;but&nbsp;are&nbsp;not&nbsp;limited&nbsp;to,&nbsp;the&nbsp;following:&nbsp;</span></p><p><span style="font-size: 16px; ">-&nbsp;</span><span style="font-family: &#39;Times New Roman&#39;; font-size: 16px; ">moving&nbsp;the&nbsp;expression&nbsp;language&nbsp;chapter&nbsp;into&nbsp;its&nbsp;own&nbsp;specification&nbsp;document,&nbsp;to&nbsp;be&nbsp;delivered&nbsp;under&nbsp;this&nbsp;JSR&nbsp;with&nbsp;consultation&nbsp;from&nbsp;the&nbsp;JavaServer&nbsp;Faces&nbsp;expert&nbsp;group&nbsp;</span></p><p><span style=";font-size:16px">-&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">ability&nbsp;to&nbsp;redefine&nbsp;the&nbsp;behavior&nbsp;of&nbsp;the&nbsp;&quot;.&quot;&nbsp;operator&nbsp;through&nbsp;a&nbsp;Property&nbsp;Resolver&nbsp;API&nbsp;</span></p><p><span style=";font-size:16px">-&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">ability&nbsp;to&nbsp;plug&nbsp;in&nbsp;Variable&nbsp;Resolvers&nbsp;on&nbsp;a&nbsp;per-application&nbsp;and&nbsp;per-page&nbsp;basis&nbsp;</span></p><p><span style=";font-size:16px">-&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">ability&nbsp;to&nbsp;plug&nbsp;in&nbsp;Property&nbsp;Resolvers&nbsp;on&nbsp;a&nbsp;per-application&nbsp;and&nbsp;per-page&nbsp;basis&nbsp;</span></p><p><span style=";font-size:16px">-&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">ability&nbsp;to&nbsp;express&nbsp;references&nbsp;to&nbsp;bean&nbsp;methods&nbsp;using&nbsp;the&nbsp;expression&nbsp;language&nbsp;and&nbsp;invoking&nbsp;those&nbsp;methods&nbsp;via&nbsp;a&nbsp;Method&nbsp;Binding&nbsp;API&nbsp;</span></p><p><span style=";font-size:16px">-&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">ability&nbsp;to&nbsp;express&nbsp;references&nbsp;to&nbsp;bean&nbsp;properties&nbsp;using&nbsp;the&nbsp;expression&nbsp;language&nbsp;and&nbsp;getting/setting&nbsp;those&nbsp;attributes&nbsp;via&nbsp;a&nbsp;Property&nbsp;Binding&nbsp;API&nbsp;</span></p><p><span style=";font-size:16px">-&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:16px">ability&nbsp;to&nbsp;defer&nbsp;expression&nbsp;evaluation&nbsp;until&nbsp;a&nbsp;time&nbsp;of&nbsp;a&nbsp;tag&nbsp;handler&#39;s&nbsp;choosing</span></p><p><span style=";font-size:16px">目前支持<span style="font-family:Times New Roman">JSP</span>的引擎有很多，<span style="font-family:Times New Roman">NB</span>的人自己都可以写一套出来，最常见的</span><span style=";font-family:&#39;Times New Roman&#39;;color:rgb(0,0,255);font-size:16px">WebLogic</span><span style=";color:rgb(0,0,255);font-size:16px">、<span style="font-family:Times New Roman">Tomcat</span>、</span><span style=";font-family:&#39;Times New Roman&#39;;color:rgb(0,0,255);font-size:16px">WebSphere</span><span style=";color:rgb(0,0,255);font-size:16px">、</span><span style=";font-family:&#39;Times New Roman&#39;;color:rgb(0,0,255);font-size:16px">Resin</span><span style=";font-size:16px">（据说效率比<span style="font-family:Times New Roman">Tomcat</span>等要高，网易等大网站都在用）。</span></p><p>&nbsp;</p><p>&nbsp;回答问题3：</p><p style="text-indent:48px"><span style=";font-size:16px">第一个想到的就是<span style="font-family:Times New Roman">Java&nbsp;Servlet&nbsp;API</span>，即<span style="font-family:Times New Roman">servlet-api.jar&nbsp;</span>，然后<span style="font-family:Times New Roman">JSP</span>的解析有一个工具包，即<span style="font-family:Times New Roman">jasper-compiler.jar</span>，因为<span style="font-family:Times New Roman">JSP</span>是一个标准，那么在解析工具包之上，应该有一个规范的<span style="font-family:Times New Roman">API</span>包，即<span style="font-family:Times New Roman">jsp-api.jar</span>，<span style="font-family:Times New Roman">JSTL</span>是<span style="font-family:Times New Roman">JSP</span>规范的一部分，故还有<span style="font-family:Times New Roman">jstl-api.jar</span>，另外，还有<span style="font-family:Times New Roman">expression&nbsp;language</span>扩展包，<span style="font-family:Times New Roman">el-api.jar</span>。还注意到一点，<span style="font-family:Times New Roman">JSP</span>是基于<span style="font-family:Times New Roman">XML</span>的，故也涉及到<span style="font-family:Times New Roman">XML</span>的解析（用的是<span style="font-family:Times New Roman">SAX</span>）。</span></p><p style="text-indent:48px"><span style=";font-size:16px">补充一点，可以手动调用程序来解析（也叫预编译）<span style="font-family:Times New Roman">JSP</span>，在<span style="font-family:Times New Roman">Tomcat</span>或<span style="font-family:Times New Roman">WebSphere</span>下，是调用<span style="font-family:Times New Roman">JspC</span>这个工具类：</span></p><p style="text-indent:48px"><span style=";font-size:16px">Tomcat下，<span style="font-family:Times New Roman">jsp</span>是通过<span style="font-family:Times New Roman">org.apache.jasper.JspC</span>编译工具将<span style="font-family:Times New Roman">JSP&nbsp;</span>页面的预编译，在<span style="font-family:Times New Roman">WAS</span>下，是通过&nbsp;<span style="font-family:Times New Roman">com.ibm.websphere.ant.tasks.JspC</span>进行预编译。</span><span class="Apple-style-span" style="font-size: 16px; line-height: 28px; ">&nbsp;</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p>回答问题4和1：<br/></p><p><span style=";font-size:16px">&nbsp;</span></p><p style="text-indent:48px"><span style=";font-size:16px">JSP技术所有的编译指令和动作指令，可以参看官方<span style="font-family:Times New Roman">API</span>文档，我这里找到的如下：</span></p><p style="line-height: normal; "><span style=";font-size:16px">ATTRIBUTE_ACTION</span> <span style=";font-size:16px">&quot;attribute&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">ATTRIBUTE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;directive.attribute&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">BODY_ACTION</span> <span style=";font-size:16px">&quot;body&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">DECLARATION_ACTION</span> <span style=";font-size:16px">&quot;declaration&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;directive.&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">DOBODY_ACTION</span> <span style=";font-size:16px">&quot;doBody&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">ELEMENT_ACTION</span> <span style=";font-size:16px">&quot;element&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">EXPRESSION_ACTION</span> <span style=";font-size:16px">&quot;expression&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">FALLBACK_ACTION</span> <span style=";font-size:16px">&quot;fallback&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">FORWARD_ACTION</span> <span style=";font-size:16px">&quot;forward&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">GET_PROPERTY_ACTION</span> <span style=";font-size:16px">&quot;getProperty&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">INCLUDE_ACTION</span> <span style=";font-size:16px">&quot;include&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">INCLUDE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;directive.include&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">INVOKE_ACTION</span> <span style=";font-size:16px">&quot;invoke&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_ATTRIBUTE_ACTION</span> <span style=";font-size:16px">&quot;jsp:attribute&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_ATTRIBUTE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;jsp:directive.attribute&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_BODY_ACTION</span> <span style=";font-size:16px">&quot;jsp:body&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_DECLARATION_ACTION</span> <span style=";font-size:16px">&quot;jsp:declaration&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_DOBODY_ACTION</span> <span style=";font-size:16px">&quot;jsp:doBody&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_ELEMENT_ACTION</span> <span style=";font-size:16px">&quot;jsp:element&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_EXPRESSION_ACTION</span> <span style=";font-size:16px">&quot;jsp:expression&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_FALLBACK_ACTION</span> <span style=";font-size:16px">&quot;jsp:fallback&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_FORWARD_ACTION</span> <span style=";font-size:16px">&quot;jsp:forward&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_GET_PROPERTY_ACTION</span> <span style=";font-size:16px">&quot;jsp:getProperty&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_INCLUDE_ACTION</span> <span style=";font-size:16px">&quot;jsp:include&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_INCLUDE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;jsp:directive.include&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_INVOKE_ACTION</span> <span style=";font-size:16px">&quot;jsp:invoke&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_OUTPUT_ACTION</span> <span style=";font-size:16px">&quot;jsp:output&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_PAGE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;jsp:directive.page&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_PARAM_ACTION</span> <span style=";font-size:16px">&quot;jsp:param&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_PARAMS_ACTION</span> <span style=";font-size:16px">&quot;jsp:params&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_PLUGIN_ACTION</span> <span style=";font-size:16px">&quot;jsp:plugin&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_ROOT_ACTION</span> <span style=";font-size:16px">&quot;jsp:root&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_SCRIPTLET_ACTION</span> <span style=";font-size:16px">&quot;jsp:scriptlet&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_SET_PROPERTY_ACTION</span> <span style=";font-size:16px">&quot;jsp:setProperty&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_TAG_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;jsp:directive.tag&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_TAGLIB_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;jsp:taglib&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_TEXT_ACTION</span> <span style=";font-size:16px">&quot;jsp:text&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_USE_BEAN_ACTION</span> <span style=";font-size:16px">&quot;jsp:useBean&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">JSP_VARIABLE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;jsp:directive.variable&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">OUTPUT_ACTION</span> <span style=";font-size:16px">&quot;output&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">PAGE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;directive.page&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">PARAM_ACTION</span> <span style=";font-size:16px">&quot;param&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">PARAMS_ACTION</span> <span style=";font-size:16px">&quot;params&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">PLUGIN_ACTION</span> <span style=";font-size:16px">&quot;plugin&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">ROOT_ACTION</span> <span style=";font-size:16px">&quot;root&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">SCRIPTLET_ACTION</span> <span style=";font-size:16px">&quot;scriptlet&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">SET_PROPERTY_ACTION</span> <span style=";font-size:16px">&quot;setProperty&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">TAG_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;directive.tag&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">TAGLIB_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;taglib&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">TEXT_ACTION</span> <span style=";font-size:16px">&quot;text&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">USE_BEAN_ACTION</span> <span style=";font-size:16px">&quot;useBean&quot;</span></p><p style="line-height: normal; "><span style=";font-size:16px">VARIABLE_DIRECTIVE_ACTION</span> <span style=";font-size:16px">&quot;directive.variable&quot;</span></p><p style="text-indent:48px"><span style=";font-size:16px">其中<span style="font-family:Times New Roman">directive</span>就是编译指令，总结起来，有：<span style="font-family:Times New Roman">page</span>、<span style="font-family:Times New Roman">include</span>、<span style="font-family:Times New Roman">taglib</span>、<span style="font-family:Times New Roman">tag</span>、<span style="font-family:Times New Roman">attribute</span>、<span style="font-family:Times New Roman">variable</span>，关于他们的执行顺序，看解析程序是最有说服力的，程序如下：</span></p><p><span style=";font-size:16px">[&nbsp;摘自<strong><span style="font-family:Times New Roman">org.apache.jasper.compiler.Parser</span></strong><span style="font-family:Times New Roman">&nbsp;]</span></span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;private&nbsp;void&nbsp;parseDirective(Node&nbsp;parent)</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;JasperException</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;this.reader.skipSpaces();</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;directive&nbsp;=&nbsp;null;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">if&nbsp;(this.reader.matches(&quot;page&quot;))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directive&nbsp;=&nbsp;&quot;&lt;%@&nbsp;page&quot;;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(this.isTagFile)&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.err.jspError(this.reader.mark(),&nbsp;&quot;jsp.error.directive.istagfile&quot;,&nbsp;directive);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parsePageDirective(parent);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;include&quot;))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directive&nbsp;=&nbsp;&quot;&lt;%@&nbsp;include&quot;;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseIncludeDirective(parent);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;taglib&quot;))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(this.directivesOnly)</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directive&nbsp;=&nbsp;&quot;&lt;%@&nbsp;taglib&quot;;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseTaglibDirective(parent);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;tag&quot;))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directive&nbsp;=&nbsp;&quot;&lt;%@&nbsp;tag&quot;;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(this.isTagFile))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.err.jspError(this.reader.mark(),&nbsp;&quot;jsp.error.directive.isnottagfile&quot;,&nbsp;directive);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseTagDirective(parent);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;attribute&quot;))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directive&nbsp;=&nbsp;&quot;&lt;%@&nbsp;attribute&quot;;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(this.isTagFile))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.err.jspError(this.reader.mark(),&nbsp;&quot;jsp.error.directive.isnottagfile&quot;,&nbsp;directive);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseAttributeDirective(parent);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;variable&quot;))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directive&nbsp;=&nbsp;&quot;&lt;%@&nbsp;variable&quot;;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(this.isTagFile))&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.err.jspError(this.reader.mark(),&nbsp;&quot;jsp.error.directive.isnottagfile&quot;,&nbsp;directive);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseVariableDirective(parent);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.err.jspError(this.reader.mark(),&nbsp;&quot;jsp.error.invalid.directive&quot;);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;this.reader.skipSpaces();</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(this.reader.matches(&quot;%&gt;&quot;)))</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.err.jspError(this.start,&nbsp;&quot;jsp.error.unterminated&quot;,&nbsp;directive);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">再来回答问题<span style="font-family:Times New Roman">2</span>：</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p style="text-indent:48px"><span style=";font-size:16px">根据源码，我看到<span style="font-family:Times New Roman">JSP</span>编译的顺序是这样的：</span></p><p style="text-indent:48px"><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">1--&nbsp;getJspConfigPageEncoding</span></p><p><span style=";font-size:16px">2--&nbsp;determineSyntaxAndEncoding</span></p><p><span style=";font-size:16px">3--&nbsp;解析成&nbsp;<span style="font-family:Times New Roman">Node.Nodes&nbsp;parsedPage&nbsp;</span>对象，即取出所有节点</span></p><p><span style=";font-size:16px">4--&nbsp;解析每个节点</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p style="text-indent:48px"><span style=";color:rgb(0,0,255);font-size:16px">第<span style="font-family:Times New Roman">1</span>步，是从<span style="font-family:Times New Roman">web.xml</span>等配置文件中去读取配置（里面有个<span style="font-family:Times New Roman">&lt;jsp-config&gt;</span>配置），如果配置时设置了统一编码，则使用这种类型的编码，第<span style="font-family:Times New Roman">2</span>步，是根据文件来获取编码</span><span style=";font-size:16px">，注意看如下一段代码：</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">if&nbsp;((jspReader.matches(&quot;tag&nbsp;&quot;))&nbsp;||&nbsp;(jspReader.matches(&quot;page&quot;)))</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jspReader.skipSpaces();</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Attributes&nbsp;attrs&nbsp;=&nbsp;Parser.parseAttributes(this,&nbsp;jspReader);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">encoding&nbsp;=&nbsp;getPageEncodingFromDirective(attrs,&nbsp;&quot;pageEncoding&quot;);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(encoding&nbsp;!=&nbsp;null)&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">encoding&nbsp;=&nbsp;getPageEncodingFromDirective(attrs,&nbsp;&quot;contentType&quot;);</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(encoding&nbsp;!=&nbsp;null)&nbsp;{</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;saveEncoding&nbsp;=&nbsp;encoding;</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal; "><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="text-indent:48px"><span style=";color:rgb(0,0,255);font-size:16px">程序首先判断有无编译指令<span style="font-family:Times New Roman">tag</span>或者<span style="font-family:Times New Roman">page</span>，如果有，则检查编译指令是否指定了<span style="font-family:Times New Roman">pageEncoding</span>属性或者<span style="font-family:Times New Roman">contentType</span>属性。</span><span style=";font-size:16px">根据这种逻辑，可知如下这种写法：</span></p><p><span style=";font-size:16px">&lt;%@&nbsp;page&nbsp;contentType=&quot;text/html;charset=utf-8&quot;&nbsp;pageEncoding=&quot;UTF-8&quot;%&gt;</span></p><p style="text-indent:48px"><span style=";font-size:16px">其实是重复指定了编码，</span><span style=";color:rgb(0,0,255);font-size:16px">解析时会以<span style="font-family:Times New Roman">pageEncoding</span>为准</span><span style=";font-size:16px">。</span></p><p style="text-indent:48px"><span style=";font-size:16px">&nbsp;</span></p><p style="text-indent:48px"><span style=";font-size:16px">第<span style="font-family:Times New Roman">4</span>步，解析每个节点：</span></p><p style="text-indent:48px"><span style=";font-size:16px">while&nbsp;(reader.hasMoreInput())&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parser.parseElements(root);</span></p><p><span style=";font-size:16px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p style="text-indent:48px"><span style=";font-size:16px">这里又分为几个步骤，先看程序：</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;private&nbsp;void&nbsp;parseElements(Node&nbsp;parent)</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;throws&nbsp;JasperException</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;this.start&nbsp;=&nbsp;this.reader.mark();</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">if&nbsp;(this.reader.matches(&quot;&lt;%--&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseComment(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;%@&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseDirective(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;jsp:directive.&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseXMLDirective(parent);</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;%!&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseDeclaration(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;jsp:declaration&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseXMLDeclaration(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;%=&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseExpression(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;jsp:expression&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseXMLExpression(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;%&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseScriptlet(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;jsp:scriptlet&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseXMLScriptlet(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;jsp:text&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseXMLTemplateText(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;((!(this.pageInfo.isELIgnored()))&nbsp;&amp;&amp;&nbsp;(this.reader.matches(&quot;${&quot;)))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseELExpression(parent,&nbsp;&#39;$&#39;);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;((!(this.pageInfo.isELIgnored()))&nbsp;&amp;&amp;&nbsp;(this.reader.matches(&quot;#{&quot;)))</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseELExpression(parent,&nbsp;&#39;#&#39;);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(this.reader.matches(&quot;&lt;jsp:&quot;))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseStandardAction(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=";color:rgb(0,0,255);font-size:16px">}&nbsp;else&nbsp;if&nbsp;(!(parseCustomTag(parent)))&nbsp;{</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkUnbalancedEndTag();</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parseTemplateText(parent);</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span style=";font-size:16px">&nbsp;&nbsp;}</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">处理的顺序如下：</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">1--&nbsp;“<span style="font-family:Times New Roman">&lt;%--&nbsp;--%&gt;</span>”类型的注释</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">2--&nbsp;“<span style="font-family:Times New Roman">&lt;%@&nbsp;%&gt;</span>”编译指令</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">3--&nbsp;“<span style="font-family:Times New Roman">&lt;jsp:directive.&nbsp;%&gt;</span>”编译指令</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">4--&nbsp;“<span style="font-family:Times New Roman">&lt;%!&nbsp;%&gt;</span>”声明指令</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">5--&nbsp;“<span style="font-family:Times New Roman">&lt;%=&nbsp;%&gt;</span>”表达式指令</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">6--&nbsp;“<span style="font-family:Times New Roman">&lt;%&nbsp;%&gt;</span>”嵌入脚本</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">7--&nbsp;“<span style="font-family:Times New Roman">&lt;jsp:text&nbsp;&gt;</span>”嵌入文本</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">8--&nbsp;“<span style="font-family:Times New Roman">${&nbsp;}</span>”<span style="font-family:Times New Roman">EL</span>表达式</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">9--&nbsp;“<span style="font-family:Times New Roman">#{&nbsp;}</span>”<span style="font-family:Times New Roman">EL</span>表达式</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">10--&nbsp;“<span style="font-family:Times New Roman">&lt;jsp:&nbsp;&gt;</span>”其他<span style="font-family:Times New Roman">jsp</span>动作指令</span></p><p><span style=";color:rgb(0,0,255);font-size:16px">11--&nbsp;自定义的<span style="font-family:Times New Roman">tag</span>标签</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">然后，再看看<span style="font-family:Times New Roman">jsp</span>中的<span style="font-family:Times New Roman">java</span>代码（<span style="font-family:Times New Roman">ScriptingElement</span>）是怎么执行的：</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">第一步：</span></p><p style="text-indent:48px"><span style=";color:rgb(0,0,255);font-size:16px">new一个<span style="font-family:Times New Roman">Node</span>节点，然后把<span style="font-family:Times New Roman">java</span>的字符串完整地赋值给<span style="font-family:Times New Roman">Node</span>的<span style="font-family:Times New Roman">text</span>属性，然后把<span style="font-family:Times New Roman">node</span>添加到<span style="font-family:Times New Roman">Parent&nbsp;Node&nbsp;</span>队列（<span style="font-family:Times New Roman">List</span>）里面</span><span style=";font-size:16px">。</span></p><p><span style=";font-size:16px">&nbsp;</span></p><p><span style=";font-size:16px">第二步：</span><span style=";color:rgb(0,0,255);font-size:16px">读取这些<span style="font-family:Times New Roman">Nodes</span>，将其转换成<span style="font-family:Times New Roman">java</span>源代码，然后在调用<span style="font-family:Times New Roman">java</span>编译器将源代码编译成<span style="font-family:Times New Roman">class</span>文件</span><span style=";font-size:16px">。（注意：这个功能相当于是把字符串，转换成了<span style="font-family:Times New Roman">java</span>字节码）</span></p><p style="text-indent:48px"><span style=";font-size:16px">这个过程，</span><span style=";color:rgb(0,0,255);font-size:16px">调用了<span style="font-family:Times New Roman">SmapUtil</span>将上面那些<span style="font-family:Times New Roman">nodes</span>转换成<span style="font-family:Times New Roman">Java</span>源文件，然后调用<span style="font-family:Times New Roman">JDTCompiler</span>工具类，将<span style="font-family:Times New Roman">Java</span>源文件编译成<span style="font-family:Times New Roman">.class</span>文件</span><span style=";font-size:16px">，我看<span style="font-family:Times New Roman">Tomcat</span>调用的是<span style="font-family:Times New Roman">org.eclipse.jdt.internal.compiler.*</span>包下面的编译工具，实际上<span style="font-family:Times New Roman">JDK</span>也为我们提供了自己手动编译<span style="font-family:Times New Roman">Java</span>文件的方法，<span style="font-family:Times New Roman">JDK&nbsp;1.6</span>可以用<span style="font-family:Times New Roman">javax.tools.JavaCompiler</span>。</span></p><p>&nbsp;</p><p>借鉴这个过程，我自己也实现了“<span style="color: rgb(192, 0, 0); "><strong>字符串——生成Java文件——编译成class文件</strong></span>”的全自动化过程。这个过程很有用，可以允许我们自己在网站上&nbsp;上传Java文件并编译运行！</p><p><br/></p><p>补充：</p><p>&nbsp; &nbsp; JSP文件的预编译、编译和缓存机制 说白了，它就是一个“文本文件”，有一些“指定的语法”，与HTML比，它被称为“动态页面”，但是如果每次访问，都要从磁盘去读取该文件，显然性能不好。所以说，关键点就是怎么减少动态编译。&nbsp;</p><p>第一：缓存技术， 第二：支持预编译，即在服务器启动完毕之前，就先把指定的JSP文件编译好。&nbsp;</p><p>&nbsp;</p><p>关于JSP解析、编译的研究，暂时就告一段落，有兴趣的可以和我交流。</p><p><br/></p>
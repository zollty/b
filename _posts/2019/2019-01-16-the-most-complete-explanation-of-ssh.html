---
layout: ue
title: 关于SSH协议最完整的讲解
category: 其他语言和技术
tags: SSH协议
keywords: "SSH教程,SSH原理"
---

<p>首先了解几个概念<br/></p><p><strong>SSH protocol（SSH协议）</strong></p><p>&nbsp; &nbsp; The SSH protocol (Secure Shell) is a method for secure <strong>remote login from one computer to another</strong>. <span style="text-decoration: underline;">It provides several alternative options for strong authentication</span>, and <span style="text-decoration: underline;">it protects the communications security and integrity with strong encryption</span>. It is a secure alternative to the non-protected login protocols (such as telnet, rlogin) and insecure file transfer methods (such as FTP).</p><p>&nbsp; &nbsp;务必阅读官方文档：<a href="https://www.ssh.com/ssh/protocol/">https://www.ssh.com/ssh/protocol/</a></p><p><br/></p><p><strong>user authentication：用户授权</strong></p><p><strong>host authentication：主机授权</strong></p><p><br/></p><p><strong>Host keys：</strong></p><p>&nbsp; &nbsp; A host key is a cryptographic key used for authenticating computers in the SSH protocol.</p><p>&nbsp; &nbsp; Host keys are key pairs, typically using the RSA, DSA, or ECDSA algorithms. Public host keys are stored on and/or distributed to SSH clients, and private keys are stored on SSH servers.</p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p>Host Keys Should Be Unique</p><p>Each host (i.e., computer) should have a unique host key.<br/></p></li><li><p>Host keys are normally generated automatically when OpenSSH is first installed or when the computer is first booted.</p></li><li><p>In OpenSSH（Server端）, host keys are usually stored in the /etc/ssh directory.<br/></p></li></ol><p>客户端存放known_hosts文件：</p><p>&nbsp; &nbsp; SSH clients store host keys for hosts they have ever connected to. These stored host keys are called known host keys, and the collection is often called known hosts. In OpenSSH, the collection of known host keys is stored in /etc/ssh/known_hosts and in .ssh/known_hosts in each user&#39;s home directory.</p><p>阅读官方文档：<a href="https://www.ssh.com/ssh/host-key">https://www.ssh.com/ssh/host-key</a></p><p><br/></p><p><strong>private key</strong>（在SSH里面又叫 <strong>identity key</strong>）</p><p><strong>public key</strong>（在SSH里面又叫 <strong>authorized key</strong>）<br/></p><p><strong>User keys</strong>：identity key和authorized key的统称，用于用户授权。</p><p>关于 public key和 private key 参见官方说明：</p><p><a href="https://www.ssh.com/ssh/public-key-authentication">https://www.ssh.com/ssh/public-key-authentication</a></p><p>key生成工具说明参见：</p><p><a href="https://www.ssh.com/ssh/keygen/">https://www.ssh.com/ssh/keygen/</a><br/></p><p><br/></p><p><strong>SSH key</strong>：SSH授权凭证（authentication credential）的统称。<br/></p><p><strong>Session key</strong>：</p><p>&nbsp; &nbsp; a session key is a cryptographic key that is used for encrypting the bulk of transmitted data and ensuring integrity of the data.</p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p>Session key为对称加密算法（例如Diffie-Hellman）的key，每次建立的session的key都不一样；</p></li><li><p>为了防止中间人攻击，数据不但要加密，还得签名，签名和验签一般用private key和public key。</p></li></ol><p>&nbsp; &nbsp; 参见：<a href="https://www.ssh.com/ssh/session-key">https://www.ssh.com/ssh/session-key</a></p><p><br/></p><p><strong>Passphrase：</strong></p><p>&nbsp; &nbsp;用来加密private key的密码。假设private key被盗，那么它可以被用来登录所有与之匹配的系统。</p><p>&nbsp; &nbsp;在生成 private key时，可以设置一个 passphrase（类似于密码）的字符串，然后 这个private key相当于被加密了，使用这个private key时就需要输入密码解密后才能正常使用。这样即使private key泄露，别人也无法解密真正的key。很多时候这个passphrase可以保存在本地（例如ssh agent中），这样就相当于记住了密码，在本地使用这个private key就不用再次输入密码了。（注意，如果忘了passphrase，则该private key就无法在其他电脑上使用了，而且无法找回）<br/></p><p>原文：</p><p>&nbsp; &nbsp; The purpose of the passphrase is usually to encrypt the private key. This makes the key file by itself useless to an attacker. It is not uncommon for files to leak from backups or decommissioned hardware, and hackers commonly exfiltrate files from compromised systems.</p><p>&nbsp; &nbsp; To use an encrypted key, the passphrase is also needed. In a way, they are two separate factors of authentication.<br/></p><p>&nbsp; &nbsp;&nbsp;With SSH keys, if someone gains access to your computer, they also gain access to every system that uses that key. To add an extra layer of security, you can add a passphrase to your SSH key. You can use&nbsp;<code>ssh-agent</code>&nbsp;to securely save your passphrase so you don&#39;t have to reenter it.</p><p>&nbsp;&nbsp;&nbsp;&nbsp;参考资料：</p><p><a href="https://help.github.com/articles/working-with-ssh-key-passphrases/">https://help.github.com/articles/working-with-ssh-key-passphrases/</a></p><p><a href="https://www.ssh.com/ssh/passphrase">https://www.ssh.com/ssh/passphrase</a></p><p><br/></p><p><strong>ssh-agent：</strong></p><p>&nbsp; &nbsp; The ssh-agent is a helper program that keeps track of user&#39;s identity keys and their passphrases. The agent can then use the keys to log into other servers without having the user type in a password or passphrase again. This implements a form of single sign-on (SSO).</p><p>&nbsp; &nbsp; The SSH agent is used for SSH public key authentication. It uses SSH keys for authentication. Users can create SSH keys using the ssh-keygen command and install them on servers using the ssh-copy-id command.</p><p>&nbsp; &nbsp; On most Linux systems, ssh-agent is automatically configured and run at login.</p><p>&nbsp; &nbsp; By default, the agent uses SSH keys stored in the .ssh directory under the user&#39;s home directory. The ssh-add command is used for adding identities to the agent. In the simplest form, just run if without argument to add the default files ~/.ssh/id_rsa, .ssh/id_dsa, and ~/.ssh/identity. Otherwise, give it the name of the private key file to add as an argument.</p><p>&nbsp; &nbsp; The following command will list private keys currently accessible to the agent:</p><p>ssh-add -l</p><p>参见更多：</p><p><a href="https://www.ssh.com/ssh/agent">https://www.ssh.com/ssh/agent</a></p><p><a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/">https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/</a></p><p><br/></p><p><strong>SSH工作流程</strong></p><p>Initializing a connection in SSH consists of:</p><ul class=" list-paddingleft-2"><li><p>Negotiating the version of the protocol to use</p></li><li><p>Negotiating cryptographic algorithms and other options to use</p></li><li><p>Negotiating a one-time session key for encrypting the rest of the session</p></li><li><p>Authenticating the server host using its host key</p></li><li><p>Authenticating the user using a password, public key authentication, or other means.</p></li></ul><p>After this, data can be exchanged, including terminal data, graphics, and files.</p><p><br/></p><p><br/></p>
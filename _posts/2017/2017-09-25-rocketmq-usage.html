---
layout: ue
title: RocketMQ安装和用法
category: 中间件技术
tags: RocketMQ
keywords: "RocketMQ"
---

<p><strong style="font-size: 20px;">RocketMQ安装手册</strong><br/></p><p><br/></p><p><strong><span style="font-size: 16px;">详细步骤：</span></strong></p><p>参考资料：<a href="https://github.com/alibaba/RocketMQ/wiki/Quick-Start">https://github.com/alibaba/RocketMQ/wiki/Quick-Start</a></p><p><br/></p><p>步骤一：&nbsp;安装准备</p><p><br/></p><p style="white-space: normal;">1）先下载RocketMQ源码，在Linux下安装Maven</p><p style="white-space: normal;">然后用Maven编译源代码：</p><p style="white-space: normal;">cd RocketMQ</p><p style="white-space: normal;">bash install.sh</p><p><br/></p><p style="white-space: normal;">2）在安装之前，<strong>可以</strong>调用RocketMQ官方提供的脚本对系统进行优化：</p><p style="white-space: normal;">创建 admin&nbsp;用户，后面会用admin用户来部署。</p><p style="white-space: normal;">创建用户：adduser&nbsp;admin</p><p style="white-space: normal;">设置密码：echo admin:admin | chpasswd</p><p style="white-space: normal;">以root身份执行&nbsp;<span style="font-weight: 700;">sh bin/os.sh</span></p><p>（注意，系统内存剩余至少要1G以上，否则执行这个脚本会卡死。。。）</p><p><br/></p><p>步骤二：把编译包发送到各个安装服务器并解压</p><p>使用admin账号，或者用root把目前归属权给admin：chown -R admin:admin ~/RocketMQ然后切换到admin账号下</p><p>进入安装目录。</p><p>cd RocketMQ</p><p>然后执行如下命令：</p><p>ln -s target/alibaba-rocketmq-broker/alibaba-rocketmq devenv</p><p>然后：</p><p>cd devenv</p><p>echo &quot;ROCKETMQ_HOME=`pwd`&quot; &gt;&gt; ~/.bash_profile</p><p>source ~/.bash_profile</p><p><br/></p><p>步骤三：检查安装脚本&nbsp;runbroker.sh&nbsp;和&nbsp;runserver.sh</p><p style="white-space: normal;">cd devenv</p><p style="white-space: normal;">在runbroker.sh&nbsp;和&nbsp;runserver.sh里面有一段：</p><p style="white-space: normal;">JAVA_OPT=&quot;${JAVA_OPT} -server&nbsp;<span style="color: rgb(192, 0, 0);">-Xms4g -Xmx4g -Xmn2g</span>&nbsp;-XX:PermSize=128m -XX:MaxPermSize=320m&quot;</p><p style="white-space: normal;">如果服务器资源不足，可以适当改小：</p><p style="white-space: normal;">JAVA_OPT=&quot;${JAVA_OPT} -server -Xms1g -Xmx1g -Xmn512m -XX:PermSize=128m -XX:MaxPermSize=320m&quot;</p><p style="white-space: normal;">如果内存不够，RocketMQ&nbsp;broker启动不了，也没有提示，启动信息如下：</p><pre class="brush:bash;toolbar:false" style="line-height: 1.42857;">[admin@iZuf62pac6qyZ&nbsp;bin]$&nbsp;bash&nbsp;mqbroker&nbsp;-n&nbsp;localhost:9876
cp:&nbsp;cannot&nbsp;stat&nbsp;`/home/admin/rmq_bk_gc.log&#39;:&nbsp;No&nbsp;such&nbsp;file&nbsp;or&nbsp;directory
Java&nbsp;HotSpot(TM)&nbsp;64-Bit&nbsp;Server&nbsp;VM&nbsp;warning:&nbsp;ignoring&nbsp;option&nbsp;PermSize=128m;&nbsp;support&nbsp;was&nbsp;removed&nbsp;in&nbsp;8.0
Java&nbsp;HotSpot(TM)&nbsp;64-Bit&nbsp;Server&nbsp;VM&nbsp;warning:&nbsp;ignoring&nbsp;option&nbsp;MaxPermSize=320m;&nbsp;support&nbsp;was&nbsp;removed&nbsp;in&nbsp;8.0
Java&nbsp;HotSpot(TM)&nbsp;64-Bit&nbsp;Server&nbsp;VM&nbsp;warning:&nbsp;UseCMSCompactAtFullCollection&nbsp;is&nbsp;deprecated&nbsp;and&nbsp;will&nbsp;likely&nbsp;be&nbsp;removed&nbsp;in&nbsp;a&nbsp;future&nbsp;release.
Java&nbsp;HotSpot(TM)&nbsp;64-Bit&nbsp;Server&nbsp;VM&nbsp;warning:&nbsp;Cannot&nbsp;open&nbsp;file&nbsp;/home/admin/tmpfs/logs/gc.log&nbsp;due&nbsp;to&nbsp;No&nbsp;such&nbsp;file&nbsp;or&nbsp;directory

/home/admin/RocketMQ-3.5.8/devenv/bin/runbroker.sh:&nbsp;line&nbsp;58:&nbsp;28892&nbsp;Killed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numactl&nbsp;--interleave=all&nbsp;$JAVA&nbsp;${JAVA_OPT}&nbsp;$@</pre><p style="white-space: normal;">那两个文件不存在没有影响，关键是最后一行，其实就是因为内存不够造成的。</p><p><br/></p><p><br/></p><p>步骤四：启动Name Server</p><p>NameServer&nbsp;为10.1.10.74和10.1.10.156</p><p>cd bin</p><p>screen bash mqnamesrv</p><p>&nbsp; &nbsp; 如果出现：</p><p>-bash: screen: command not found</p><p>&nbsp; &nbsp; 说明需要安装screen：</p><p>&nbsp;yum install screen</p><p>&nbsp; &nbsp; 启动完之后：If you see &quot;The Name Server boot success. serializeType=JSON&quot;, this means name server starts successfully. Press <strong>Ctrl + A, then D</strong> to detach the session.</p><p>&nbsp; &nbsp; 如果报错screen Cannot open your terminal &#39;/dev/pts/1&#39;，解决问题 ：</p><p>userB在 su - userA以后，执行如下命令即可:</p><p>script /dev/null<br/></p><p>具体参见：<a href="http://blog.sina.com.cn/s/blog_704836f401010osn.html">http://blog.sina.com.cn/s/blog_704836f401010osn.html</a></p><p><br/></p><p>步骤五：启动broker</p><p>Broker&nbsp; 为10.1.10.75和10.1.10.77一组，10.1.10.76和10.1.10.155一组</p><p>nohup bash mqbroker -c ../conf/2m-2s-sync/broker-a.properties -n &quot;10.1.10.74:9876;10.1.10.156:9876&quot; autoCreateTopicEnable=true &amp;</p><p style="white-space: normal;">注意：</p><p style="white-space: normal;">1、-n后面的参数用双引号括起来。</p><p style="white-space: normal;">2、加上参数&nbsp;autoCreateTopicEnable=true&nbsp;使得producer创建topic不会失败。</p><p><br/></p><p>步骤六：</p><p>所有启动好之后，查看集群状态：</p><p>sh mqadmin clusterList -n &quot;10.1.10.74:9876;10.1.10.156:9876&quot;</p><p><br/></p><p><br/></p><p style="white-space: normal;"><strong>关闭：</strong></p><p style="white-space: normal;">sh mqshutdown broker&nbsp;</p><p style="white-space: normal;">sh mqshutdown&nbsp;namesrv</p><p><br/></p><p style="white-space: normal;">使用admin工具查看服务器状态：</p><p style="white-space: normal;">例如：</p><p style="white-space: normal;">sh mqadmin clusterList -n &quot;10.1.10.74:9876;10.1.10.75:9876&quot;</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">手动创建Topic：（设置了自动创建topic后生产者会自动创建topic，消费者不会）</p><p style="white-space: normal;">sh mqadmin updateTopic -n &quot;10.1.10.74:9876;10.1.10.156:9876&quot; -c DefaultCluster -r 4 -w 4 -t topic名称</p><p style="white-space: normal;">更多例子参见：</p><p style="white-space: normal;"><a href="https://github.com/alibaba/RocketMQ/wiki/CLI-Admin-Tool">https://github.com/alibaba/RocketMQ/wiki/CLI-Admin-Tool</a></p><p style="white-space: normal;"><a href="http://blog.csdn.net/lang_man_xing/article/details/47447769">http://blog.csdn.net/lang_man_xing/article/details/47447769</a></p><p><br/></p><p><br/></p><p>客户端报错：com.alibaba.rocketmq.remoting.exception.RemotingConnectException: connect to &lt;:10909&gt; failed</p><p style="white-space: normal;">解决方案：</p><p style="white-space: normal;">1. 目前这种写法Rocket默认开启了VIP通道，VIP通道端口为10911-2=10909。若Rocket服务器未启动端口10909，则报connect to &lt;&gt; failed。</p><p style="white-space: normal;">2. 解决方式：增加一行代码producer.setVipChannelEnabled(false);</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">参见：<a href="https://my.oschina.net/bingoding/blog/685079?p=1" style="background-color: rgb(245, 245, 213);">https://my.oschina.net/bingoding/blog/685079?p=1</a></p><p style="white-space: normal;"><br/></p><p><br/></p><p style="white-space: normal;">参考资料：</p><p style="white-space: normal;"><a href="http://www.mamicode.com/info-detail-1039164.html">http://www.mamicode.com/info-detail-1039164.html</a></p><p style="white-space: normal;"><a href="http://www.jianshu.com/p/453c6e7ff81c">http://www.jianshu.com/p/453c6e7ff81c</a></p><p style="white-space: normal;"><a href="https://github.com/alibaba/RocketMQ/wiki/Quick-Start">https://github.com/alibaba/RocketMQ/wiki/Quick-Start</a></p><p style="white-space: normal;"><a href="https://github.com/alibaba/RocketMQ/wiki/Cluster-Configuration-and-Deployment">https://github.com/alibaba/RocketMQ/wiki/Cluster-Configuration-and-Deployment</a></p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">JavaSDK：</p><p style="white-space: normal;"><a href="https://help.aliyun.com/document_detail/29546.html?spm=5176.doc29546.3.3.FNzQoZ">https://help.aliyun.com/document_detail/29546.html?spm=5176.doc29546.3.3.FNzQoZ</a></p><p><br/></p>
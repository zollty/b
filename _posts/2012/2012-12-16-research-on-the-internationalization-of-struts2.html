---
layout: ue
title: 国际化之Struts2实现研究
category: JavaEE技术
tags: Struts2
keywords: "Struts2国际化"
---

<p><br/></p><p><span style="font-size:16px;">一、基本原理</span></p><p><span style=";font-family:宋体;color:rgb(0,32,96);font-size:14px">先不提<span style="font-family:Times New Roman">Struts</span><span style="font-size:16px;">这一工具，也<strong>不用其他现成的工具</strong>，<strong>如何实现国际化</strong>？</span></span></p><p><strong><span style="font-size:16px;">最基本的实现</span></strong><span style="font-size:16px;">就是，<strong>根据不同的<span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">读取不同的文本</span></strong><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">例如有两个资源文件：</span></p><p><span style="font-size:16px;">第一个：<span style="font-family:Times New Roman">ApplicationResources_zh_CN.properties</span></span></p><p><span style="font-size:16px;">第二个：<span style="font-family:Times New Roman">ApplicationResources_en_US.properties</span></span></p><p><span style="font-size:16px;">当<span style="font-family:Times New Roman">Locale=zh_CN</span><span style="font-size:16px;">时，就去第一个文件查找；当</span><span style="font-family:Times New Roman">Locale=en_US</span><span style="font-size:16px;">时，就去第二个文件查找。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">二、自己写方案去实现</span></p><p><span style="font-size:16px;">明白这个<strong>原理</strong>后，我们可以<strong>自己编写一套工具类</strong>，去实现国际化。通常，为了方便，我们需要<strong>自定义一个页面标签，类似于<span style="font-family:Times New Roman">&lt;s:text&gt;</span><span style="font-size:16px;">那种，可以根据</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">获取相应语言的字符串</span></strong><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">三、借助<span style="font-family:Times New Roman">Struts2</span></span></p><p><strong><span style="font-size:16px;">其实，<span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">也是通过这个原理去实现国际化的。我们何必再重复造轮子？</span></span></strong></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">Struts2<span style="font-size:16px;">是开源的，源代码全都有</span></span></strong><span style="font-size:16px;"><span style="font-size:16px;">，如果你的项目没有用到</span><span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">，也没有其他简便的国际化工具，我想你照搬</span><span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">那一套也不难。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">四、<span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">国际化研究</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">本人查阅了很多网上的资料，</span></strong><span style="font-size:16px;"><strong>其实<span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">国际化，有个问题</span></strong><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">Struts2<span style="font-size:16px;">的页面国际化，默认要走</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">才行，也就是如果你直接访问</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">文件，它是没有国际化效果的</span></span></strong><span style="font-size:16px;"><span style="font-size:16px;">，除非每个</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">都通过</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">去访问（这也是</span><span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">推荐的方式）。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">通常，大家都<strong>会写一个通用<span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">，去转发所有</span><span style="font-family:Times New Roman">jsp</span></strong><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">比如我有个通用<strong><span style="font-family:Times New Roman">I18nAction</span></strong><span style="font-size:16px;">，名为</span><span style="font-family:Times New Roman">i18n</span><span style="font-size:16px;">，现在要从</span><span style="font-family:Times New Roman">index.jsp</span><span style="font-size:16px;">直接跳转到</span><span style="font-family:Times New Roman">main.jsp</span><span style="font-size:16px;">，<strong>如果写成</strong></span></span></p><p><strong><span style="font-size:16px;">href=&quot;main.jsp&quot;</span></strong></p><p><strong><span style="font-size:16px;">这样跳转过去，<span style="font-family:Times New Roman">main.jsp</span><span style="font-size:16px;">是没有国际化效果的，因为它没有经过</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">处理，所有要写成：</span></span></strong></p><p><strong><span style="font-size:16px;">href=&quot;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">i18n.action?jsp=main.jsp</span><span style="font-size:16px;">&quot;</span></strong></p><p><strong><span style="font-size:16px;">我们将<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">的路径以一个参数的形式，交给</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">，</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">再去转发。</span></span></strong></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">但是我们不想这么麻烦，每次都要写<span style="font-family:Times New Roman">i18n.action</span><span style="font-size:16px;">，所以，高手们想，是不是能够编写一个过滤器</span><span style="font-family:Times New Roman">(Filter)&nbsp;</span><span style="font-size:16px;">自动实现此功能？</span></span></strong><span style="font-size:16px;"><span style="font-size:16px;">当然可以！</span></span></p><p><span style="font-size:16px;">我们编写一个<span style="font-family:Times New Roman">Filter</span><span style="font-size:16px;">，拦截所有的</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">访问，然后转交给</span><span style="font-family:Times New Roman">i18n.action</span><span style="font-size:16px;">去处理。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">OK<span style="font-size:16px;">，<strong>这算是一种方法，不过，网上能够找到这种教程</strong>，所以我不再多讲，有兴趣可以</span><span style="font-family:Times New Roman">baidu</span><span style="font-size:16px;">或</span><span style="font-family:Times New Roman">google</span><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">这种方法有个劣势，就是如果你直接访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">，那还是没有国际化效果</span></span></strong><span style="font-size:16px;"><span style="font-size:16px;">。而且拦截器可能带来一些问题，因为它</span><strong><span style="font-size:16px;">拦截了所有</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">，有时我们并不希望这样做。</span></strong></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">我要讲<strong>另外一种方法，可以直接访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">，而无需经过</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">，当然也就无需拦截器</span></strong><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">我们从<strong>基本原理入手</strong>，从问题的根源入手，<strong><span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">国际化是怎么实现的呢</span></strong><span style="font-size:16px;">，</span><strong><span style="font-size:16px;">其入口不是</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">，而是</span><span style="font-family:Times New Roman">&lt;s:text&gt;</span><span style="font-size:16px;">标签，只要我们能找出</span><span style="font-family:Times New Roman">&lt;s:text&gt;</span><span style="font-size:16px;">标签实现的源码，并稍作修改，就可以使其按照我们的模式去工作</span></strong><span style="font-size:16px;">。我就是这么做的。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">&lt;s:text&gt;<span style="font-size:16px;">标签的<strong>源码</strong>是怎样一个逻辑呢？请看下面的代码段：</span></span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps65.tmp.jpg" title="wps65.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">(<span style="font-size:16px;">取自</span></span><strong><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">com.opensymphony.xwork2.util</span><span style="font-size:16px;">.</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">LocalizedTextUtil</span><span style="font-size:16px;">.java</span></strong><span style="font-size:16px;">)</span></p><p><span style="font-size:16px;">就是根据<span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">去寻找</span><span style="font-family:Times New Roman">aTextName</span><span style="font-size:16px;">对应的</span><span style="font-family:Times New Roman">value</span><span style="font-size:16px;">，</span></span></p><p><span style="font-size:16px;">直接访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">时，之所以没有国际化效果，是因为</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">设置有问题。</span></span></p><p><span style="font-size:16px;">Struts2<span style="font-size:16px;">获取</span><span style="font-family:Times New Roman">text</span><span style="font-size:16px;">时默认取</span><span style="font-family:Times New Roman">Loacle</span><span style="font-size:16px;">的方式为：</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext.getContext().getLocale()</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">getLocale()</span><span style="font-size:16px;">方法源码如下：</span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps66.tmp.jpg" title="wps66.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">这个</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">getLocale()</span><span style="font-size:16px;">方法，是从</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Map&lt;String,&nbsp;Object&gt;&nbsp;context</span><span style="font-size:16px;">里面去找</span></p><p><span style="font-size:16px;">key&nbsp;=&nbsp;&quot;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">com.opensymphony.xwork2.ActionContext.locale</span><span style="font-size:16px;">&quot;<span style="font-size:16px;">的</span><span style="font-family:Times New Roman">Object</span><span style="font-size:16px;">，这个</span><span style="font-family:Times New Roman">Object</span><span style="font-size:16px;">就是</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">对象。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">我们需要明确一点：</span></p><p><span style="font-size:16px;">Locale&nbsp;defultLocale=Locale.getDefault();</span></p><p><span style="font-size:16px;">是获取操作系统的<span style="font-family:Times New Roman">locale</span><span style="font-size:16px;">，这个值我们不应该改变（一改就会涉及到所有用户），也不推荐使用。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">我们要根据浏览器去设置<span style="font-family:Times New Roman">LOCALE</span><span style="font-size:16px;">值？怎么办呢？</span></span></p><p><span style="font-size:16px;">打开<span style="font-family:Times New Roman">IE</span><span style="font-size:16px;">的语言设置，我们可以看到，可以设置多个语言，所以说实际上浏览器端的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">是一个列表。通过</span><span style="font-family:Times New Roman">request</span><span style="font-size:16px;">可以获得它：</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Enumeration&nbsp;locales=request.getLocales();</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">while(locales.hasMoreElements())</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">{</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Locale&nbsp;clientLocale=(Locale)locales.nextElement();</span></p><p><span style="font-size:16px;">out.println(&quot;<span style="font-size:16px;">国别</span><span style="font-family:Times New Roman">:&quot;+clientLocale.getDisplayCountry()+&quot;&lt;br&gt;&quot;);</span></span></p><p><span style="font-size:16px;">out.println(&quot;<span style="font-size:16px;">语言</span><span style="font-family:Times New Roman">:&quot;+clientLocale.getDisplayLanguage()+&quot;&lt;br&gt;&quot;);</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">&nbsp;&nbsp;&nbsp;}</span></p><p><span style="font-size:16px;">另外，获取客户端用户设置的第一个<span style="font-family:Times New Roman">locale</span><span style="font-size:16px;">：</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Locale&nbsp;first=request.getLocale();</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">如此，我们有了浏览器端的<span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">，但是每次都去</span><span style="font-family:Times New Roman">request</span><span style="font-size:16px;">里面取，是不是有些麻烦？稍后，可以改进一下。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">这还不够，我们要做到的是根据用户的选择，去切换语言类型。</span></p><p><span style="font-size:16px;">不同的浏览器、不同的访问应该有不同的<span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">，所以应该把</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">放在</span><span style="font-family:Times New Roman">HttpSession</span><span style="font-size:16px;">中。所以说切换语言其实很简单，将</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">存入</span><span style="font-family:Times New Roman">Session</span><span style="font-size:16px;">中，然后国际化的时候从</span><span style="font-family:Times New Roman">Session</span><span style="font-size:16px;">中去寻找</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">就行了。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">综上，总结出国际化的步骤：</span></p><p><span style="font-size:16px;">第一点：默认情况下（用户没有切换语言），则<span style="font-family:Times New Roman">Session</span><span style="font-size:16px;">里面没有</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">值，此时从用户请求的浏览器端读取，并设置到</span><span style="font-family:Times New Roman">Session</span><span style="font-size:16px;">中。</span></span></p><p><span style="font-size:16px;">第二点：用户选择了切换语言，则将切换后的语言设置到<span style="font-family:Times New Roman">Session</span><span style="font-size:16px;">中。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">第一点<span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">是做到了，每次访问一个</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">，或</span><span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">，</span><span style="font-family:Times New Roman">Struts</span><span style="font-size:16px;">都会</span><span style="font-family:Times New Roman">new</span><span style="font-size:16px;">一个新的</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Map&lt;String,&nbsp;Object&gt;&nbsp;context</span><span style="font-size:16px;">，如下源码所示：</span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps67.tmp.jpg" title="wps67.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">（取自</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">org.apache.struts2.dispatcher</span><span style="font-size:16px;">.</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">&nbsp;</span><span style="font-size:16px;">D</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ispatcher</span><span style="font-size:16px;">.java<span style="font-size:16px;">）</span></span></p><p><span style="font-size:16px;">但是第二点，<span style="font-family:Times New Roman">Struts</span><span style="font-size:16px;">的处理方式就不是我想要的形式，</span><span style="font-family:Times New Roman">Struts</span><span style="font-size:16px;">是怎样切换语言环境的呢？</span></span></p><p><span style="font-size:16px;">是在<span style="font-family:Times New Roman">action</span><span style="font-size:16px;">后面加</span><span style="font-family:Times New Roman">request_locale</span><span style="font-size:16px;">参数，例如</span></span></p><p><span style="font-size:16px;">changeLan.action?request_locale=en_US</span></p><p><span style="font-size:16px;">执行每个<span style="font-family:Times New Roman">action</span><span style="font-size:16px;">时，它都会去检查是否有</span><span style="font-family:Times New Roman">request_locale</span><span style="font-size:16px;">这个参数，如果有就会将</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">设置到</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面，其</span><span style="font-family:Times New Roman">key</span><span style="font-size:16px;">为：</span><span style="font-family:Times New Roman">&quot;</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">WW_TRANS_I18N_LOCALE</span><span style="font-size:16px;">&quot;</span></p><p><span style="font-size:16px;">同时执行：</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext</span><span style="font-size:16px;">.</span><span style=";font-family:Calibri;font-size:14px">&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">setLocale</span><span style="font-size:16px;">(locale);<span style="font-size:16px;">改变</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext</span><span style="font-size:16px;">里面的</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Map&lt;String,&nbsp;Object&gt;&nbsp;context</span><span style="font-size:16px;">值</span></p><p><span style="font-size:16px;">我之前说了：</span></p><p><span style="font-size:16px;">Struts2<span style="font-size:16px;">使用</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">时，默认是从</span><span style="font-family:Times New Roman">ActionContext</span><span style="font-size:16px;">中取：</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext.getContext().getLocale()</span></p><p><span style="font-size:16px;">那是不是以后取出的<span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">都是第一次设置的</span><span style="font-family:Times New Roman">locale</span><span style="font-size:16px;">呢？</span></span></p><p><span style="font-size:16px;">答案是否定的。实际上每次访问一个<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">或</span><span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">时，</span><span style="font-family:Times New Roman">Struts</span><span style="font-size:16px;">都会</span><span style="font-family:Times New Roman">new</span><span style="font-size:16px;">一个新的</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Map&lt;String,&nbsp;Object&gt;&nbsp;context</span><span style="font-size:16px;">，并且如果是访问的<span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">，还会额外的经过一个名叫</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">I18nInterceptor</span><span style="font-size:16px;">的拦截器，当<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面不存在</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">时，它会添加进去，如果存在就不添加。最后重新设置</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">context</span><span style="font-size:16px;">里面的<span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">（这就说明，每次访问</span><span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">时，</span><span style="font-family:Times New Roman">ActionContext</span><span style="font-size:16px;">里面的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">都是新的）。见下面的源码：</span></span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps68.tmp.jpg" title="wps68.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps69.tmp.jpg" title="wps69.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">看到没有，这个拦截器会拦截所有<span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">，当</span><span style="font-family:Times New Roman">locale==null</span><span style="font-size:16px;">（也即</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">requested_locale</span><span style="font-size:16px;">==null<span style="font-size:16px;">）时就会去</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">中取</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">（如果没有，则取</span><span style="font-family:Times New Roman">ActionContext.getLocale</span><span style="font-size:16px;">），且最后，始终会执行</span><span style="font-family:Times New Roman">saveLocale</span><span style="font-size:16px;">方法，这个方法调用了</span><span style="font-family:Times New Roman">ActionContext.setLocale(locale)</span><span style="font-size:16px;">，重新设置</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">所有说，按<span style="font-family:Times New Roman">Struts</span><span style="font-size:16px;">的模式（</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">后面加</span><span style="font-family:Times New Roman">request_locale</span><span style="font-size:16px;">参数）切换了语言后，当访问</span><span style="font-family:Times New Roman">Action</span><span style="font-size:16px;">时，</span><span style="font-family:Times New Roman">locale</span><span style="font-size:16px;">实际上是从</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面取出来的，但是当访问</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">时，因为</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">I18nInterceptor</span><span style="font-size:16px;">拦截器不会执行，而</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext</span><span style="font-size:16px;">里面的</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Map&lt;String,&nbsp;Object&gt;&nbsp;context</span><span style="font-size:16px;">又是新<span style="font-family:Times New Roman">new</span><span style="font-size:16px;">出来的，且在</span><span style="font-family:Times New Roman">new&nbsp;context</span><span style="font-size:16px;">时，用的是</span><span style="font-family:Times New Roman">request.getLocale()</span><span style="font-size:16px;">（见上面我摘取的</span><span style="font-family:Times New Roman">D</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ispatcher</span><span style="font-size:16px;">.java<span style="font-size:16px;">源码），所以访问</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">时，</span><span style="font-family:Times New Roman">locale</span><span style="font-size:16px;">不是从</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">中取到的，而是读取的浏览器</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">好了，我们知道<span style="font-family:Times New Roman">struts2</span><span style="font-size:16px;">的这个毛病之后，应该怎样改进呢？</span></span></p><p><span style="font-size:16px;">很简单的逻辑：访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">时，如果</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">不为空，就应该以它为准，而不是以浏览器的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">为准（除非</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">为空）。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">显然，我们不希望每个<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">都通过</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">，进而通过</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">I18nInterceptor</span><span style="font-size:16px;">拦截器。</span></p><p><span style="font-size:16px;">我们希望直接访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">就能实现我们想要的那种效果。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">用户选择切换语言时，<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面一定是有我们想要的那个</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">的（我们可以设置进去）。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">关键是<span style="font-family:Times New Roman">&lt;s:text&gt;</span><span style="font-size:16px;">标签获取</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">时出了问题，上面我已经说过，它是从</span></span></p><p><strong><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext.getContext().getLocale()</span></strong></p><p><span style="font-size:16px;">里面去拿的，在直接访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">的情况下，它的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">值是浏览器端的语言。我们将其换成</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面的值不就行了？</span><span style="font-family:Times New Roman">Yes</span><span style="font-size:16px;">！</span></span></p><p><span style="font-size:16px;">下面就是我改造后的<span style="font-family:Times New Roman">getLocale()</span><span style="font-size:16px;">方法：</span></span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps6A.tmp.jpg" title="wps6A.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">或者换一个更标准的写法：</span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps6B.tmp.jpg" title="wps6B.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">OK<span style="font-size:16px;">，如此一来，国际化就完美了，我们做一个</span><span style="font-family:Times New Roman">changeLocale.jsp</span><span style="font-size:16px;">，嵌入到指定页面，只要用户一切换语言，访问其他</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">时就能正确的国际化了，不需要通过</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">，不需要拦截器。此时整个环境也都是用户选择的那种</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">，所以即使在</span><span style="font-family:Times New Roman">java</span><span style="font-size:16px;">代码中，也能正确的识别并做国际化处理。</span></span></p><p><span style="font-size:16px;">另外，当用户不切换语言时，我们能识别用户使用的浏览器语言，因为我们默认设置的是<span style="font-family:Times New Roman">request.getLocale()</span><span style="font-size:16px;">，当用户切换语言后，</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面有</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">了，以后就用从</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">里面读取的</span><span style="font-family:Times New Roman">Locale</span><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">另外，补充一点<strong>在</strong><strong>国际化研究中，实践得出的一些关于<span style="font-family:Times New Roman">Session</span><span style="font-size:16px;">的理解</span></strong><span style="font-size:16px;">：</span></span></p><p><span style="font-size:16px;">服务器重启，<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">仍然有效</span></span></p><p><span style="font-size:16px;">浏览器重启，<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">失效</span></span></p><p><span style="font-size:16px;">可见<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">应该是双向的，服务器存一个，浏览器端也存一个。如果</span></span></p><p><span style="font-size:16px;">服务器重启，它的<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">没有丢失（应该是保存在了磁盘上），而</span></span></p><p><span style="font-size:16px;">浏览器重启，则<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">丢失（应该是保存在浏览器端的内存中）</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">进一步研究得出结论</span></strong><span style="font-size:16px;">：</span></p><p><strong><span style="font-size:16px;">session<span style="font-size:16px;">是服务器端和浏览器端双向交互的。不过浏览器端存的是</span><span style="font-family:Times New Roman">sessionid</span></span></strong><span style="font-size:16px;"><span style="font-family:Times New Roman"></span><span style="font-size:16px;">（</span><span style="font-family:Times New Roman">Tomcat</span><span style="font-size:16px;">下</span><span style="font-family:Times New Roman">Java</span><span style="font-size:16px;">程序通常是一个</span><span style="font-family:Times New Roman">32</span><span style="font-size:16px;">位字符串，这个</span><span style="font-family:Times New Roman">id</span><span style="font-size:16px;">是存在</span><span style="font-family:Times New Roman">cookie</span><span style="font-size:16px;">中的，名为</span><span style="font-family:Times New Roman">JSESSIONID</span><span style="font-size:16px;">，如下图是我在</span><span style="font-family:Times New Roman">FireFox</span><span style="font-size:16px;">中捕捉到的），</span><strong><span style="font-size:16px;">而服务器端存的是</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">对象</span></strong><span style="font-size:16px;">，当浏览器访问服务器时，如果是以</span><span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">、</span><span style="font-family:Times New Roman">action</span><span style="font-size:16px;">等非静态访问形式，第一次连接时，服务器会新建一个</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">对象，以后的访问中，只要浏览器没有重启或者</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">没有过期或销毁，那么这个</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">是不会变的，也就是说后面用的</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">都是第一次建立的那个。</span></span></p><p><img src="http://ires.qiniudn.com/my/img/20150712/wps6C.tmp.jpg" title="wps6C.tmp.jpg"/><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">实际上，访问<span style="font-family:Times New Roman">jsp</span><span style="font-size:16px;">时，会调用如下方法：</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">HttpServletRequest</span><span style="font-size:16px;">&nbsp;</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">getSession(</span><span style="font-size:16px;">true</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">);</span></p><p><span style="font-size:16px;">该方法，如果<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">为空，则会</span><span style="font-family:Times New Roman">new</span><span style="font-size:16px;">一个</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">，否则，返回已有的</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">。官方解释为：</span></span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">public&nbsp;HttpSession&nbsp;getSession(boolean&nbsp;</span><span style="font-size:16px;">arg</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">)</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">Returns&nbsp;the&nbsp;current&nbsp;HttpSession&nbsp;associated&nbsp;with&nbsp;this&nbsp;request&nbsp;or,&nbsp;if&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;current&nbsp;session&nbsp;and&nbsp;</span><span style="font-size:16px;">arg</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">&nbsp;is&nbsp;true,&nbsp;returns&nbsp;a&nbsp;new&nbsp;session.&nbsp;</span></p><p><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">If&nbsp;</span><span style="font-size:16px;">arg</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">&nbsp;is&nbsp;false&nbsp;and&nbsp;the&nbsp;request&nbsp;has&nbsp;no&nbsp;valid&nbsp;HttpSession,&nbsp;this&nbsp;method&nbsp;returns&nbsp;null.&nbsp;</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><strong><span style="font-size:16px;">Tomcat<span style="font-size:16px;">默认是启用了</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">持久化技术的（</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">session&nbsp;persistence</span><span style="font-size:16px;">），也就是说服务器关闭后，<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">会存在磁盘上（文件名为</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">session.ser</span><span style="font-size:16px;">），重启服务器时，只要<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">没过期，仍然可以用。</span></span></strong></p><p><span style="font-size:16px;">(<span style="font-size:16px;">提醒一点，</span><strong><span style="font-size:16px;">存入</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">的类建议实现序列化接口，比如</span><span style="font-family:Times New Roman">User</span><span style="font-size:16px;">什么的</span></strong><span style="font-family:Times New Roman">)</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">在<span style="font-family:Times New Roman">tomcat</span><span style="font-size:16px;">的配置文件</span><span style="font-family:Times New Roman">context.xml</span><span style="font-size:16px;">中有一个</span><span style="font-family:Times New Roman">&lt;Manager&nbsp;...&nbsp;/&gt;</span><span style="font-size:16px;">标签，可以配置</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">的持久化。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">在<span style="font-family:Times New Roman">JSP</span><span style="font-size:16px;">页面，我们可以设置</span></span></p><p><span style="font-size:16px;">＜<span style="font-family:Times New Roman">%@&nbsp;page&nbsp;session=&quot;false&quot;%</span><span style="font-size:16px;">＞&nbsp;</span></span></p><p><span style="font-size:16px;">这样设置呢，不是不让页面创建<span style="font-family:Times New Roman">Session,</span><span style="font-size:16px;">而是在此</span><span style="font-family:Times New Roman">JSP</span><span style="font-size:16px;">页面无法使用</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">，可以减少网络数据传输。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">另外补充一个“<strong><span style="font-family:Times New Roman">URL</span><span style="font-size:16px;">重写技术</span></strong><span style="font-size:16px;">”：</span></span></p><p><span style="font-size:16px;">通常<span style="font-family:Times New Roman">session&nbsp;id</span><span style="font-size:16px;">是保存在浏览器的</span><span style="font-family:Times New Roman">cookie</span><span style="font-size:16px;">中的，由于</span><span style="font-family:Times New Roman">cookie</span><span style="font-size:16px;">可以被人为的禁止，必须有其他机制以便</span><strong><span style="font-size:16px;">在</span><span style="font-family:Times New Roman">cookie</span><span style="font-size:16px;">被禁止时仍然能够把</span><span style="font-family:Times New Roman">session&nbsp;id</span><span style="font-size:16px;">传递回服务器</span></strong><span style="font-size:16px;">。</span><strong><span style="font-family:Times New Roman">URL</span><span style="font-size:16px;">重写，就是把</span><span style="font-family:Times New Roman">session&nbsp;id</span><span style="font-size:16px;">直接附加在</span><span style="font-family:Times New Roman">URL</span><span style="font-size:16px;">路径的后面，附加方式也有两种，一种是作为</span><span style="font-family:Times New Roman">URL</span><span style="font-size:16px;">路径的附加信息，表现形式为</span></strong></span></p><p><strong><span style="font-size:16px;">http://...../xxx;jsessionid=ByOK3vjFD75aPnrF788764</span></strong></p><p><strong><span style="font-size:16px;">另一种是作为查询字符串附加在<span style="font-family:Times New Roman">URL</span><span style="font-size:16px;">后面，表现形式为</span></span></strong></p><p><strong><span style="font-size:16px;">http</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">://...../xxx?jsessionid=ByOK3vjFD75aPnr</span><span style="font-size:16px;">F</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">88764</span></strong></p><p><span style="font-size:16px;">这两种方式对于用户来说是没有区别的，只是服务器在解析的时候处理的方式不同，采用第一种方式也有利于把<span style="font-family:Times New Roman">session&nbsp;id</span><span style="font-size:16px;">的信息和正常程序参数区分开来。</span></span></p><p><span style="font-size:16px;">为了在整个交互过程中始终保持状态，就必须在每个客户端可能请求的路径后面都包含这个<span style="font-family:Times New Roman">session&nbsp;id</span><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">还有一个问题，是不是关闭浏览器后<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">就消失了呢？</span></span></p><p><span style="font-size:16px;">回答：<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">是在服务器端的，你关不关浏览器对它没有影响，因为你关闭浏览器时，只是浏览器端的</span><span style="font-family:Times New Roman">session&nbsp;id</span><span style="font-size:16px;">丢了，但是浏览器并会主动通知服务器说“我已经关闭了，你将</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">注销吧”。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">最后一个问题，<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">如何过期的呢</span><span style="font-family:Times New Roman">?</span></span></p><p><span style="font-size:16px;">1<span style="font-size:16px;">）主动注销</span></span></p><p><span style="font-size:16px;">服务器会</span><span style=";font-family:Calibri;font-size:14px">check&nbsp;session&nbsp;object&nbsp;<span style="font-size:16px;">是不是</span><span style="font-family:Calibri">valid</span><span style="font-size:16px;">的</span></span><span style="font-size:16px;">，如果是无效的，</span><span style="font-size:16px;"><span style="font-family:Times New Roman">invalid</span><span style="font-size:16px;">，则先</span><span style="font-family:Times New Roman">throw&nbsp;IllegalStateException</span></span><span style="font-size:16px;">，</span><span style="font-size:16px;">然后开始后续处理（从<span style="font-family:Times New Roman">map</span><span style="font-size:16px;">中移除，通知</span><span style="font-family:Times New Roman">listener</span><span style="font-size:16px;">等）</span></span></p><p><span style="font-size:16px;">代码片段如下（Tomcat源码）：</span></p><pre class="brush:java;toolbar:false">/**&nbsp;&nbsp;
&nbsp;*&nbsp;Perform&nbsp;the&nbsp;internal&nbsp;processing&nbsp;required&nbsp;to&nbsp;invalidate&nbsp;this&nbsp;session,&nbsp;&nbsp;
&nbsp;*&nbsp;without&nbsp;triggering&nbsp;an&nbsp;exception&nbsp;if&nbsp;the&nbsp;session&nbsp;has&nbsp;already&nbsp;expired.&nbsp;&nbsp;
&nbsp;*&nbsp;&nbsp;
&nbsp;*&nbsp;@param&nbsp;notify&nbsp;Should&nbsp;we&nbsp;notify&nbsp;listeners&nbsp;about&nbsp;the&nbsp;demise&nbsp;of&nbsp;&nbsp;
&nbsp;*&nbsp;&nbsp;this&nbsp;session?&nbsp;&nbsp;
&nbsp;*/&nbsp;&nbsp;
public&nbsp;void&nbsp;expire(boolean&nbsp;notify)&nbsp;{&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;to&nbsp;see&nbsp;if&nbsp;expire&nbsp;is&nbsp;in&nbsp;progress&nbsp;or&nbsp;has&nbsp;previously&nbsp;been&nbsp;called&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(expiring&nbsp;||&nbsp;!isValid)&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;synchronized&nbsp;(this)&nbsp;{&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;again,&nbsp;now&nbsp;we&nbsp;are&nbsp;inside&nbsp;the&nbsp;sync&nbsp;so&nbsp;this&nbsp;code&nbsp;only&nbsp;runs&nbsp;once&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Double&nbsp;check&nbsp;locking&nbsp;-&nbsp;expiring&nbsp;and&nbsp;isValid&nbsp;need&nbsp;to&nbsp;be&nbsp;volatile&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(expiring&nbsp;||&nbsp;!isValid)&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expiring&nbsp;=&nbsp;true;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setValid(false);&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;manager.remove(this,&nbsp;true);//在管理对象中讲这个session&nbsp;object删除(内部也是map实现的)&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;此处nofity标示是否在注销session的时候发送Evnet给listener，典型的观察者pattern&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(notify)&nbsp;{&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fireSessionEvent(Session.SESSION_DESTROYED_EVENT,&nbsp;null);&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expiring&nbsp;=&nbsp;false;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Unbind&nbsp;any&nbsp;objects&nbsp;associated&nbsp;with&nbsp;this&nbsp;session&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;keys[]&nbsp;=&nbsp;keys();&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;keys.length;&nbsp;i++)&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;removeAttributeInternal(keys[i],&nbsp;notify);&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p><br/></p><p><span style="font-size:16px;">2<span style="font-size:16px;">）超时注销</span></span></p><p><span style="font-size:16px;">如果浏览器端一直有操作（即一直有请求），那么<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">就不会过期，是什么原理呢？</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">其实，有一个守护线程去检查<span style="font-family:Times New Roman">session</span><span style="font-size:16px;">到期时间，每两次访问的时间间隔，如果超过</span><span style="font-family:Times New Roman">timeout</span><span style="font-size:16px;">时间，则执行销毁工作。所以，想让</span><span style="font-family:Times New Roman">session</span><span style="font-size:16px;">永不过期，可以在</span><span style="font-family:Times New Roman">timeout</span><span style="font-size:16px;">时间内，一直保持有</span><span style="font-family:Times New Roman">request</span><span style="font-size:16px;">。</span></span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">不过</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">session</span><span style="font-size:16px;">可能会意外丢失，这个就不是我们能控制的了。</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">好了，国际化涉及到的难题基本已经讲解完了，不懂的多看几遍，理解理解。我也是花了很多时间实践和分析才得出的，若有不正确之处，还望赐教。</span></p><p><span style="font-size:16px;">&nbsp;</span></p><p><span style="font-size:16px;">附：<span style="font-family:Times New Roman">Struts2</span><span style="font-size:16px;">国际化的</span><span style="font-family:Times New Roman">DEMO</span><span style="font-size:16px;">项目</span></span></p><p><span style="font-size:16px;">下载地址：</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">http://dl.vmall.com/c04g39g2q7</span></p><p><span style="font-size:16px;">（<span style="font-family:Times New Roman">struts</span><span style="font-size:16px;">的</span><span style="font-family:Times New Roman">jar</span><span style="font-size:16px;">包需自己添加，</span><span style="font-family:Times New Roman">2.3</span><span style="font-size:16px;">以上的版本均可，需要把</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">xwork-core-2.3.4.1.jar</span><span style="font-size:16px;">里面的<span style="font-family:Times New Roman">com/</span></span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">opensymphony</span><span style="font-size:16px;">/</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">xwork2</span><span style="font-size:16px;">/</span><span style=";font-family:&#39;Times New Roman&#39;;font-size:14px">ActionContext.class</span><span style="font-size:16px;">删掉，因为我重写了这个类）</span></p><p><br/></p>
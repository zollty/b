---
layout: ue
title: 关于spring boot配置优先级的特殊之处
category: Java框架和组件
tags: [Spring]
keywords: "Spring配置优先级"
---

{% raw %}
<h2>前言</h2><p>SpringBoot官方文档指明了这多种配置方式的优先级，按照从高到低排序分为……（见后文）。但经过我的测试，发现了一些不一致的情况。&nbsp;</p><p>有兴趣的朋友，可以根据我的这篇文章，给Spring社区提交Bug！！！</p><p><br/></p><h2>正文</h2><p>今天遇到两个奇怪问题，经过不停测试，终于弄清楚了：</p><p><br/></p><p>1、现象是 spring boot的 <span style="color: rgb(192, 0, 0);">logging.config&nbsp;</span>配置非常特殊</p><p>假设有三个配置文件：</p><p><strong>application-log.yml：&nbsp;</strong></p><p><span style="color: rgb(0, 176, 80);">&nbsp; &nbsp; logging.config: classpath:logback11.xml</span></p><p><strong>application-dev.yml：&nbsp;</strong></p><p><span style="color: rgb(0, 176, 80);">&nbsp; &nbsp; logging.config: classpath:logback22.xml</span></p><p><strong>application.yml：</strong></p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(0, 176, 80);">spring.profiles.<span style="color: rgb(192, 0, 0);">include: log</span></span></p><p><span style="color: rgb(0, 176, 80);">&nbsp;&nbsp;&nbsp;&nbsp;spring.profiles.<span style="color: rgb(192, 0, 0);">active: dev</span></span></p><p><span style="color: rgb(0, 176, 80);">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: rgb(192, 0, 0);">logging.config</span>: classpath:logback33.xml</span></p><p>并且，第四个配置为Main函数的命令行参数：</p><p>&nbsp; &nbsp;<span style="color: rgb(192, 0, 0);">--logging.config=</span><span style="color: rgb(0, 176, 80);">classpath:logback44.xml</span></p><p><br/></p><p><strong><span style="color: rgb(192, 0, 0);">问（1）：以上4个配置同时存在时，最终生效的logback配置为哪一个？</span></strong></p><p><span style="color:#c00000">答：直觉告诉我，应该以命令行参数配置为准（<strong>logback44.xml</strong>）。次高优先级应该是application-dev（<strong>logback22.xml</strong>）</span></p><p><span style="color:#c00000"><br/></span></p><p><strong><span style="color: rgb(192, 0, 0);">问（2）：去掉spring.profiles.active: dev后，最终生效的是哪一个？</span></strong></p><p><span style="color: rgb(192, 0, 0);">答：同上，<strong>logback44.xml</strong>优先级最高，<strong>logback33.xml</strong>次之。</span></p><p><span style="color: rgb(192, 0, 0);"><br/></span></p><p>正确答案：</p><p>只能用一句：操蛋来形容！！</p><p><br/></p><p>测试结果为：&nbsp;&nbsp;</p><p><span style="color: rgb(192, 0, 0);">1、application.yml和命令行参数中的logging.config无法覆盖spring.profiles.active/include中的配置。</span></p><p><strong>2、有spring.profiles.active时，以active里面的配置为准。</strong></p><p><strong>3、无spring.profiles.active，但是有spring.profiles.include: log时，以include的配置为准。</strong></p><p>（多个spring.profiles.include只能合并）</p><p><br/></p><p>因此，</p><p><span style="color: rgb(192, 0, 0);">（1）的答案为&nbsp;application-dev（logback22.xml）</span></p><p><span style="color: rgb(192, 0, 0);">（2）的答案为 application-log（logback11.xml）</span></p><p><br/></p><p><span style="color: rgb(192, 0, 0);">所以，</span></p><p><span style="color: rgb(192, 0, 0);">如果想覆盖上述spring.profiles.include: log（application-log.yml）中的logging.config配置，只有一个方案：</span></p><p><span style="color: rgb(192, 0, 0);">修改&nbsp;spring.profiles.active，让它激活指定带有 自定义logging.config配置的yml文件。这样就能覆盖原来include中的logging.config配置了。在application.yml和命令行参数中设置logging.config配置是无效的！</span></p><p><br/></p><p>2、SpringBoot官方文档指明了这多种配置方式的优先级，按照从高到低排序如下：</p><p>（1）如果使用了Devtools，则优先级最高的是在home目录下指定的Devtools全局配置文件~/.spring-boot-devtools.properties（优先级最高）。</p><p>（2）测试用例中，标注了 @TestPropertySource 配置项；</p><p>（3）测试用例中，@SpringBootTest 注解中的 properties 属性值；</p><p><span style="color: rgb(192, 0, 0);">（4）命令行参数；</span></p><p><span style="color: rgb(192, 0, 0);">（5）内嵌在环境变量或者系统变量中的SPRING_APPLICATION_JSON中的属性值；</span></p><p>（6）ServletConfig 初始化的参数；</p><p>（7）ServletContext 初始化的参数；</p><p>（8）java:comp/env 中的JNDI属性值；</p><p><span style="color: rgb(192, 0, 0);">（9）Java的系统变量，通过System.getProperties()方法获取；</span></p><p><span style="color: rgb(192, 0, 0);">（10）操作系统的环境变量；</span></p><p>（11）RandomValuePropertySource配置的${random.*}属性值；</p><p><span style="color: rgb(192, 0, 0);">（12）不在项目打成可执行jar包中的application-{profile}.properties或者application-{profile}.yml文件；</span></p><p><span style="color: rgb(192, 0, 0);">（13）项目打成可执行jar包中的application-{profile}.properties或者application-{profile}.yml文件；</span></p><p>（14）不在项目打成可执行jar包中的<span style="color: rgb(192, 0, 0);">application.properties或者application.yml文件</span>；</p><p>（15）项目打成可执行jar包中的<span style="color: rgb(192, 0, 0);">application.properties或者application.yml文件</span>；</p><p><span style="color: rgb(192, 0, 0);">（16）同时标注@Configuration和@PropertySource的类中，标注了@PropertySource指定的属性值；</span></p><p>（17）在main方法中设置的SpringApplication.setDefaultProperties值（优先级最低）。</p><p><br/></p><p><span style="color: rgb(192, 0, 0);"><strong>参见官方文档：</strong></span><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config" target="_blank" style="background-color: rgb(245, 245, 213);">spring-boot-external-config</a></p><p><br/></p><p><strong>大家应该注意到了，官方给的这个顺序，跟我测试的优先级顺序是矛盾的。</strong></p><p><strong>而且官方的这个顺序中，没有提到以spring.profiles.include这种方式引入配置的顺序。</strong></p><p><strong>而且注意：我只测试了logging.config这个配置，也有可能是这个配置的特殊性，导致了跟spring官方提供的优先级不一致，不代表其他配置优先级也有问题。</strong></p><p><strong><br/></strong></p><p><strong>除此之外，还有三种配置引入方式：</strong></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="color: rgb(192, 0, 0);">spring.config.location</span></p></li><li><p><span style="color: rgb(192, 0, 0);">spring.config.additional-location</span></p></li><li><p><span style="color: rgb(192, 0, 0);">spring.config.import</span></p></li><li><p><span style="color: rgb(192, 0, 0);">spring.config.activate.on-cloud-platform=kubernetes</span></p></li><li><p><span style="color: rgb(192, 0, 0);">spring.config.activate.on-profile=prod | staging</span></p></li></ul><p>例如：</p><p>spring.config.import = optional:file:./myconfig.properties</p><p>spring.config.on-not-found = ignore</p><p>spring.config.import = optional:configtree:/etc/config/*/</p><p>看起来挺复杂，这个我也没有测试过。</p><p>参见官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.profiles" target="_blank">spring-boot-reference-profiles</a> </p><p><br/></p><p><br/></p><p>没看懂的直接看结论</p><h2>结论</h2><p>使用SpringBoot时，不建议使用命令行参数配置和环境变量配置，因为它们的优先级 跟实际的优先级可能不一致：如果想通过命令行参数配置和环境变量配置去覆盖yml配置文件中的配置，可能达不到预期目的。</p><p>因此，建议出台一个规范，避免配置优先级问题：</p><p><span style="color: rgb(192, 0, 0);">spring.profiles.active配置的取值只能是 dev、test（可以分几种）、prod这几个之一，且其取值跟部署的环境一致（生产环境就只用prod，开发环境就只用dev，……）。</span></p><p><br/></p>
{% endraw %}

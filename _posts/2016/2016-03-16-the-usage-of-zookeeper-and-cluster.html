---
layout: ue
title: ZooKeeper简介、设计原理、主要配置及集群
category: 中间件技术
tags: ZooKeeper
keywords: "ZooKeeper"
---

<p><span style="font-size: 18px;"><strong>一、Zookeeper的一些概念和理解</strong></span></p><p><strong>1、数据模型</strong></p><p><img src="http://ires.qiniudn.com/my/img/20161105/1478328747254005165.jpeg" title="1478328747254005165.jpeg" alt="1478328747254005165.jpeg" width="500" height="343"/></p><p>如上图所示，ZooKeeper数据模型的结构与Unix文件系统很类似，整体上可以看作是一棵树，每个节点称做一个ZNode。每个ZNode都可以通过其路径唯一标识，比如上图中第三层的第一个ZNode, 它的路径是/app1/c1。在每个ZNode上可存储少量数据(默认是1M, 可以通过配置修改, 通常不建议在ZNode上存储大量的数据)，这个特性非常有用，在后面的典型应用场景中会介绍到。另外，每个ZNode上还存储了其Acl信息，这里需要注意，虽说ZNode的树形结构跟Unix文件系统很类似，但是其Acl与Unix文件系统是完全不同的，每个ZNode的Acl的独立的，子结点不会继承父结点的，关于ZooKeeper中的Acl可以参考之前写过的一篇文章《说说Zookeeper中的ACL》。</p><p><strong>2.重要概念&nbsp;</strong></p><p>2.1 ZNode</p><p>前文已介绍了ZNode, ZNode根据其本身的特性，可以分为下面两类：</p><p>&nbsp; ● Regular ZNode: 常规型ZNode, 用户需要显式的创建、删除</p><p>&nbsp; ● Ephemeral ZNode: 临时型ZNode, 用户创建它之后，可以显式的删除，也可以在创建它的Session结束后，由ZooKeeper Server自动删除</p><p>ZNode还有一个Sequential的特性，如果创建的时候指定的话，该ZNode的名字后面会自动Append一个不断增加的SequenceNo。</p><p>2.2 Session</p><p>Client与ZooKeeper之间的通信，需要创建一个Session，这个Session会有一个超时时间。因为ZooKeeper集群会把Client的Session信息持久化，所以在Session没超时之前，Client与ZooKeeper Server的连接可以在各个ZooKeeper Server之间透明地移动。</p><p>在实际的应用中，如果Client与Server之间的通信足够频繁，Session的维护就不需要其它额外的消息了。否则，ZooKeeper Client会每t/3 ms发一次心跳给Server，如果Client 2t/3 ms没收到来自Server的心跳回应，就会换到一个新的ZooKeeper Server上。这里t是用户配置的Session的超时时间。</p><p>2.3 Watcher</p><p>ZooKeeper支持一种Watch操作，Client可以在某个ZNode上设置一个Watcher，来Watch该ZNode上的变化。如果该ZNode上有相应的变化，就会触发这个Watcher，把相应的事件通知给设置Watcher的Client。需要注意的是，ZooKeeper中的Watcher是一次性的，即触发一次就会被取消，如果想继续Watch的话，需要客户端重新设置Watcher。这个跟epoll里的oneshot模式有点类似。</p><p><strong>3. ZooKeeper特性&nbsp;</strong></p><p>3.1 读、写(更新)模式</p><p>在ZooKeeper集群中，读可以从任意一个ZooKeeper Server读，这一点是保证ZooKeeper比较好的读性能的关键；写的请求会先Forwarder到Leader，然后由Leader来通过ZooKeeper中的原子广播协议，将请求广播给所有的Follower，Leader收到一半以上的写成功的Ack后，就认为该写成功了，就会将该写进行持久化，并告诉客户端写成功了。</p><p>3.2 WAL和Snapshot</p><p>和大多数分布式系统一样，ZooKeeper也有WAL(Write-Ahead-Log)，对于每一个更新操作，ZooKeeper都会先写WAL, 然后再对内存中的数据做更新，然后向Client通知更新结果。另外，ZooKeeper还会定期将内存中的目录树进行Snapshot，落地到磁盘上，这个跟HDFS中的FSImage是比较类似的。这么做的主要目的，一当然是数据的持久化，二是加快重启之后的恢复速度，如果全部通过Replay WAL的形式恢复的话，会比较慢。</p><p>3.3 FIFO</p><p>对于每一个ZooKeeper客户端而言，所有的操作都是遵循FIFO顺序的，这一特性是由下面两个基本特性来保证的：一是ZooKeeper Client与Server之间的网络通信是基于TCP，TCP保证了Client/Server之间传输包的顺序；二是ZooKeeper Server执行客户端请求也是严格按照FIFO顺序的。</p><p>3.4 Linearizability</p><p>在ZooKeeper中，所有的更新操作都有严格的偏序关系，更新操作都是串行执行的，这一点是保证ZooKeeper功能正确性的关键。</p><p><strong>4. ZooKeeper Client API</strong></p><p>ZooKeeper Client Library提供了丰富直观的API供用户程序使用，下面是一些常用的API：</p><p>&nbsp; ● create(path, data, flags): 创建一个ZNode, path是其路径，data是要存储在该ZNode上的数据，flags常用的有: PERSISTEN, PERSISTENT_SEQUENTAIL, EPHEMERAL, EPHEMERAL_SEQUENTAIL</p><p>&nbsp; ● delete(path, version): 删除一个ZNode，可以通过version删除指定的版本, 如果version是-1的话，表示删除所有的版本</p><p>&nbsp; ● exists(path, watch): 判断指定ZNode是否存在，并设置是否Watch这个ZNode。这里如果要设置Watcher的话，Watcher是在创建ZooKeeper实例时指定的，如果要设置特定的Watcher的话，可以调用另一个重载版本的exists(path, watcher)。以下几个带watch参数的API也都类似</p><p>&nbsp; ● getData(path, watch): 读取指定ZNode上的数据，并设置是否watch这个ZNode</p><p>&nbsp; ● setData(path, watch): 更新指定ZNode的数据，并设置是否Watch这个ZNode</p><p>&nbsp; ● getChildren(path, watch): 获取指定ZNode的所有子ZNode的名字，并设置是否Watch这个ZNode</p><p>&nbsp; ● sync(path): 把所有在sync之前的更新操作都进行同步，达到每个请求都在半数以上的ZooKeeper Server上生效。path参数目前没有用</p><p>&nbsp; ● setAcl(path, acl): 设置指定ZNode的Acl信息</p><p>&nbsp; ● getAcl(path): 获取指定ZNode的Acl信息</p><p><br/></p><p><strong>ZooKeeper 节点类型</strong></p><p>ZooKeeper 节点是有生命周期的，这取决于节点的类型。在 ZooKeeper 中，节点类型可以分为持久节点（PERSISTENT ）、临时节点（EPHEMERAL），以及时序节点（SEQUENTIAL ），具体在节点创建过程中，一般是组合使用，可以生成以下 4 种节点类型。</p><p><br/></p><p>持久节点（PERSISTENT）</p><p>所谓持久节点，是指在节点创建后，就一直存在，直到有删除操作来主动清除这个节点——不会因为创建该节点的客户端会话失效而消失。</p><p><br/></p><p>持久顺序节点（PERSISTENT_SEQUENTIAL）</p><p>这类节点的基本特性和上面的节点类型是一致的。额外的特性是，在ZK中，每个父节点会为他的第一级子节点维护一份时序，会记录每个子节点创建的先后顺序。基于这个特性，在创建子节点的时候，可以设置这个属性，那么在创建节点过程中，ZK会自动为给定节点名加上一个数字后缀，作为新的节点名。这个数字后缀的范围是整型的最大值。</p><p><br/></p><p>临时节点（EPHEMERAL）</p><p>和持久节点不同的是，临时节点的生命周期和客户端会话绑定。也就是说，如果客户端会话失效，那么这个节点就会自动被清除掉。注意，这里提到的是会话失效，而非连接断开。另外，在临时节点下面不能创建子节点。</p><p><br/></p><p>临时顺序节点（EPHEMERAL_SEQUENTIAL）</p><p><br/></p><p><strong>关于Zookeeper和客户端的通信</strong></p><p>在实际的应用中，如果Client与Server之间的通信足够频繁，Session的维护就不需要其它额外的消息了。否则，ZooKeeper Client会每t/3 ms发一次心跳给Server，如果Client 2t/3 ms没收到来自Server的心跳回应，就会换到一个新的ZooKeeper Server上。这里t是用户配置的Session的超时时间。</p><p><br/></p><p>官方文档地址：</p><p><a href="http://zookeeper.apache.org/doc/current/zookeeperProgrammers.html#ch_zkWatches">http://zookeeper.apache.org/doc/current/</a></p><p><a href="http://zookeeper.apache.org/doc/current/zookeeperProgrammers.html#ch_zkWatches">http://zookeeper.apache.org/doc/current/zookeeperProgrammers.html</a></p><p><br/></p><p><span style="font-size: 20px;"><strong>二、ZooKeeper服务端命令使用</strong></span></p><p>1、使用<span style="line-height: 32.4px;">命令行</span>客户端</p><p>./zkCli.sh -server 127.0.0.1:2180</p><p><br/></p><p>2、启动和关闭</p><p>./zkServer.sh start</p><p><span style="line-height: 32.4px;">./zkServer.sh stop</span></p><p><br/></p><p>3、查看集群状态</p><p>zkServer.sh status</p><p><br/></p><p><span style="font-size: 20px;"><strong><span style="line-height: 1.8;">三、Zookeeper集群</span></strong></span><br/></p><p>步骤：<br/></p><p>1、conf/zoo_sample.cfg文件复制一份，并更名为zoo.cfg</p><p>2、配置zoo.cfg</p><p>3、根据配置的dataDir和dataLogDir变量创建相应的目录</p><p>4、在dataDir目录下创建一个myid文件，写入按照zoo.cfg文件的server.A中A的数值，比如</p><p>server.1=172.16.1.164:2888:3888</p><p>server.2=172.16.1.165:2888:3888</p><p>server.3=172.16.1.166:2888:3888</p><p>那么在myid文件中写入1，或者2或者3。</p><p><br/></p><p>集群配置实例如下，供参考：</p><pre class="brush:plain;toolbar:false">#&nbsp;The&nbsp;number&nbsp;of&nbsp;milliseconds&nbsp;of&nbsp;each&nbsp;tick
tickTime=2000
#&nbsp;The&nbsp;number&nbsp;of&nbsp;ticks&nbsp;that&nbsp;the&nbsp;initial&nbsp;
#&nbsp;synchronization&nbsp;phase&nbsp;can&nbsp;take
initLimit=10
#&nbsp;The&nbsp;number&nbsp;of&nbsp;ticks&nbsp;that&nbsp;can&nbsp;pass&nbsp;between&nbsp;
#&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;getting&nbsp;an&nbsp;acknowledgement
syncLimit=5
#&nbsp;the&nbsp;directory&nbsp;where&nbsp;the&nbsp;snapshot&nbsp;is&nbsp;stored.
#&nbsp;do&nbsp;not&nbsp;use&nbsp;/tmp&nbsp;for&nbsp;storage,&nbsp;/tmp&nbsp;here&nbsp;is&nbsp;just&nbsp;
#&nbsp;example&nbsp;sakes.
dataDir=/home/kafka/zookeeper/data
#&nbsp;the&nbsp;port&nbsp;at&nbsp;which&nbsp;the&nbsp;clients&nbsp;will&nbsp;connect
clientPort=2181
#&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;client&nbsp;connections.
#&nbsp;increase&nbsp;this&nbsp;if&nbsp;you&nbsp;need&nbsp;to&nbsp;handle&nbsp;more&nbsp;clients
#maxClientCnxns=60
#
#&nbsp;Be&nbsp;sure&nbsp;to&nbsp;read&nbsp;the&nbsp;maintenance&nbsp;section&nbsp;of&nbsp;the&nbsp;
#&nbsp;administrator&nbsp;guide&nbsp;before&nbsp;turning&nbsp;on&nbsp;autopurge.
#
#&nbsp;http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
#
#&nbsp;The&nbsp;number&nbsp;of&nbsp;snapshots&nbsp;to&nbsp;retain&nbsp;in&nbsp;dataDir
#autopurge.snapRetainCount=3
#&nbsp;Purge&nbsp;task&nbsp;interval&nbsp;in&nbsp;hours
#&nbsp;Set&nbsp;to&nbsp;&quot;0&quot;&nbsp;to&nbsp;disable&nbsp;auto&nbsp;purge&nbsp;feature
#autopurge.purgeInterval=1
server.1=172.16.1.164:2888:3888
server.2=172.16.1.165:2888:3888
server.3=172.16.1.166:2888:3888</pre><p><span style="line-height: 1.8;">具体参见官方文档：</span><br/></p><p><a href="http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_zkMulitServerSetup">http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_zkMulitServerSetup</a> </p><p><br/></p><p><br/></p><p style="line-height: 32.4px; white-space: normal;"><strong><span style="font-size: 20px;">四、Z</span></strong><span style="font-weight: 700; font-size: 20px; line-height: 32.4px;">ookeeper学习资料</span></p><div><p style="line-height: 32.4px; white-space: normal;"><a href="http://zookeeper.apache.org/">http://zookeeper.apache.org/</a></p><p style="line-height: 32.4px; white-space: normal;"><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Index">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Index</a></p><p style="line-height: 32.4px; white-space: normal;"><br/></p><p style="line-height: 32.4px; white-space: normal;">zookeeper原理</p><p style="line-height: 32.4px; white-space: normal;"><a href="http://cailin.iteye.com/blog/2014486">http://cailin.iteye.com/blog/2014486</a></p><p style="line-height: 32.4px; white-space: normal;"><a href="http://www.oschina.net/question/928033_84720">http://www.oschina.net/question/928033_84720</a></p><p style="line-height: 32.4px; white-space: normal;">zookeeper入门</p><p style="line-height: 32.4px; white-space: normal;"><a href="http://blackproof.iteye.com/blog/2039040">http://blackproof.iteye.com/blog/2039040</a></p><p style="line-height: 32.4px; white-space: normal;"><br/></p><p style="line-height: 32.4px; white-space: normal;">zookeeper学习记录(二)</p><p style="line-height: 32.4px; white-space: normal;"><a href="http://agapple.iteye.com/blog/1112032">http://agapple.iteye.com/blog/1112032</a></p><p style="line-height: 32.4px; white-space: normal;"><a href="http://agapple.iteye.com/blog/1292129">http://agapple.iteye.com/blog/1292129</a></p><p style="line-height: 32.4px; white-space: normal;"><br/></p><p style="line-height: 32.4px; white-space: normal;"><a href="http://zookeeper.apache.org/doc/current/">http://zookeeper.apache.org/doc/current/</a></p><p style="line-height: 32.4px; white-space: normal;"><a href="http://zookeeper.apache.org/doc/current/javaExample.html">http://zookeeper.apache.org/doc/current/javaExample.html</a></p><p style="line-height: 32.4px; white-space: normal;"><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper/">http://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper/</a></p><p style="line-height: 32.4px; white-space: normal;"><br/></p><p style="line-height: 32.4px; white-space: normal;"><a href="http://www.jdon.com/artichect/zookeeper.html">http://www.jdon.com/artichect/zookeeper.html</a></p><p style="line-height: 32.4px; white-space: normal;"><br/></p><p style="line-height: 32.4px; white-space: normal;">zookeeper节点Watch机制实例展示:</p><p style="line-height: 32.4px; white-space: normal;"><a href="http://www.tuicool.com/articles/BFFvqeY">http://www.tuicool.com/articles/BFFvqeY</a></p><p style="line-height: 32.4px; white-space: normal;">ZooKeeper示例 实时更新server列表:</p><p style="line-height: 32.4px; white-space: normal;"><a href="http://coolxing.iteye.com/blog/1871520/">http://coolxing.iteye.com/blog/1871520/</a></p><p><br/></p></div>
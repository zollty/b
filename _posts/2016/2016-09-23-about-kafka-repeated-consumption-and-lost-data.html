---
layout: ue
title: Kafka重复消费和丢失数据研究
category: 中间件技术
tags: Kafka
keywords: "Kafka,重复消费,丢失数据"
---

<p><br/></p><p><strong><span style="font-size: 20px;">Kafka重复消费原因</span></strong></p><p>底层根本原因：已经消费了数据，但是offset没提交。</p><p>原因1：强行kill线程，导致消费后的数据，offset没有提交。</p><p>原因2：<span style="line-height: 1.8;">设置offset为自动提交，关闭kafka时，如果在close之前，调用&nbsp;</span><span style="line-height: 32.4px;">consumer.unsubscribe() 则有可能部分offset没提交，下次重启会重复消费。例如：</span></p><p><span class="Apple-tab-span" style="white-space:pre">	</span>try {</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>consumer.unsubscribe();</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>} catch (Exception e) {</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>}</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>try {</p><p><span class="Apple-tab-span" style="white-space:pre">		</span>consumer.close();</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>} catch (Exception e) {</p><p><span class="Apple-tab-span" style="white-space:pre">	</span>}</p><p>上面代码会导致<span style="line-height: 32.4px;">部分offset没提交，下次启动时会重复消费。</span></p><p><br/></p><p><span style="font-size: 20px;"><strong>Kafka Consumer丢失数据原因</strong></span></p><p>猜测：<span style="line-height: 32.4px;">设置offset为自动定时提交，当offset被自动定时提交时，数据还在内存中未处理，此时刚好把线程kill掉，那么offset已经提交，但是数据未处理，导致这部分内存中的数据丢失。</span></p><p><span style="line-height: 32.4px;"><br/></span></p><p><span style="line-height: 32.4px;"><br/></span></p><p><span style="line-height: 32.4px;"></span></p><p><span style="font-size: 20px;"><strong>记录offset和恢复offset的方案</strong></span></p><p>&nbsp;</p><p>理论上<span style="line-height: 32.4px;">记录offset</span>，下一个group consumer可以接着记录的offset位置继续消费。</p><p>offset记录方案：</p><p>每次消费时更新每个topic+partition位置的offset在内存中，</p><p>Map&lt;key, value&gt;，key=topic+&#39;-&#39;+partition，value=offset</p><p>当调用关闭consumer线程时，把上面Map的offset数据记录到 文件中*（分布式集群可能要记录到redis中）。</p><p>&nbsp;</p><p>下一次启动consumer，需要读取上一次的offset信息，方法是 以当前的topic+partition为key，从上次的Map中去寻找offset。</p><p>然后使用consumer.seek()方法指定到上次的offset位置。</p><p>&nbsp;</p><p>说明：</p><p>1、该方案针对单台服务器比较简单，直接把offset记录到本地文件中即可，但是对于多台服务器集群，offset也要记录到同一个地方，并且需要做去重处理。</p><p>&nbsp; &nbsp; &nbsp; 如果线上程序是由多台服务器组成的集群，是否可以用一台服务器来支撑？应该可以，只是消费慢一点，没多大影响。</p><p><br/></p><p>2、如何保证接着offset消费的数据正确性</p><p>为了确保consumer消费的数据一定是接着上一次consumer消费的数据，</p><p>consumer消费时，记录第一次取出的数据，将其offset和上次consumer最后消费的offset进行对比，如果相同则继续消费。如果不同，则停止消费，检查原因。</p><p><br/></p><p><br/></p><p><span style="line-height: 32.4px;"><br/></span></p><p><span style="line-height: 32.4px;"><br/></span></p><p><br/></p>
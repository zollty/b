---
layout: ue
title: Redis开发使用规范（公开版）V1.0
category: 系统架构和设计
tags: Redis,规范
keywords: "Redis,规范"
---

<p><span style="font-size: 20px;">一、键值设计</span></p><p><span style="font-size: 18px;">1、key名设计</span></p><p><strong>【基本原则】</strong><br/></p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p>key中添加前缀，以示区分，防止key冲突；</p></li><li><p>控制key的长度，减少无意义的内存浪费；</p></li><li><p>key中不要包含特殊字符(空格、引号、换行符等)；</p></li></ol><p><strong>【各项目key命名规范】</strong></p><p style="margin-left:28px">1、<span style="font:9px &#39;Times New Roman&#39;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family:宋体">整体格式</span></p><p style="margin-left:28px;text-indent:0"><span style="font-family:宋体">整体分为</span>4<span style="font-family:宋体">级：${team}+${project}+${func}+${key}。含义如下表所示：</span></p><table width="525"><tbody><tr class="firstRow"><td width="174" valign="top" style="border: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">等级</span></p></td><td width="176" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">说明</span></p></td><td width="174" valign="top" style="border-top: 1px solid windowtext; border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-image: initial; border-left: none; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">必须</span></p></td></tr><tr><td width="174" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">第一级</span></p></td><td width="176" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">战队名</span>($team)<span style="font-family:宋体">，由公司统一定义，参见后面的列表。</span></p></td><td width="174" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">是</span></p></td></tr><tr><td width="174" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">第二级</span></p></td><td width="176" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">项目名</span>($project)<span style="font-family:宋体">，由项目组自己申请，并提交公司备案。</span></p></td><td width="174" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">是</span></p></td></tr><tr><td width="174" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">第三级</span></p></td><td width="176" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">功能名</span>($func)</p></td><td width="174" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">是</span></p></td></tr><tr><td width="174" valign="top" style="border-right: 1px solid windowtext; border-bottom: 1px solid windowtext; border-left: 1px solid windowtext; border-image: initial; border-top: none; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">第四级</span></p></td><td width="176" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">具体业务关键字</span>($key)</p></td><td width="174" valign="top" style="border-top: none; border-left: none; border-bottom: 1px solid windowtext; border-right: 1px solid windowtext; padding: 0px 7px;"><p style="text-indent:0"><span style="font-family:宋体">是</span></p></td></tr></tbody></table><p style="margin-left:28px;text-indent:0">2、<span style="font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-family: 宋体;">各战队（team）项目（project）英文名称对照表（若有新的，联系架构组添加）：</span><br/></p><table><thead><tr class="firstRow"><th style="border-top-color: rgb(221, 221, 221); padding-top: 7px; padding-right: 15px; padding-bottom: 7px; vertical-align: top; background-position: right center; background-repeat: no-repeat; background-color: rgb(240, 240, 240); cursor: pointer;"><div class="tablesorter-header-inner" style="margin: 0px; padding: 0px;">战队</div></th><th style="border-top-color: rgb(221, 221, 221); padding-top: 7px; padding-right: 15px; padding-bottom: 7px; vertical-align: top; background-position: right center; background-repeat: no-repeat; background-color: rgb(240, 240, 240); cursor: pointer;"><div class="tablesorter-header-inner" style="margin: 0px; padding: 0px;">代号</div></th><th colspan="1" style="border-top-color: rgb(221, 221, 221); padding-top: 7px; padding-right: 15px; padding-bottom: 7px; vertical-align: top; background-position: right center; background-repeat: no-repeat; background-color: rgb(240, 240, 240); cursor: pointer;"><div class="tablesorter-header-inner" style="margin: 0px; padding: 0px;">工程代号</div></th><th colspan="1" style="border-top-color: rgb(221, 221, 221); padding-top: 7px; padding-right: 15px; padding-bottom: 7px; vertical-align: top; background-position: right center; background-repeat: no-repeat; background-color: rgb(240, 240, 240); cursor: pointer;"><div class="tablesorter-header-inner" style="margin: 0px; padding: 0px;">RedisKey值前缀</div></th><th style="border-top-color: rgb(221, 221, 221); padding-top: 7px; padding-right: 15px; padding-bottom: 7px; vertical-align: top; background-position: right center; background-repeat: no-repeat; background-color: rgb(240, 240, 240); cursor: pointer;"><div class="tablesorter-header-inner" style="margin: 0px; padding: 0px;">Master</div></th><th colspan="1" style="border-top-color: rgb(221, 221, 221); padding-top: 7px; padding-right: 15px; padding-bottom: 7px; vertical-align: top; background-position: right center; background-repeat: no-repeat; background-color: rgb(240, 240, 240); cursor: pointer;"><div class="tablesorter-header-inner" style="margin: 0px; padding: 0px;">PO</div></th></tr></thead><tbody><tr><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top; word-break: break-all;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td></tr><tr><td style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td></tr><tr><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td><td colspan="1" style="padding-top: 7px; padding-bottom: 7px; vertical-align: top;"><br/></td></tr></tbody></table><p><br/></p><p>示例：会员注册信息key：z.i.reg.xxx</p><p>${team}=z, ${project}=i, ${func}=reg, ${key}=xxx</p><p><br/></p><p>&nbsp; &nbsp;<strong> &nbsp;3、<span style="font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="font-family: 宋体;">命名规范</span></strong></p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li><p>对于${team}、${project}、${func}，原则上只能是英文小写，每个部分长度不超过3；</p></li><li><p>对于${key}，要求不能使用特殊字符（空格、引号、换行符等），长度不超过18（身份证长度）；</p><p>注意，在key中是允许使用业务唯一id的，例如 z.i.fr.m.{mid}，mid就是message id。<br/></p></li><li><p>每一级用英文分割符 &quot;.&quot; &quot;_&quot; &quot;:&quot; 分割；</p><p>[例] 会员注册信息key，规范写法示例：z.i.reg.xxx</p></li><li><p>另外允许project有两级（可能是 project.sub-project 形式），允许func有两级（可能是 module.func 模式）；</p><p>例如，项目fm有两个子项目manage和service，可以为fm.m和fm.s；</p><p>例如，friends模块，有messages和comments两个子功能，可以为fr.m和fr.c。</p></li></ol><p><br/></p><p>&nbsp; &nbsp; &nbsp;如果有特殊违例的情况，需单独评审说明。</p><p><br/></p><p><span style="font-size: 18px;">2、value设计</span></p><p><strong>1.【强制】：拒绝bigkey(防止网卡流量、慢查询)</strong></p><p>string类型控制在<strong>10KB</strong>以内，hash、list、set、zset元素个数不要超过<strong>5万</strong>。</p><p>反例：一个包含200万个元素的list。</p><p><br/></p><p><strong>2.【推荐】：控制key的生命周期，redis不是垃圾桶</strong></p><p>建议使用<strong>expire</strong>设置过期时间(条件允许可以打散过期时间，防止集中过期)，不过期的数据重点关注idletime。</p><p><br/></p><p><strong>3.【推荐】：选择适合的数据类型</strong></p><p>选择合适的存储方式和数据结构，注意节省内存和性能之间的平衡。</p><p>反例：</p><p>set user:1:name tom</p><p>set user:1:age 19</p><p>set user:1:favor football</p><p>正例:</p><p><strong>hmset</strong> user:1 <span style="text-decoration: underline;">name tom</span> age 19 <span style="text-decoration: underline;">favor football</span></p><p><br/></p><p><span style="font-size: 20px;">二、Redis的使用</span></p><p><br/></p><p><span style="font-size: 18px;">1、【推荐】</span></p><p><strong>一般情况下，只使用Redis的<span style="text-decoration: underline;">简单缓存</span>功能：</strong></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>不得把Redis当做数据库使用，做长时间的持久化存储。</p></li><li><p>如果要用Redis实现一些高级功能或者存储数据量较大，务必联系架构组，需要通过技术评审。</p></li></ul><p><br/></p><p><span style="font-size: 18px;">2、【推荐】</span></p><p><strong>避免多个应用使用同一个Redis实例</strong>，建议区分Redis集群，以便不互相干扰。</p><p>正例：不相干的业务拆分，公共数据做服务化。</p><p><br/></p><p><span style="font-size: 18px;">3、【推荐】</span></p><p>使用带有连接池的客户端（例如JedisPool），可以有效控制连接，同时提高效率。</p><p>可参考网上“<a href="https://yq.aliyun.com/articles/236383" target="_blank">JedisPool资源池优化</a>” 相关的文档。</p><p><br/></p><p><span style="font-size: 18px;">4、【推荐】 O(N)命令关注N的数量</span></p><p>数据量大时，谨慎使用 hgetall、lrange、smembers、zrange、sinter ，但是需要明确复杂度。有遍历的需求可以使用 hscan、sscan、zscan 代替。</p><p><br/></p><p><span style="font-size: 18px;">5、【推荐】：禁用命令</span></p><p>禁止线上使用keys、flushall、flushdb等命令。</p><p><br/></p><p><span style="font-size: 18px;">6、【推荐】使用批量操作提高效率</span></p><p>原生命令：例如mget、mset。非原生命令：可以使用pipeline提高效率。</p><p>但要注意控制一次批量操作的元素个数（例如500以内，实际也和元素字节数有关）。</p><p>参见：</p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><a href="https://www.cnblogs.com/huangxincheng/p/6212406.html" target="_blank">redis大幅性能提升之使用管道（PipeLine）和批量（Batch）操作</a></p></li><li><p>Redis官方文档：<a href="https://redis.io/topics/pipelining">https://redis.io/topics/pipelining</a></p></li></ul><p><br/></p><p><span style="font-size: 18px;">7、【建议】必要情况下使用monitor命令时，要注意不要长时间使用。</span></p><p>Monitor命令长期执行可能会导致占用大量内存，参见：<a href="http://carlosfu.iteye.com/blog/2254571" target="_blank">Redis内存占用飙升</a></p><p><br/></p><p><span style="font-size: 20px;">三、附录</span></p><p>参考文档：</p><p><a href="https://yq.aliyun.com/articles/531067" target="_blank">阿里云Redis开发规范</a></p><p><a href="http://carlosfu.iteye.com/blog/2254154">http://carlosfu.iteye.com/blog/2254154</a></p><p><br/></p><p><br/></p>
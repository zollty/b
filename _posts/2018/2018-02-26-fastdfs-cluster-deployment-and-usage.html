---
layout: ue
title: FastDFS集群部署和使用
category: 中间件技术
tags: FastDFS,文件存储
keywords: "FastDFS部署"
---

<p><br/></p><p><strong><span style="font-size: 20px;">Installation</span></strong></p><p>参考文档：</p><p><a href="https://github.com/happyfish100/fastdfs/wiki">https://github.com/happyfish100/fastdfs/wiki</a>（官网 Wiki）</p><p><a href="https://www.cnblogs.com/cnmenglang/p/6731209.html">https://www.cnblogs.com/cnmenglang/p/6731209.html</a> </p><p><a href="http://blog.csdn.net/xyang81/article/details/52928230">http://blog.csdn.net/xyang81/article/details/52928230</a> </p><p><br/></p><p><br/></p><p><strong>集群服务器规划（示例）：</strong></p><p><br/></p><p>跟踪服务器1【主机】（Tracker Server）：192.100.139.121</p><p>跟踪服务器2【备机】（Tracker Server）：192.100.139.122</p><p><br/></p><p>存储服务器1（Storage Server）：192.100.139.121</p><p>存储服务器2（Storage Server）：192.100.139.123</p><p>存储服务器3（Storage Server）：192.100.139.124</p><p><br/></p><p><span style="font-size: 20px;">一、FastDFS集群原理</span></p><p>&nbsp; &nbsp; FastDFS是一个开源的轻量级分布式文件系统，由跟踪服务器（tracker server）、存储服务器（storage server）和客户端（client）三个部分组成，主要解决了海量数据存储问题，特别适合以中小文件（<strong>建议范围：4KB &lt; file_size &lt;500MB</strong>）为载体的在线服务。</p><p><br/></p><p><strong><span style="font-size: 18px;">Storage server</span></strong></p><p>&nbsp; &nbsp; Storage server（后简称storage）以组（卷，group或volume）为单位组织，一个group内包含多台storage机器，<strong>数据互为备份</strong>，存储空间以group内容量最小的storage为准，所以<strong>建议group内的多个storage尽量配置相同，以免造成存储空间的浪费</strong>。</p><p>&nbsp; &nbsp; 以group为单位组织存储能方便的进行应用隔离、负载均衡、副本数定制（<strong>group内storage server数量即为该group的副本数</strong>），比如将不同应用数据存到不同的group就能隔离应用数据，同时还可根据应用的访问特性来将应用分配到不同的group来做负载均衡；缺点是group的容量受单机存储容量的限制，同时当group内有机器坏掉时，数据恢复只能依赖group内地其他机器，使得恢复时间会很长。</p><p>&nbsp; &nbsp; group内每个storage的存储依赖于本地文件系统，storage可配置多个数据存储目录，比如有10块磁盘，分别挂载在/data/disk1-/data/disk10，则可将这10个目录都配置为storage的数据存储目录。</p><p>&nbsp; &nbsp; storage接受到写文件请求时，会根据配置好的规则（后面会介绍），选择其中一个存储目录来存储文件。为了避免单个目录下的文件数太多，在storage第一次启动时，会在每个数据存储目录里创建2级子目录，每级256个，总共65536个文件，新写的文件会以hash的方式被路由到其中某个子目录下，然后将文件数据直接作为一个本地文件存储到该目录中。</p><p><br/></p><p><span style="font-size: 18px;"><strong>Tracker server</strong></span></p><p>&nbsp; &nbsp; Tracker是FastDFS的<strong>协调者，负责管理所有的storage server和group</strong>，每个storage在启动后会连接Tracker，告知自己所属的group等信息，并保持周期性的心跳，tracker根据storage的心跳信息，建立group==&gt;[storage server list]的映射表。</p><p>&nbsp; &nbsp; Tracker需要管理的元信息很少，会全部存储在内存中；另外tracker上的元信息都是由storage汇报的信息生成的，本身不需要持久化任何数据，这样使得tracker非常容易扩展，直接增加tracker机器即可扩展为tracker cluster来服务，cluster里每个tracker之间是完全对等的，所有的tracker都接受stroage的心跳信息，生成元数据信息来提供读写服务。</p><p><br/></p><p><strong><span style="font-size: 18px;">Upload file</span></strong></p><p>&nbsp; &nbsp; FastDFS向使用者提供基本文件访问接口，比如upload、download、append、delete等，以客户端库的方式提供给用户使用。<br/></p><p><br/></p><p>更多细节参考文章：</p><p><a href="http://blog.chinaunix.net/uid-20196318-id-4058561.html">http://blog.chinaunix.net/uid-20196318-id-4058561.html</a> </p><p><a href="https://www.linuxidc.com/Linux/2014-10/107591.htm">https://www.linuxidc.com/Linux/2014-10/107591.htm</a> </p><p><br/></p><p><span style="font-size: 20px;">二、生产部署规划</span></p><p><br/></p><p>从负载的角度来看，压力主要在storage server，因为它实际承担了文件上传、下载的服务，而tracker server只是协调组，压力会很小。<br/></p><p><br/></p><p>从容灾的角度来看，</p><p>1）tracker server全都是对等的节点，一个节点挂掉后，直接切到另一个节点即可。所以，生产部署两个tracker server独立节点，使用vip连接即可。</p><p>2）storage server全都是对等的节点，每个storage sever上都有文件的副本，所以，从容灾角度考虑，至少要部署2个。</p><p><br/></p><p>综上，生产可以部署：2个tracker server + 1个group（2~3个storage），妥妥的。具体情况，后面还将进一步分析。</p><p><br/></p><p><span style="font-size: 20px;">三、安装步骤</span></p><p><br/></p><p><span style="color: rgb(192, 0, 0);">本文以&nbsp; CentOS/ RHEL 为例：</span></p><p><br/></p><p><span style="font-size: 18px;">【步骤一： 安装准备】</span></p><p>所需安装文件：<br/></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p>libfatscommon（下载地址：https://github.com/happyfish100/fastdfs-nginx-module.git）</p></li><li><p>FastDFS（包含了tracker和storage）（下载地址：https://github.com/happyfish100/fastdfs.git）</p></li><li><p>Nginx （为FastDFS提供HTTP下载支持，下载地址：nginx官网，比如 http://nginx.org/download/nginx-1.12.2.tar.gz）</p></li><li><p>fastdfs-nginx-module （下载地址：https://github.com/happyfish100/libfastcommon.git）</p></li></ul><p><br/></p><p>注意：Nginx 和 fastdfs-nginx-module<strong>是用来支持HTTP访问的，是可选的，下面会提到</strong>。</p><p><br/></p><p>安装目录规划【示例】：</p><table width="700"><thead><tr style="border-top: 1px solid rgb(198, 203, 209);" class="firstRow"><th style="padding: 6px 13px; border-color: rgb(223, 226, 229);">说明</th><th style="padding: 6px 13px; border-color: rgb(223, 226, 229);">位置</th></tr></thead><tbody><tr style="border-top: 1px solid rgb(198, 203, 209);"><td style="padding: 6px 13px; border-color: rgb(223, 226, 229);">所有安装包</td><td style="padding: 6px 13px; border-color: rgb(223, 226, 229);">/usr/local/src</td></tr><tr style="background-color: rgb(246, 248, 250); border-top: 1px solid rgb(198, 203, 209);"><td style="padding: 6px 13px; border-color: rgb(223, 226, 229);">tracker跟踪服务器数据</td><td style="padding: 6px 13px; border-color: rgb(223, 226, 229);">/fastdfs/tracker</td></tr><tr style="border-top: 1px solid rgb(198, 203, 209);"><td style="padding: 6px 13px; border-color: rgb(223, 226, 229);">storage存储服务器数据</td><td style="padding: 6px 13px; border-color: rgb(223, 226, 229);">/fastdfs/storage</td></tr></tbody></table><p><br/></p><p style="white-space: normal;"><span style="font-weight: 700;">把相关文件 源码 下载解压到相应目录</span></p><p style="white-space: normal;">如下：</p><p style="white-space: normal;"><span style="color: rgb(192, 0, 0);">/usr/local/src/libfastcommon</span></p><p style="white-space: normal;"><span style="color: rgb(192, 0, 0);">/usr/local/src/fastdfs</span></p><p style="white-space: normal;"><span style="color: rgb(192, 0, 0);">/usr/local/src/fastdfs-nginx-module</span></p><p><br/></p><p><span style="font-size: 18px;">【步骤二、FastDFS安装】</span></p><p><br/></p><p><strong>安装libfatscommon</strong></p><p>cd libfastcommon/</p><p>./make.sh &amp;&amp; ./make.sh install</p><p><br/></p><p><strong>安装FastDFS</strong></p><p>cd fastdfs/</p><p>./make.sh &amp;&amp; ./make.sh install</p><p><br/></p><p><strong>配置文件准备</strong></p><pre class="brush:bash;toolbar:false">cp&nbsp;/etc/fdfs/tracker.conf.sample&nbsp;/etc/fdfs/tracker.conf
cp&nbsp;/etc/fdfs/storage.conf.sample&nbsp;/etc/fdfs/storage.conf
cp&nbsp;/etc/fdfs/client.conf.sample&nbsp;/etc/fdfs/client.conf&nbsp;#客户端文件，测试用
cp&nbsp;/usr/local/src/fastdfs/conf/http.conf&nbsp;/etc/fdfs/&nbsp;#供nginx访问使用
cp&nbsp;/usr/local/src/fastdfs/conf/mime.types&nbsp;/etc/fdfs/&nbsp;#供nginx访问使用
cp&nbsp;/usr/local/src/fastdfs-nginx-module/src/mod_fastdfs.conf&nbsp;/etc/fdfs</pre><p><br/></p><p><span style="font-size: 18px;">【步骤三、修改配置并启动集群】</span></p><p><strong><br/></strong></p><p><strong>tracker配置</strong></p><p>vim /etc/fdfs/tracker.conf</p><pre class="brush:plain;toolbar:false">#需要修改的内容如下
port=22122&nbsp;&nbsp;#&nbsp;tracker服务器端口（默认22122,一般不修改）
base_path=/fastdfs/tracker&nbsp;&nbsp;#&nbsp;存储日志和数据的根目录</pre><p><br/></p><p>#保存后启动</p><p>/etc/init.d/fdfs_trackerd start #启动tracker服务</p><p>chkconfig fdfs_trackerd on #自启动tracker服务</p><p><br/></p><p><strong>storage配置</strong></p><p>vim /etc/fdfs/storage.conf</p><p>#需要修改的内容如下</p><pre class="brush:plain;toolbar:false">port=23000&nbsp;&nbsp;#&nbsp;storage服务端口（默认23000,一般不修改）
base_path=/fastdfs/storage&nbsp;&nbsp;#&nbsp;数据和日志文件存储根目录
store_path0=/fastdfs/storage&nbsp;&nbsp;#&nbsp;第一个存储目录
tracker_server=192.168.0.xxx:22122&nbsp;&nbsp;#&nbsp;tracker服务器IP和端口
http.server_port=8888&nbsp;&nbsp;#&nbsp;http访问文件的端口(默认8888,看情况修改,和nginx中保持一致)
（如果有多个tracker_server，就多增加一行tracker_server配置）</pre><p><br/></p><p>#保存后启动</p><p>/etc/init.d/fdfs_storaged start #启动storage服务</p><p>chkconfig fdfs_storaged on #自启动storage服务</p><p><br/></p><p><strong>client测试</strong></p><p>vim /etc/fdfs/client.conf</p><p>#需要修改的内容如下</p><pre class="brush:plain;toolbar:false">base_path=/fastdfs/tracker
tracker_server=192.168.1.xxx:22122&nbsp;&nbsp;&nbsp;&nbsp;#tracker&nbsp;IP地址</pre><p><br/></p><p>#保存后测试,返回ID表示成功 eg:group1/M00/00/00/wKgAQ1pysxmAaqhAAA76tz-dVgg.tar.gz</p><p>fdfs_upload_file /etc/fdfs/client.conf /usr/local/src/nginx-1.12.2.tar.gz</p><p><br/></p><p><span style="font-size: 18px;">【步骤四、HTTP访问支持】</span></p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">FastDFS的tracker和storage都需要http协议的支持，使客户端可以通过http协议来下载文件。</p><p style="white-space: normal;">tracker在接收到请求时，通过http的redirect机制将请求重定向至文件所在的storage上；</p><p style="white-space: normal;">较新版本的FastDFS已经放弃了内置的http协议模块，需要通过nginx扩展模块，来提供对下载文件的支持。</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;"><span style="font-weight: 700;">Nginx作用说明</span></p><p style="white-space: normal;">1、早期的FastDFS版本，自带了HTTP服务能力，后面作者把自带的HTTP服务去掉了，直接依赖Nginx来提供HTTP服务。</p><p style="white-space: normal;">2、HTTP服务是可选的，不是必须的，FastDFS提供的上传和下载服务，都是用的TCP协议，而非HTTP协议。HTTP服务（Nginx）是用来提供静态文件浏览的，如果不需要静态文件服务，就不需要安装Nginx。</p><p style="white-space: normal;"><br/></p><p><strong>fastdfs-nginx-module作用说明</strong></p><p>FastDFS 通过 Tracker 服务器，将文件放在 Storage 服务器存储，但是同组存储服务器之间需要进入文件复制流程，有同步延迟的问题。</p><p>假设 Tracker 服务器将文件上传到了 192.168.1.202，上传成功后文件 ID已经返回给客户端。</p><p>此时 FastDFS 存储集群机制会将这个文件同步到同组存储 192.168.1.203，在文件还没有复制完成的情况下，客户端如果用这个文件 ID 在 192.168.1.203上取文件，就会出现文件无法访问的错误。</p><p>而 fastdfs-nginx-module 可以重定向文件连接到源服务器（192.168.1.202）上取文件，避免客户端由于复制延迟导致的文件无法访问错误。</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">也就是说，fastdfs-nginx-module 会识别 当前文件能够访问的位置，并重定向到该服务器上去。</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">总结：fastdfs-nginx-module是FastDFS提供的Nginx插件，其作用是在提供静态文件服务时 ，如果当前storage节点上没有该文件（通常是没来得及同步，或者该storage因为挂了、网络等原因未同步成功），这种情况下，会自动去其他节点上寻找，以便访问任何一个nginx，都可以保证拿到文件。</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;"><span style="font-weight: 700;">Nginx的安装，并添加fastdfs-nginx-module模块</span></p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">此处给出示例：（Nginx的安装是一个单独的安装过程，建议参考 专业的Nginx安装手册）</p><p style="white-space: normal;"><br/></p><p style="white-space: normal;">需要先安装所需lib，命令如下：</p><pre class="brush:bash;toolbar:false" style="line-height: 1.42857;">yum&nbsp;install&nbsp;git&nbsp;gcc&nbsp;gcc-c++&nbsp;make&nbsp;automake&nbsp;autoconf&nbsp;libtool&nbsp;pcre&nbsp;pcre-devel&nbsp;zlib&nbsp;zlib-devel&nbsp;openssl-devel&nbsp;-y</pre><p style="white-space: normal;">获取安装包：</p><pre class="brush:bash;toolbar:false" style="line-height: 1.42857;">wget&nbsp;http://nginx.org/download/nginx-1.12.2.tar.gz
tar&nbsp;-zxvf&nbsp;nginx-1.12.2.tar.gz</pre><p style="white-space: normal;"># 然后添加fastdfs-nginx-module模块</p><pre class="brush:bash;toolbar:false" style="line-height: 1.42857;">cd&nbsp;nginx-1.12.2/（Nginx的源码目录）
./configure&nbsp;--add-module=/usr/local/src/fastdfs-nginx-module/src/
make&nbsp;&amp;&amp;&nbsp;make&nbsp;install</pre><p style="white-space: normal;"><br/></p><p style="white-space: normal;"><strong>（在Storage服务器上）安装配置Nginx 和 fastdfs-nginx-module</strong><br/></p><p>vim /etc/fdfs/mod_fastdfs.conf</p><p>#需要修改的内容如下</p><pre class="brush:plain;toolbar:false">tracker_server=192.168.0.xxx:22122
url_have_group_name=true
store_path0=/fastdfs/storage
（如果有多个tracker_server，就多增加一行tracker_server配置）</pre><p><br/></p><p>#配置nginx.config</p><p>cd&nbsp;/usr/local/nginx（Nginx安装目录）</p><p>vi conf/nginx.conf</p><p>#添加如下配置</p><pre class="brush:plain;toolbar:false">server&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8888;&nbsp;&nbsp;&nbsp;&nbsp;##&nbsp;该端口为storage.conf中的http.server_port相同
&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;&nbsp;localhost;
&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~/group[0-9]/M00&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ngx_fastdfs_module;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;error_page&nbsp;&nbsp;&nbsp;500&nbsp;502&nbsp;503&nbsp;504&nbsp;&nbsp;/50x.html;
&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;=&nbsp;/50x.html&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;&nbsp;&nbsp;html;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p>注意：</p><p>1、8888 端口值要与/etc/fdfs/storage.conf 中的 http.server_port=8888 相对应，因为 http.server_port 默认为 8888，如果想改成 80，则要对应修改过来。</p><p>2、如下载时如发现老报 404，将nginx.conf第一行user nobody;修改为user root;后重新启动。</p><p><br/></p><p>创建数据存放目录的软链接</p><p>ln -s /fastdfs/storage/data/ /fastdfs/storage/data/M00</p><p><br/></p><p>#测试下载，用外部浏览器访问刚才已传过的nginx安装包,引用返回的ID</p><p>http://192.168.0.xxx:8888/group1/M00/00/00/wKgAQ1pysxmAaqhAAA76tz-dVgg.tar.gz</p><p>#如果不能下载，可以检查防火墙，再检查其他配置。</p><p><br/></p><p><span style="font-weight: 700;">（在Tracer服务器上）安装配置Nginx</span></p><p>在 tracker 上安装的 nginx 主要为了提供 http 访问的反向代理、负载均衡以及缓存服务。<br/></p><p>示例如下：<br/></p><pre class="brush:plain;toolbar:false">#设置&nbsp;group1&nbsp;的服务器
upstream&nbsp;storage_server_group1&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;192.100.139.121:8888&nbsp;weight=10;
&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;192.100.139.123:8888&nbsp;weight=10;
&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;192.100.139.124:8888&nbsp;weight=10;
}

server&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;8888;
&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;192.100.139.121;
&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~/group1/M00&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_pass&nbsp;http://storage_server_group1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;error_page&nbsp;500&nbsp;502&nbsp;503&nbsp;504&nbsp;/50x.html;
&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;=&nbsp;/50x.html&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;html;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p><br/></p><p><span style="font-size: 20px;">其他一些运维操作：</span></p><p><span style="font-size: 20px;"></span></p><p><br/></p><p>1、关闭FastDFS</p><p>tracker: /usr/bin/stop.sh fdfs_tracker</p><p>storage: /usr/bin/stop.sh fdfs_storage</p><p>&nbsp;</p><p>或者</p><p>killall fdfs_trackered</p><p>killall fdfs_storaged</p><p><br/></p><p>注意，千万不要使用kill-9强行杀死进程。</p><p><br/></p><p>2、重启FastDFS</p><p>tracker: /usr/bin/restart.sh fdfs_trackered</p><p>storage: /usr/bin/restart.sh fdfs_storaged</p><p><br/></p><p>3、查看集群情况</p><p>在任意一台storage</p><p>/usr/bin/fdfs_monitor /etc/fdfs/storage.conf</p><p><br/></p><p><br/></p><p><strong><span style="font-size: 20px;">附： FastDFS的一些缺点（可能需要注意）</span></strong></p><p>参见：<a href="./some-shortcomings-of-FastDFS.html" target="_blank">这篇文章</a>。</p><p><br/></p><p><strong><span style="font-size: 20px;">四、生产部署（建议）</span></strong></p><p><br/></p><p>Tracer 一主一从部署，避免单点故障。</p><p>group主要做应用隔离和负载均衡，从目前的现状来看，暂时用不着，只用一个group即可。</p><p>（如果要区分上传的文件，例如group1存放证件照、人脸识别照片、合同、公司内部资料等敏感文件，group2存放对外网公开的APP活动图片、网页静态图片、文章图片等非敏感文件）。group1，因为是比较重要的文件，storage节点建议用3个，group2相对来说没这么重要，2个storage节点即可。</p><p>暂时，只部署group1。<br/></p><p><br/></p><p>HTTP访问的负载：</p><p>所有HTTP请求走一个VIP，后面两个nginx一主一从，然后转发（upstream）到 Storage节点的nginx上（storage的Nginx上要装fastdfs-nginx-module插件）。</p><p><br/></p><p><span style="font-size: 20px;">五、测试环境部署（建议）</span></p><p>一个Tracer，一个Storage节点即可，HTTP直接访问这个Storage节点的Nginx（无需装fastdfs-nginx-module）。</p><p><br/></p>